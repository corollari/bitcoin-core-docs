<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>all</title>
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style>
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="pandoc.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <link rel='shortcut icon' href='favicon.png' />
</head>
<body>
<h1 id="json-rpc-interface">JSON-RPC Interface</h1>
<p>The headless daemon <code>bitcoind</code> has the JSON-RPC API enabled by default, the GUI <code>bitcoin-qt</code> has it disabled by default. This can be changed with the <code>-server</code> option. In the GUI it is possible to execute RPC methods in the Debug Console Dialog.</p>
<h2 id="versioning">Versioning</h2>
<p>The RPC interface might change from one major version of Bitcoin Core to the next. This makes the RPC interface implicitly versioned on the major version. The version tuple can be retrieved by e.g. the <code>getnetworkinfo</code> RPC in <code>version</code>.</p>
<p>Usually deprecated features can be re-enabled during the grace-period of one major version via the <code>-deprecatedrpc=</code> command line option. The release notes of a new major release come with detailed instructions on what RPC features were deprecated and how to re-enable them temporarily.</p>
<h2 id="security">Security</h2>
<p>The RPC interface allows other programs to control Bitcoin Core, including the ability to spend funds from your wallets, affect consensus verification, read private data, and otherwise perform operations that can cause loss of money, data, or privacy. This section suggests how you should use and configure Bitcoin Core to reduce the risk that its RPC interface will be abused.</p>
<ul>
<li><p><strong>Securing the executable:</strong> Anyone with physical or remote access to the computer, container, or virtual machine running Bitcoin Core can compromise either the whole program or just the RPC interface. This includes being able to record any passphrases you enter for unlocking your encrypted wallets or changing settings so that your Bitcoin Core program tells you that certain transactions have multiple confirmations even when they aren't part of the best block chain. For this reason, you should not use Bitcoin Core for security sensitive operations on systems you do not exclusively control, such as shared computers or virtual private servers.</p></li>
<li><p><strong>Securing local network access:</strong> By default, the RPC interface can only be accessed by a client running on the same computer and only after the client provides a valid authentication credential (username and passphrase). Any program on your computer with access to the file system and local network can obtain this level of access. Additionally, other programs on your computer can attempt to provide an RPC interface on the same port as used by Bitcoin Core in order to trick you into revealing your authentication credentials. For this reason, it is important to only use Bitcoin Core for security-sensitive operations on a computer whose other programs you trust.</p></li>
<li><p><strong>Securing remote network access:</strong> You may optionally allow other computers to remotely control Bitcoin Core by setting the <code>rpcallowip</code> and <code>rpcbind</code> configuration parameters. These settings are only meant for enabling connections over secure private networks or connections that have been otherwise secured (e.g. using a VPN or port forwarding with SSH or stunnel). <strong>Do not enable RPC connections over the public Internet.</strong> Although Bitcoin Core's RPC interface does use authentication, it does not use encryption, so your login credentials are sent as clear text that can be read by anyone on your network path. Additionally, the RPC interface has not been hardened to withstand arbitrary Internet traffic, so changing the above settings to expose it to the Internet (even using something like a Tor onion service) could expose you to unconsidered vulnerabilities. See <code>bitcoind -help</code> for more information about these settings and other settings described in this document.</p>
<p>Related, if you use Bitcoin Core inside a Docker container, you may need to expose the RPC port to the host system. The default way to do this in Docker also exposes the port to the public Internet. Instead, expose it only on the host system's localhost, for example: <code>-p 127.0.0.1:8332:8332</code></p></li>
<li><p><strong>Secure authentication:</strong> By default, Bitcoin Core generates unique login credentials each time it restarts and puts them into a file readable only by the user that started Bitcoin Core, allowing any of that user's RPC clients with read access to the file to login automatically. The file is <code>.cookie</code> in the Bitcoin Core configuration directory, and using these credentials is the preferred RPC authentication method. If you need to generate static login credentials for your programs, you can use the script in the <code>share/rpcauth</code> directory in the Bitcoin Core source tree. As a final fallback, you can directly use manually-chosen <code>rpcuser</code> and <code>rpcpassword</code> configuration parameters---but you must ensure that you choose a strong and unique passphrase (and still don't use insecure networks, as mentioned above).</p></li>
<li><p><strong>Secure string handling:</strong> The RPC interface does not guarantee any escaping of data beyond what's necessary to encode it as JSON, although it does usually provide serialized data using a hex representation of the bytes. If you use RPC data in your programs or provide its data to other programs, you must ensure any problem strings are properly escaped. For example, multiple websites have been manipulated because they displayed decoded hex strings that included HTML <code>&lt;script&gt;</code> tags. For this reason, and other non-security reasons, it is recommended to display all serialized data in hex form only.</p></li>
</ul>
<h2 id="rpc-consistency-guarantees">RPC consistency guarantees</h2>
<p>State that can be queried via RPCs is guaranteed to be at least up-to-date with the chain state immediately prior to the call's execution. However, the state returned by RPCs that reflect the mempool may not be up-to-date with the current mempool state.</p>
<h3 id="transaction-pool">Transaction Pool</h3>
<p>The mempool state returned via an RPC is consistent with itself and with the chain state at the time of the call. Thus, the mempool state only encompasses transactions that are considered mine-able by the node at the time of the RPC.</p>
<p>The mempool state returned via an RPC reflects all effects of mempool and chain state related RPCs that returned prior to this call.</p>
<h3 id="wallet">Wallet</h3>
<p>The wallet state returned via an RPC is consistent with itself and with the chain state at the time of the call.</p>
<p>Wallet RPCs will return the latest chain state consistent with prior non-wallet RPCs. The effects of all blocks (and transactions in blocks) at the time of the call is reflected in the state of all wallet transactions. For example, if a block contains transactions that conflicted with mempool transactions, the wallet would reflect the removal of these mempool transactions in the state.</p>
<h1 id="however-the-wallet-may-not-be-up-to-date-with-the-current-state-of-the-mempool-or-the-state-of-the-mempool-by-an-rpc-that-returned-before-this-rpc-for-example-a-wallet-transaction-that-was-bip-125-replaced-in-the-mempool-prior-to-this-rpc-may-not-yet-be-reflected-as-such-in-this-rpc-response-bitcoin-core">However, the wallet may not be up-to-date with the current state of the mempool or the state of the mempool by an RPC that returned before this RPC. For example, a wallet transaction that was BIP-125-replaced in the mempool prior to this RPC may not yet be reflected as such in this RPC response. Bitcoin Core</h1>
<h2 id="setup">Setup</h2>
<p>Bitcoin Core is the original Bitcoin client and it builds the backbone of the network. It downloads and, by default, stores the entire history of Bitcoin transactions, which requires a few hundred gigabytes of disk space. Depending on the speed of your computer and network connection, the synchronization process can take anywhere from a few hours to a day or more.</p>
<p>To download Bitcoin Core, visit <a href="https://bitcoincore.org/en/download/">bitcoincore.org</a>.</p>
<h2 id="running">Running</h2>
<p>The following are some helpful notes on how to run Bitcoin Core on your native platform.</p>
<h3 id="unix">Unix</h3>
<p>Unpack the files into a directory and run:</p>
<ul>
<li><code>bin/bitcoin-qt</code> (GUI) or</li>
<li><code>bin/bitcoind</code> (headless)</li>
</ul>
<h3 id="windows">Windows</h3>
<p>Unpack the files into a directory, and then run bitcoin-qt.exe.</p>
<h3 id="macos">macOS</h3>
<p>Drag Bitcoin Core to your applications folder, and then run Bitcoin Core.</p>
<h3 id="need-help">Need Help?</h3>
<ul>
<li>See the documentation at the <a href="https://en.bitcoin.it/wiki/Main_Page">Bitcoin Wiki</a> for help and more information.</li>
<li>Ask for help on <a href="https://webchat.freenode.net/#bitcoin">#bitcoin</a> on Freenode. If you don't have an IRC client, use <a href="https://webchat.freenode.net/#bitcoin">webchat here</a>.</li>
<li>Ask for help on the <a href="https://bitcointalk.org/">BitcoinTalk</a> forums, in the <a href="https://bitcointalk.org/index.php?board=4.0">Technical Support board</a>.</li>
</ul>
<h2 id="building">Building</h2>
<p>The following are developer notes on how to build Bitcoin Core on your native platform. They are not complete guides, but include notes on the necessary libraries, compile flags, etc.</p>
<ul>
<li><a href="dependencies.html">Dependencies</a></li>
<li><a href="build-osx.html">macOS Build Notes</a></li>
<li><a href="build-unix.html">Unix Build Notes</a></li>
<li><a href="build-windows.html">Windows Build Notes</a></li>
<li><a href="build-freebsd.html">FreeBSD Build Notes</a></li>
<li><a href="build-openbsd.html">OpenBSD Build Notes</a></li>
<li><a href="build-netbsd.html">NetBSD Build Notes</a></li>
<li><a href="https://github.com/bitcoin-core/docs/blob/master/gitian-building.html">Gitian Building Guide (External Link)</a></li>
</ul>
<h2 id="development">Development</h2>
<p>The Bitcoin repo's <a href="/README.html">root README</a> contains relevant information on the development process and automated testing.</p>
<ul>
<li><a href="developer-notes.html">Developer Notes</a></li>
<li><a href="productivity.html">Productivity Notes</a></li>
<li><a href="release-notes.html">Release Notes</a></li>
<li><a href="release-process.html">Release Process</a></li>
<li><a href="https://doxygen.bitcoincore.org/">Source Code Documentation (External Link)</a></li>
<li><a href="translation_process.html">Translation Process</a></li>
<li><a href="translation_strings_policy.html">Translation Strings Policy</a></li>
<li><a href="JSON-RPC-interface.html">JSON-RPC Interface</a></li>
<li><a href="REST-interface.html">Unauthenticated REST Interface</a></li>
<li><a href="shared-libraries.html">Shared Libraries</a></li>
<li><a href="bips.html">BIPS</a></li>
<li><a href="dnsseed-policy.html">Dnsseed Policy</a></li>
<li><a href="benchmarking.html">Benchmarking</a></li>
</ul>
<h3 id="resources">Resources</h3>
<ul>
<li>Discuss on the <a href="https://bitcointalk.org/">BitcoinTalk</a> forums, in the <a href="https://bitcointalk.org/index.php?board=6.0">Development &amp; Technical Discussion board</a>.</li>
<li>Discuss project-specific development on #bitcoin-core-dev on Freenode. If you don't have an IRC client, use <a href="https://webchat.freenode.net/#bitcoin-core-dev">webchat here</a>.</li>
<li>Discuss general Bitcoin development on #bitcoin-dev on Freenode. If you don't have an IRC client, use <a href="https://webchat.freenode.net/#bitcoin-dev">webchat here</a>.</li>
</ul>
<h3 id="miscellaneous">Miscellaneous</h3>
<ul>
<li><a href="assets-attribution.html">Assets Attribution</a></li>
<li><a href="bitcoin-conf.html">bitcoin.conf Configuration File</a></li>
<li><a href="files.html">Files</a></li>
<li><a href="fuzzing.html">Fuzz-testing</a></li>
<li><a href="reduce-memory.html">Reduce Memory</a></li>
<li><a href="reduce-traffic.html">Reduce Traffic</a></li>
<li><a href="tor.html">Tor Support</a></li>
<li><a href="init.html">Init Scripts (syst.html/upstart/openrc)</a></li>
<li><a href="zmq.html">ZMQ</a></li>
<li><a href="psbt.html">PSBT support</a></li>
</ul>
<h2 id="license">License</h2>
<p>Distributed under the <a href="/COPYING">MIT software license</a>. \mainpage notitle</p>
<p>\section intro_sec Introduction</p>
<p>This is the developer documentation of the reference client for an experimental new digital currency called Bitcoin, which enables instant payments to anyone, anywhere in the world. Bitcoin uses peer-to-peer technology to operate with no central authority: managing transactions and issuing money are carried out collectively by the network.</p>
<p>The software is a community-driven open source project, released under the MIT license.</p>
<p>See <a href="https://github.com/bitcoin/bitcoin">https://github.com/bitcoin/bitcoin</a> and <a href="https://bitcoincore.org/">https://bitcoincore.org/</a> for further information about the project.</p>
<p>\section Navigation Use <a href="modules.html"><code>Modules</code></a>, <a href="namespaces.html"><code>Namespaces</code></a>, <a href="classes.html"><code>Classes</code></a>, or <a href="files.html"><code>Files</code></a> at the top of the page to start navigating the code.</p>
<h1 id="unauthenticated-rest-interface">Unauthenticated REST Interface</h1>
<p>The REST API can be enabled with the <code>-rest</code> option.</p>
<p>The interface runs on the same port as the JSON-RPC interface, by default port 8332 for mainnet, port 18332 for testnet, and port 18443 for regtest.</p>
<h2 id="rest-interface-consistency-guarantees">REST Interface consistency guarantees</h2>
<p>The <a href="/doc/JSON-RPC-interface.html#rpc-consistency-guarantees">same guarantees as for the RPC Interface</a> apply.</p>
<h2 id="supported-api">Supported API</h2>
<h4 id="transactions">Transactions</h4>
<p><code>GET /rest/tx/&lt;TX-HASH&gt;.&lt;bin|hex|json&gt;</code></p>
<p>Given a transaction hash: returns a transaction in binary, hex-encoded binary, or JSON formats.</p>
<p>By default, this endpoint will only search the mempool. To query for a confirmed transaction, enable the transaction index via "txindex=1" command line / configuration option.</p>
<h4 id="blocks">Blocks</h4>
<p><code>GET /rest/block/&lt;BLOCK-HASH&gt;.&lt;bin|hex|json&gt;</code> <code>GET /rest/block/notxdetails/&lt;BLOCK-HASH&gt;.&lt;bin|hex|json&gt;</code></p>
<p>Given a block hash: returns a block, in binary, hex-encoded binary or JSON formats. Responds with 404 if the block doesn't exist.</p>
<p>The HTTP request and response are both handled entirely in-memory.</p>
<p>With the /notxdetails/ option JSON response will only contain the transaction hash instead of the complete transaction details. The option only affects the JSON response.</p>
<h4 id="blockheaders">Blockheaders</h4>
<p><code>GET /rest/headers/&lt;COUNT&gt;/&lt;BLOCK-HASH&gt;.&lt;bin|hex|json&gt;</code></p>
<p>Given a block hash: returns <COUNT> amount of blockheaders in upward direction. Returns empty if the block doesn't exist or it isn't in the active chain.</p>
<h4 id="blockhash-by-height">Blockhash by height</h4>
<p><code>GET /rest/blockhashbyheight/&lt;HEIGHT&gt;.&lt;bin|hex|json&gt;</code></p>
<p>Given a height: returns hash of block in best-block-chain at height provided.</p>
<h4 id="chaininfos">Chaininfos</h4>
<p><code>GET /rest/chaininfo.json</code></p>
<p>Returns various state info regarding block chain processing. Only supports JSON as output format.</p>
<ul>
<li>chain : (string) current network name (main, test, regtest)</li>
<li>blocks : (numeric) the current number of blocks processed in the server</li>
<li>headers : (numeric) the current number of headers we have validated</li>
<li>bestblockhash : (string) the hash of the currently best block</li>
<li>difficulty : (numeric) the current difficulty</li>
<li>mediantime : (numeric) the median time of the 11 blocks before the most recent block on the blockchain</li>
<li>verificationprogress : (numeric) estimate of verification progress [0..1]</li>
<li>chainwork : (string) total amount of work in active chain, in hexadecimal</li>
<li>pruned : (boolean) if the blocks are subject to pruning</li>
<li>pruneheight : (numeric) highest block available</li>
<li>softforks : (array) status of softforks in progress</li>
</ul>
<h4 id="query-utxo-set">Query UTXO set</h4>
<p><code>GET /rest/getutxos/&lt;checkmempool&gt;/&lt;txid&gt;-&lt;n&gt;/&lt;txid&gt;-&lt;n&gt;/.../&lt;txid&gt;-&lt;n&gt;.&lt;bin|hex|json&gt;</code></p>
<p>The getutxo command allows querying of the UTXO set given a set of outpoints. See BIP64 for input and output serialisation: <a href="https://github.com/bitcoin/bips/blob/master/bip-0064.mediawiki">https://github.com/bitcoin/bips/blob/master/bip-0064.mediawiki</a></p>
<p>Example:</p>
<pre><code>$ curl localhost:18332/rest/getutxos/checkmempool/b2cdfd7b89def827ff8af7cd9bff7627ff72e5e8b0f71210f92ea7a4000c5d75-0.json 2&gt;/dev/null | json_pp
{
   &quot;chainHeight&quot; : 325347,
   &quot;chaintipHash&quot; : &quot;00000000fb01a7f3745a717f8caebee056c484e6e0bfe4a9591c235bb70506fb&quot;,
   &quot;bitmap&quot;: &quot;1&quot;,
   &quot;utxos&quot; : [
      {
         &quot;height&quot; : 2147483647,
         &quot;value&quot; : 8.8687,
         &quot;scriptPubKey&quot; : {
            &quot;asm&quot; : &quot;OP_DUP OP_HASH160 1c7cebb529b86a04c683dfa87be49de35bcf589e OP_EQUALVERIFY OP_CHECKSIG&quot;,
            &quot;hex&quot; : &quot;76a9141c7cebb529b86a04c683dfa87be49de35bcf589e88ac&quot;,
            &quot;reqSigs&quot; : 1,
            &quot;type&quot; : &quot;pubkeyhash&quot;,
            &quot;addresses&quot; : [
               &quot;mi7as51dvLJsizWnTMurtRmrP8hG2m1XvD&quot;
            ]
         }
      }
   ]
}
</code></pre>
<h4 id="memory-pool">Memory pool</h4>
<p><code>GET /rest/mempool/info.json</code></p>
<p>Returns various information about the TX mempool. Only supports JSON as output format.</p>
<ul>
<li>loaded : (boolean) if the mempool is fully loaded</li>
<li>size : (numeric) the number of transactions in the TX mempool</li>
<li>bytes : (numeric) size of the TX mempool in bytes</li>
<li>usage : (numeric) total TX mempool memory usage</li>
<li>maxmempool : (numeric) maximum memory usage for the mempool in bytes</li>
<li>mempoolminfee : (numeric) minimum feerate (BTC per KB) for tx to be accepted</li>
</ul>
<p><code>GET /rest/mempool/contents.json</code></p>
<p>Returns transactions in the TX mempool. Only supports JSON as output format.</p>
<h2 id="risks">Risks</h2>
<h1 id="running-a-web-browser-on-the-same-node-with-a-rest-enabled-bitcoind-can-be-a-risk-accessing-prepared-xss-websites-could-read-out-txblock-data-of-your-node-by-placing-links-like-script-srchttp1270018332resttx1234567890json-which-might-break-the-nodes-privacy-the-list-of-assets-used-in-the-bitcoin-source-and-their-attribution-can-now-be-found-in-contribdebiancopyright-benchmarking">Running a web browser on the same node with a REST enabled bitcoind can be a risk. Accessing prepared XSS websites could read out tx/block data of your node by placing links like <code>&lt;script src="http://127.0.0.1:8332/rest/tx/1234567890.json"&gt;</code> which might break the nodes privacy. The list of assets used in the bitcoin source and their attribution can now be found in <a href="../contrib/debian/copyright">contrib/debian/copyright</a>. Benchmarking</h1>
<p>Bitcoin Core has an internal benchmarking framework, with benchmarks for cryptographic algorithms (e.g. SHA1, SHA256, SHA512, RIPEMD160, Poly1305, ChaCha20), rolling bloom filter, coins selection, thread queue, wallet balance.</p>
<h2 id="running-1">Running</h2>
<p>For benchmarks purposes you only need to compile <code>bitcoin_bench</code>. Beware of configuring without <code>--enable-debug</code> as this would impact benchmarking by unlatching log printers and lock analysis.</p>
<pre><code>make -C src bitcoin_bench
</code></pre>
<p>After compiling bitcoin-core, the benchmarks can be run with:</p>
<pre><code>src/bench/bench_bitcoin
</code></pre>
<p>The output will look similar to:</p>
<pre><code>|             ns/byte |              byte/s | error % | benchmark
|--------------------:|--------------------:|--------:|:----------------------------------------------
|               64.13 |       15,592,356.01 |    0.1% | `Base58CheckEncode`
|               24.56 |       40,722,672.68 |    0.2% | `Base58Decode`
...
</code></pre>
<h2 id="help">Help</h2>
<pre><code>src/bench/bench_bitcoin --help
</code></pre>
<p>To print options like scaling factor or per-benchmark filter.</p>
<h2 id="notes">Notes</h2>
<p>More benchmarks are needed for, in no particular order:</p>
<ul>
<li>Script Validation</li>
<li>Coins database</li>
<li>Memory pool</li>
<li>Cuckoo Cache</li>
<li>P2P throughput</li>
</ul>
<h2 id="going-further">Going Further</h2>
<p>To monitor Bitcoin Core performance more in depth (like reindex or IBD): <a href="https://github.com/chaincodelabs/bitcoinperf">https://github.com/chaincodelabs/bitcoinperf</a></p>
<p>To generate Flame Graphs for Bitcoin Core: <a href="https://github.com/eklitzke/bitcoin/blob/flamegraphs/doc/flamegraphs.html">https://github.com/eklitzke/bitcoin/blob/flamegraphs/doc/flamegraphs.html</a> BIPs that are implemented by Bitcoin Core (up-to-date up to <strong>v0.21.0</strong>):</p>
<ul>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0009.mediawiki"><code>BIP 9</code></a>: The changes allowing multiple soft-forks to be deployed in parallel have been implemented since <strong>v0.12.1</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/7575">PR #7575</a>)</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0011.mediawiki"><code>BIP 11</code></a>: Multisig outputs are standard since <strong>v0.6.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/669">PR #669</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0013.mediawiki"><code>BIP 13</code></a>: The address format for P2SH addresses has been implemented since <strong>v0.6.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/669">PR #669</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0014.mediawiki"><code>BIP 14</code></a>: The subversion string is being used as User Agent since <strong>v0.6.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/669">PR #669</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0016.mediawiki"><code>BIP 16</code></a>: The pay-to-script-hash evaluation rules have been implemented since <strong>v0.6.0</strong>, and took effect on <em>April 1st 2012</em> (<a href="https://github.com/bitcoin/bitcoin/pull/748">PR #748</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0021.mediawiki"><code>BIP 21</code></a>: The URI format for Bitcoin payments has been implemented since <strong>v0.6.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/176">PR #176</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0022.mediawiki"><code>BIP 22</code></a>: The 'getblocktemplate' (GBT) RPC protocol for mining has been implemented since <strong>v0.7.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/936">PR #936</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0023.mediawiki"><code>BIP 23</code></a>: Some extensions to GBT have been implemented since <strong>v0.10.0rc1</strong>, including longpolling and block proposals (<a href="https://github.com/bitcoin/bitcoin/pull/1816">PR #1816</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0030.mediawiki"><code>BIP 30</code></a>: The evaluation rules to forbid creating new transactions with the same txid as previous not-fully-spent transactions were implemented since <strong>v0.6.0</strong>, and the rule took effect on <em>March 15th 2012</em> (<a href="https://github.com/bitcoin/bitcoin/pull/915">PR #915</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0031.mediawiki"><code>BIP 31</code></a>: The 'pong' protocol message (and the protocol version bump to 60001) has been implemented since <strong>v0.6.1</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/1081">PR #1081</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki"><code>BIP 32</code></a>: Hierarchical Deterministic Wallets has been implemented since <strong>v0.13.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/8035">PR #8035</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0034.mediawiki"><code>BIP 34</code></a>: The rule that requires blocks to contain their height (number) in the coinbase input, and the introduction of version 2 blocks has been implemented since <strong>v0.7.0</strong>. The rule took effect for version 2 blocks as of <em>block 224413</em> (March 5th 2013), and version 1 blocks are no longer allowed since <em>block 227931</em> (March 25th 2013) (<a href="https://github.com/bitcoin/bitcoin/pull/1526">PR #1526</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0035.mediawiki"><code>BIP 35</code></a>: The 'mempool' protocol message (and the protocol version bump to 60002) has been implemented since <strong>v0.7.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/1641">PR #1641</a>). As of <strong>v0.13.0</strong>, this is only available for <code>NODE_BLOOM</code> (BIP 111) peers.</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0037.mediawiki"><code>BIP 37</code></a>: The bloom filtering for transaction relaying, partial Merkle trees for blocks, and the protocol version bump to 70001 (enabling low-bandwidth SPV clients) has been implemented since <strong>v0.8.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/1795">PR #1795</a>). Disabled by default since <strong>v0.19.0</strong>, can be enabled by the <code>-peerbloomfilters</code> option.</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0042.mediawiki"><code>BIP 42</code></a>: The bug that would have caused the subsidy schedule to resume after block 13440000 was fixed in <strong>v0.9.2</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/3842">PR #3842</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0061.mediawiki"><code>BIP 61</code></a>: The 'reject' protocol message (and the protocol version bump to 70002) was added in <strong>v0.9.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/3185">PR #3185</a>). Starting <strong>v0.17.0</strong>, whether to send reject messages can be configured with the <code>-enablebip61</code> option, and support is deprecated (disabled by default) as of <strong>v0.18.0</strong>. Support was removed in <strong>v0.20.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/15437">PR #15437</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0065.mediawiki"><code>BIP 65</code></a>: The CHECKLOCKTIMEVERIFY softfork was merged in <strong>v0.12.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/6351">PR #6351</a>), and backported to <strong>v0.11.2</strong> and <strong>v0.10.4</strong>. Mempool-only CLTV was added in <a href="https://github.com/bitcoin/bitcoin/pull/6124">PR #6124</a>.</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0066.mediawiki"><code>BIP 66</code></a>: The strict DER rules and associated version 3 blocks have been implemented since <strong>v0.10.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/5713">PR #5713</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki"><code>BIP 68</code></a>: Sequence locks have been implemented as of <strong>v0.12.1</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/7184">PR #7184</a>), and have been <em>buried</em> since <strong>v0.19.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/16060">PR #16060</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0070.mediawiki"><code>BIP 70</code></a> <a href="https://github.com/bitcoin/bips/blob/master/bip-0071.mediawiki"><code>71</code></a> <a href="https://github.com/bitcoin/bips/blob/master/bip-0072.mediawiki"><code>72</code></a>: Payment Protocol support has been available in Bitcoin Core GUI since <strong>v0.9.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/5216">PR #5216</a>). Support can be optionally disabled at build time since <strong>v0.18.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/14451">PR 14451</a>), and it is disabled by default at build time since <strong>v0.19.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/15584">PR #15584</a>). It has been removed as of <strong>v0.20.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/17165">PR 17165</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0090.mediawiki"><code>BIP 90</code></a>: Trigger mechanism for activation of BIPs 34, 65, and 66 has been simplified to block height checks since <strong>v0.14.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/8391">PR #8391</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0111.mediawiki"><code>BIP 111</code></a>: <code>NODE_BLOOM</code> service bit added, and enforced for all peer versions as of <strong>v0.13.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/6579">PR #6579</a> and <a href="https://github.com/bitcoin/bitcoin/pull/6641">PR #6641</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki"><code>BIP 112</code></a>: The CHECKSEQUENCEVERIFY opcode has been implemented since <strong>v0.12.1</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/7524">PR #7524</a>), and has been <em>buried</em> since <strong>v0.19.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/16060">PR #16060</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0113.mediawiki"><code>BIP 113</code></a>: Median time past lock-time calculations have been implemented since <strong>v0.12.1</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/6566">PR #6566</a>), and has been <em>buried</em> since <strong>v0.19.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/16060">PR #16060</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0125.mediawiki"><code>BIP 125</code></a>: Opt-in full replace-by-fee signaling honoured in mempool and mining as of <strong>v0.12.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/6871">PR 6871</a>). Enabled by default in the wallet GUI as of <strong>v0.18.1</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/11605">PR #11605</a>)</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0130.mediawiki"><code>BIP 130</code></a>: direct headers announcement is negotiated with peer versions <code>&gt;=70012</code> as of <strong>v0.12.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/6494">PR 6494</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0133.mediawiki"><code>BIP 133</code></a>: feefilter messages are respected and sent for peer versions <code>&gt;=70013</code> as of <strong>v0.13.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/7542">PR 7542</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki"><code>BIP 141</code></a>: Segregated Witness (Consensus Layer) as of <strong>v0.13.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/8149">PR 8149</a>), defined for mainnet as of <strong>v0.13.1</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/8937">PR 8937</a>), and <em>buried</em> since <strong>v0.19.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/16060">PR #16060</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0143.mediawiki"><code>BIP 143</code></a>: Transaction Signature Verification for Version 0 Witness Program as of <strong>v0.13.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/8149">PR 8149</a>), defined for mainnet as of <strong>v0.13.1</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/8937">PR 8937</a>), and <em>buried</em> since <strong>v0.19.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/16060">PR #16060</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0144.mediawiki"><code>BIP 144</code></a>: Segregated Witness as of <strong>0.13.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/8149">PR 8149</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0145.mediawiki"><code>BIP 145</code></a>: getblocktemplate updates for Segregated Witness as of <strong>v0.13.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/8149">PR 8149</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0147.mediawiki"><code>BIP 147</code></a>: NULLDUMMY softfork as of <strong>v0.13.1</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/8636">PR 8636</a> and <a href="https://github.com/bitcoin/bitcoin/pull/8937">PR 8937</a>), <em>buried</em> since <strong>v0.19.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/16060">PR #16060</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0152.mediawiki"><code>BIP 152</code></a>: Compact block transfer and related optimizations are used as of <strong>v0.13.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/8068">PR 8068</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0155.mediawiki"><code>BIP 155</code></a>: The 'addrv2' and 'sendaddrv2' messages which enable relay of Tor V3 addresses (and other networks) are supported as of <strong>v0.21.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/19954">PR 19954</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0158.mediawiki"><code>BIP 158</code></a>: Compact Block Filters for Light Clients can be indexed as of <strong>v0.19.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/14121">PR #14121</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0159.mediawiki"><code>BIP 159</code></a>: The <code>NODE_NETWORK_LIMITED</code> service bit is signalled as of <strong>v0.16.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/11740">PR 11740</a>), and such nodes are connected to as of <strong>v0.17.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/10387">PR 10387</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki"><code>BIP 173</code></a>: Bech32 addresses for native Segregated Witness outputs are supported as of <strong>v0.16.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/11167">PR 11167</a>). Bech32 addresses are generated by default as of <strong>v0.20.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/16884">PR 16884</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0174.mediawiki"><code>BIP 174</code></a>: RPCs to operate on Partially Signed Bitcoin Transactions (PSBT) are present as of <strong>v0.17.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/13557">PR 13557</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0176.mediawiki"><code>BIP 176</code></a>: Bits Denomination [QT only] is supported as of <strong>v0.16.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/12035">PR 12035</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0325.mediawiki"><code>BIP 325</code></a>: Signet test network is supported as of <strong>v0.21.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/18267">PR 18267</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0339.mediawiki"><code>BIP 339</code></a>: Relay of transactions by wtxid is supported as of <strong>v0.21.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/18044">PR 18044</a>).</li>
<li><a href="https://github.com/bitcoin/bips/blob/master/bip-0340.mediawiki"><code>BIP 340</code></a> <a href="https://github.com/bitcoin/bips/blob/master/bip-0341.mediawiki"><code>341</code></a> <a href="https://github.com/bitcoin/bips/blob/master/bip-0342.mediawiki"><code>342</code></a>: Validation rules for Taproot (including Schnorr signatures and Tapscript leaves) are implemented as of <strong>v0.21.0</strong> (<a href="https://github.com/bitcoin/bitcoin/pull/19953">PR 19953</a>), without mainnet activation.</li>
</ul>
<h1 id="bitcoinconf-configuration-file"><code>bitcoin.conf</code> Configuration File</h1>
<p>The configuration file is used by <code>bitcoind</code>, <code>bitcoin-qt</code> and <code>bitcoin-cli</code>.</p>
<p>All command-line options (except for <code>-?</code>, <code>-help</code>, <code>-version</code> and <code>-conf</code>) may be specified in a configuration file, and all configuration file options (except for <code>includeconf</code>) may also be specified on the command line. Command-line options override values set in the configuration file and configuration file options override values set in the GUI.</p>
<h2 id="configuration-file-format">Configuration File Format</h2>
<p>The configuration file is a plain text file and consists of <code>option=value</code> entries, one per line. Leading and trailing whitespaces are removed.</p>
<p>In contrast to the command-line usage:</p>
<ul>
<li>an option must be specified without leading <code>-</code>;</li>
<li>a value of the given option is mandatory; e.g., <code>testnet=1</code> (for chain selection options), <code>noconnect=1</code> (for negated options).</li>
</ul>
<h3 id="blank-lines">Blank lines</h3>
<p>Blank lines are allowed and ignored by the parser.</p>
<h3 id="comments">Comments</h3>
<p>A comment starts with a number sign (<code>#</code>) and extends to the end of the line. All comments are ignored by the parser.</p>
<p>Comments may appear in two ways:</p>
<ul>
<li>on their own on an otherwise empty line (<em>preferable</em>);</li>
<li>after an <code>option=value</code> entry.</li>
</ul>
<h3 id="network-specific-options">Network specific options</h3>
<p>Network specific options can be:</p>
<ul>
<li>placed into sections with headers <code>[main]</code> (not <code>[mainnet]</code>), <code>[test]</code> (not <code>[testnet]</code>) or <code>[regtest]</code>;</li>
<li>prefixed with a chain name; e.g., <code>regtest.maxmempool=100</code>.</li>
</ul>
<p>Network specific options take precedence over non-network specific options. If multiple values for the same option are found with the same precedence, the first one is generally chosen.</p>
<p>This means that given the following configuration, <code>regtest.rpcport</code> is set to <code>3000</code>:</p>
<pre><code>regtest=1
rpcport=2000
regtest.rpcport=3000

[regtest]
rpcport=4000
</code></pre>
<h2 id="configuration-file-path">Configuration File Path</h2>
<p>The configuration file is not automatically created; you can create it using your favorite text editor. By default, the configuration file name is <code>bitcoin.conf</code> and it is located in the Bitcoin data directory, but both the Bitcoin data directory and the configuration file path may be changed using the <code>-datadir</code> and <code>-conf</code> command-line options.</p>
<p>The <code>includeconf=&lt;file&gt;</code> option in the <code>bitcoin.conf</code> file can be used to include additional configuration files.</p>
<h3 id="default-configuration-file-locations">Default configuration file locations</h3>
<table>
<thead>
<tr class="header">
<th>Operating System</th>
<th>Data Directory</th>
<th>Example Path</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Windows</td>
<td><code>%APPDATA%\Bitcoin\</code></td>
<td><code>C:\Users\username\AppData\Roaming\Bitcoin\bitcoin.conf</code></td>
</tr>
<tr class="even">
<td>Linux</td>
<td><code>$HOME/.bitcoin/</code></td>
<td><code>/home/username/.bitcoin/bitcoin.conf</code></td>
</tr>
<tr class="odd">
<td>macOS</td>
<td><code>$HOME/Library/Application Support/Bitcoin/</code></td>
<td><code>/Users/username/Library/Application Support/Bitcoin/bitcoin.conf</code></td>
</tr>
</tbody>
</table>
<h1 id="you-can-find-an-example-bitcoinconf-file-in-shareexamplesbitcoinconf-freebsd-build-guide">You can find an example bitcoin.conf file in <a href="../share/examples/bitcoin.conf">share/examples/bitcoin.conf</a>. FreeBSD build guide</h1>
<p>(updated for FreeBSD 12.0)</p>
<p>This guide describes how to build bitcoind and command-line utilities on FreeBSD.</p>
<p>This guide does not contain instructions for building the GUI.</p>
<h2 id="preparation">Preparation</h2>
<p>You will need the following dependencies, which can be installed as root via pkg:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" title="1"><span class="ex">pkg</span> install autoconf automake boost-libs git gmake libevent libtool pkgconf</a>
<a class="sourceLine" id="cb7-2" title="2"></a>
<a class="sourceLine" id="cb7-3" title="3"><span class="fu">git</span> clone https://github.com/bitcoin/bitcoin.git</a></code></pre></div>
<p>In order to run the test suite (recommended), you will need to have Python 3 installed:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb8-1" title="1"><span class="ex">pkg</span> install python3</a></code></pre></div>
<p>See <a href="dependencies.html">dependencies.html</a> for a complete overview.</p>
<h3 id="building-berkeleydb">Building BerkeleyDB</h3>
<p>BerkeleyDB is only necessary for the wallet functionality. To skip this, pass <code>--disable-wallet</code> to <code>./configure</code> and skip to the next section.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb9-1" title="1"><span class="ex">./contrib/install_db4.sh</span> <span class="kw">`</span><span class="bu">pwd</span><span class="kw">`</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="bu">export</span> <span class="va">BDB_PREFIX=</span><span class="st">&quot;</span><span class="va">$PWD</span><span class="st">/db4&quot;</span></a></code></pre></div>
<h2 id="building-bitcoin-core">Building Bitcoin Core</h2>
<p><strong>Important</strong>: Use <code>gmake</code> (the non-GNU <code>make</code> will exit with an error).</p>
<p>With wallet:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb10-1" title="1"><span class="ex">./autogen.sh</span></a>
<a class="sourceLine" id="cb10-2" title="2"><span class="ex">./configure</span> --with-gui=no \</a>
<a class="sourceLine" id="cb10-3" title="3">    BDB_LIBS=<span class="st">&quot;-L</span><span class="va">${BDB_PREFIX}</span><span class="st">/lib -ldb_cxx-4.8&quot;</span> \</a>
<a class="sourceLine" id="cb10-4" title="4">    BDB_CFLAGS=<span class="st">&quot;-I</span><span class="va">${BDB_PREFIX}</span><span class="st">/include&quot;</span> \</a>
<a class="sourceLine" id="cb10-5" title="5">    MAKE=gmake</a></code></pre></div>
<p>Without wallet:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb11-1" title="1"><span class="ex">./autogen.sh</span></a>
<a class="sourceLine" id="cb11-2" title="2"><span class="ex">./configure</span> --with-gui=no --disable-wallet MAKE=gmake</a></code></pre></div>
<p>followed by:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb12-1" title="1"><span class="fu">gmake</span> <span class="co"># use -jX here for parallelism</span></a>
<a class="sourceLine" id="cb12-2" title="2"><span class="fu">gmake</span> check <span class="co"># Run tests if Python 3 is available</span></a></code></pre></div>
<h1 id="netbsd-build-guide">NetBSD build guide</h1>
<p>(updated for NetBSD 8.0)</p>
<p>This guide describes how to build bitcoind and command-line utilities on NetBSD.</p>
<p>This guide does not contain instructions for building the GUI.</p>
<h2 id="preparation-1">Preparation</h2>
<p>You will need the following modules, which can be installed via pkgsrc or pkgin:</p>
<pre><code>autoconf
automake
boost
git
gmake
libevent
libtool
pkg-config
python37

git clone https://github.com/bitcoin/bitcoin.git
</code></pre>
<p>See <a href="dependencies.html">dependencies.html</a> for a complete overview.</p>
<h3 id="building-berkeleydb-1">Building BerkeleyDB</h3>
<p>BerkeleyDB is only necessary for the wallet functionality. To skip this, pass <code>--disable-wallet</code> to <code>./configure</code> and skip to the next section.</p>
<p>It is recommended to use Berkeley DB 4.8. You cannot use the BerkeleyDB library from ports, for the same reason as boost above (g++/libstd++ incompatibility). If you have to build it yourself, you can use <a href="/contrib/install_db4.sh">the installation script included in contrib/</a> like so:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb14-1" title="1"><span class="ex">./contrib/install_db4.sh</span> <span class="kw">`</span><span class="bu">pwd</span><span class="kw">`</span></a></code></pre></div>
<p>from the root of the repository. Then set <code>BDB_PREFIX</code> for the next section:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb15-1" title="1"><span class="bu">export</span> <span class="va">BDB_PREFIX=</span><span class="st">&quot;</span><span class="va">$PWD</span><span class="st">/db4&quot;</span></a></code></pre></div>
<h3 id="building-bitcoin-core-1">Building Bitcoin Core</h3>
<p><strong>Important</strong>: Use <code>gmake</code> (the non-GNU <code>make</code> will exit with an error).</p>
<p>With wallet:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb16-1" title="1"><span class="ex">./autogen.sh</span></a>
<a class="sourceLine" id="cb16-2" title="2"><span class="ex">./configure</span> --with-gui=no CPPFLAGS=<span class="st">&quot;-I/usr/pkg/include&quot;</span> \</a>
<a class="sourceLine" id="cb16-3" title="3">    LDFLAGS=<span class="st">&quot;-L/usr/pkg/lib&quot;</span> \</a>
<a class="sourceLine" id="cb16-4" title="4">    BOOST_CPPFLAGS=<span class="st">&quot;-I/usr/pkg/include&quot;</span> \</a>
<a class="sourceLine" id="cb16-5" title="5">    BOOST_LDFLAGS=<span class="st">&quot;-L/usr/pkg/lib&quot;</span> \</a>
<a class="sourceLine" id="cb16-6" title="6">    BDB_LIBS=<span class="st">&quot;-L</span><span class="va">${BDB_PREFIX}</span><span class="st">/lib -ldb_cxx-4.8&quot;</span> \</a>
<a class="sourceLine" id="cb16-7" title="7">    BDB_CFLAGS=<span class="st">&quot;-I</span><span class="va">${BDB_PREFIX}</span><span class="st">/include&quot;</span> \</a>
<a class="sourceLine" id="cb16-8" title="8">    MAKE=gmake</a></code></pre></div>
<p>Without wallet:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb17-1" title="1"><span class="ex">./autogen.sh</span></a>
<a class="sourceLine" id="cb17-2" title="2"><span class="ex">./configure</span> --with-gui=no --disable-wallet \</a>
<a class="sourceLine" id="cb17-3" title="3">    CPPFLAGS=<span class="st">&quot;-I/usr/pkg/include&quot;</span> \</a>
<a class="sourceLine" id="cb17-4" title="4">    LDFLAGS=<span class="st">&quot;-L/usr/pkg/lib&quot;</span> \</a>
<a class="sourceLine" id="cb17-5" title="5">    BOOST_CPPFLAGS=<span class="st">&quot;-I/usr/pkg/include&quot;</span> \</a>
<a class="sourceLine" id="cb17-6" title="6">    BOOST_LDFLAGS=<span class="st">&quot;-L/usr/pkg/lib&quot;</span> \</a>
<a class="sourceLine" id="cb17-7" title="7">    MAKE=gmake</a></code></pre></div>
<p>Build and run the tests:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb18-1" title="1"><span class="fu">gmake</span> <span class="co"># use -jX here for parallelism</span></a>
<a class="sourceLine" id="cb18-2" title="2"><span class="fu">gmake</span> check</a></code></pre></div>
<h1 id="openbsd-build-guide">OpenBSD build guide</h1>
<p>(updated for OpenBSD 6.7)</p>
<p>This guide describes how to build bitcoind, bitcoin-qt, and command-line utilities on OpenBSD.</p>
<h2 id="preparation-2">Preparation</h2>
<p>Run the following as root to install the base dependencies for building:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb19-1" title="1"><span class="ex">pkg_add</span> git gmake libevent libtool boost</a>
<a class="sourceLine" id="cb19-2" title="2"><span class="ex">pkg_add</span> qt5 <span class="co"># (optional for enabling the GUI)</span></a>
<a class="sourceLine" id="cb19-3" title="3"><span class="ex">pkg_add</span> autoconf <span class="co"># (select highest version, e.g. 2.69)</span></a>
<a class="sourceLine" id="cb19-4" title="4"><span class="ex">pkg_add</span> automake <span class="co"># (select highest version, e.g. 1.16)</span></a>
<a class="sourceLine" id="cb19-5" title="5"><span class="ex">pkg_add</span> python <span class="co"># (select highest version, e.g. 3.8)</span></a>
<a class="sourceLine" id="cb19-6" title="6"></a>
<a class="sourceLine" id="cb19-7" title="7"><span class="fu">git</span> clone https://github.com/bitcoin/bitcoin.git</a></code></pre></div>
<p>See <a href="dependencies.html">dependencies.html</a> for a complete overview.</p>
<p><strong>Important</strong>: From OpenBSD 6.2 onwards a C++11-supporting clang compiler is part of the base image, and while building it is necessary to make sure that this compiler is used and not ancient g++ 4.2.1. This is done by appending <code>CC=cc CC_FOR_BUILD=cc CXX=c++</code> to configuration commands. Mixing different compilers within the same executable will result in errors.</p>
<h3 id="building-berkeleydb-2">Building BerkeleyDB</h3>
<p>BerkeleyDB is only necessary for the wallet functionality. To skip this, pass <code>--disable-wallet</code> to <code>./configure</code> and skip to the next section.</p>
<p>It is recommended to use Berkeley DB 4.8. You cannot use the BerkeleyDB library from ports, for the same reason as boost above (g++/libstd++ incompatibility). If you have to build it yourself, you can use <a href="/contrib/install_db4.sh">the installation script included in contrib/</a> like so:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb20-1" title="1"><span class="ex">./contrib/install_db4.sh</span> <span class="kw">`</span><span class="bu">pwd</span><span class="kw">`</span> CC=cc CXX=c++</a></code></pre></div>
<p>from the root of the repository. Then set <code>BDB_PREFIX</code> for the next section:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb21-1" title="1"><span class="bu">export</span> <span class="va">BDB_PREFIX=</span><span class="st">&quot;</span><span class="va">$PWD</span><span class="st">/db4&quot;</span></a></code></pre></div>
<h3 id="building-bitcoin-core-2">Building Bitcoin Core</h3>
<p><strong>Important</strong>: Use <code>gmake</code> (the non-GNU <code>make</code> will exit with an error).</p>
<p>Preparation:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb22-1" title="1"></a>
<a class="sourceLine" id="cb22-2" title="2"><span class="co"># Replace this with the autoconf version that you installed. Include only</span></a>
<a class="sourceLine" id="cb22-3" title="3"><span class="co"># the major and minor parts of the version: use &quot;2.69&quot; for &quot;autoconf-2.69p2&quot;.</span></a>
<a class="sourceLine" id="cb22-4" title="4"><span class="bu">export</span> <span class="va">AUTOCONF_VERSION=</span>2.69</a>
<a class="sourceLine" id="cb22-5" title="5"></a>
<a class="sourceLine" id="cb22-6" title="6"><span class="co"># Replace this with the automake version that you installed. Include only</span></a>
<a class="sourceLine" id="cb22-7" title="7"><span class="co"># the major and minor parts of the version: use &quot;1.16&quot; for &quot;automake-1.16.1&quot;.</span></a>
<a class="sourceLine" id="cb22-8" title="8"><span class="bu">export</span> <span class="va">AUTOMAKE_VERSION=</span>1.16</a>
<a class="sourceLine" id="cb22-9" title="9"></a>
<a class="sourceLine" id="cb22-10" title="10"><span class="ex">./autogen.sh</span></a></code></pre></div>
<p>Make sure <code>BDB_PREFIX</code> is set to the appropriate path from the above steps.</p>
<p>To configure with wallet:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb23-1" title="1"><span class="ex">./configure</span> --with-gui=no CC=cc CXX=c++ \</a>
<a class="sourceLine" id="cb23-2" title="2">    BDB_LIBS=<span class="st">&quot;-L</span><span class="va">${BDB_PREFIX}</span><span class="st">/lib -ldb_cxx-4.8&quot;</span> \</a>
<a class="sourceLine" id="cb23-3" title="3">    BDB_CFLAGS=<span class="st">&quot;-I</span><span class="va">${BDB_PREFIX}</span><span class="st">/include&quot;</span> \</a>
<a class="sourceLine" id="cb23-4" title="4">    MAKE=gmake</a></code></pre></div>
<p>To configure without wallet:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb24-1" title="1"><span class="ex">./configure</span> --disable-wallet --with-gui=no CC=cc CC_FOR_BUILD=cc CXX=c++ MAKE=gmake</a></code></pre></div>
<p>To configure with GUI:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb25-1" title="1"><span class="ex">./configure</span> --with-gui=yes CC=cc CXX=c++ \</a>
<a class="sourceLine" id="cb25-2" title="2">    BDB_LIBS=<span class="st">&quot;-L</span><span class="va">${BDB_PREFIX}</span><span class="st">/lib -ldb_cxx-4.8&quot;</span> \</a>
<a class="sourceLine" id="cb25-3" title="3">    BDB_CFLAGS=<span class="st">&quot;-I</span><span class="va">${BDB_PREFIX}</span><span class="st">/include&quot;</span> \</a>
<a class="sourceLine" id="cb25-4" title="4">    MAKE=gmake</a></code></pre></div>
<p>Build and run the tests:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb26-1" title="1"><span class="fu">gmake</span> <span class="co"># use -jX here for parallelism</span></a>
<a class="sourceLine" id="cb26-2" title="2"><span class="fu">gmake</span> check</a></code></pre></div>
<h2 id="resource-limits">Resource limits</h2>
<p>If the build runs into out-of-memory errors, the instructions in this section might help.</p>
<p>The standard ulimit restrictions in OpenBSD are very strict:</p>
<pre><code>data(kbytes)         1572864
</code></pre>
<p>This is, unfortunately, in some cases not enough to compile some <code>.cpp</code> files in the project, (see issue <a href="https://github.com/bitcoin/bitcoin/issues/6658">#6658</a>). If your user is in the <code>staff</code> group the limit can be raised with:</p>
<pre><code>ulimit -d 3000000
</code></pre>
<p>The change will only affect the current shell and processes spawned by it. To make the change system-wide, change <code>datasize-cur</code> and <code>datasize-max</code> in <code>/etc/login.conf</code>, and reboot.</p>
<h1 id="macos-build-instructions-and-notes">macOS Build Instructions and Notes</h1>
<p>The commands in this guide should be executed in a Terminal application. The built-in one is located in</p>
<pre><code>/Applications/Utilities/Terminal.app
</code></pre>
<h2 id="preparation-3">Preparation</h2>
<p>Install the macOS command line tools:</p>
<pre class="shell"><code>xcode-select --install
</code></pre>
<p>When the popup appears, click <code>Install</code>.</p>
<p>Then install <a href="https://brew.sh">Homebrew</a>.</p>
<h2 id="dependencies">Dependencies</h2>
<pre class="shell"><code>brew install automake berkeley-db4 libtool boost miniupnpc pkg-config python qt libevent qrencode sqlite
</code></pre>
<p>If you run into issues, check <a href="https://docs.brew.sh/Troubleshooting">Homebrew's troubleshooting page</a>. See <a href="dependencies.html">dependencies.html</a> for a complete overview.</p>
<p>If you want to build the disk image with <code>make deploy</code> (.dmg / optional), you need RSVG:</p>
<pre class="shell"><code>brew install librsvg
</code></pre>
<h2 id="berkeley-db">Berkeley DB</h2>
<p>It is recommended to use Berkeley DB 4.8. If you have to build it yourself, you can use <a href="/contrib/install_db4.sh">this</a> script to install it like so:</p>
<pre class="shell"><code>./contrib/install_db4.sh .
</code></pre>
<p>from the root of the repository.</p>
<p><strong>Note</strong>: You only need Berkeley DB if the wallet is enabled (see <a href="/doc/build-osx.html#disable-wallet-mode"><em>Disable-wallet mode</em></a>).</p>
<h2 id="build-bitcoin-core">Build Bitcoin Core</h2>
<ol>
<li><p>Clone the Bitcoin Core source code:</p>
<pre class="shell"><code>git clone https://github.com/bitcoin/bitcoin
cd bitcoin
</code></pre></li>
<li><p>Build Bitcoin Core:</p>
<p>Configure and build the headless Bitcoin Core binaries as well as the GUI (if Qt is found).</p>
<p>You can disable the GUI build by passing <code>--without-gui</code> to configure.</p>
<pre class="shell"><code>./autogen.sh
./configure
make
</code></pre></li>
<li><p>It is recommended to build and run the unit tests:</p>
<pre class="shell"><code>make check
</code></pre></li>
<li><p>You can also create a <code>.dmg</code> that contains the <code>.app</code> bundle (optional):</p>
<pre class="shell"><code>make deploy
</code></pre></li>
</ol>
<h2 id="disable-wallet-mode"><code>disable-wallet</code> mode</h2>
<p>When the intention is to run only a P2P node without a wallet, Bitcoin Core may be compiled in <code>disable-wallet</code> mode with:</p>
<pre class="shell"><code>./configure --disable-wallet
</code></pre>
<p>In this case there is no dependency on Berkeley DB 4.8 and SQLite.</p>
<p>Mining is also possible in disable-wallet mode using the <code>getblocktemplate</code> RPC call.</p>
<h2 id="running-2">Running</h2>
<p>Bitcoin Core is now available at <code>./src/bitcoind</code></p>
<p>Before running, you may create an empty configuration file:</p>
<pre class="shell"><code>mkdir -p &quot;/Users/${USER}/Library/Application Support/Bitcoin&quot;

touch &quot;/Users/${USER}/Library/Application Support/Bitcoin/bitcoin.conf&quot;

chmod 600 &quot;/Users/${USER}/Library/Application Support/Bitcoin/bitcoin.conf&quot;
</code></pre>
<p>The first time you run bitcoind, it will start downloading the blockchain. This process could take many hours, or even days on slower than average systems.</p>
<p>You can monitor the download process by looking at the debug.log file:</p>
<pre class="shell"><code>tail -f $HOME/Library/Application\ Support/Bitcoin/debug.log
</code></pre>
<h2 id="other-commands">Other commands:</h2>
<pre class="shell"><code>./src/bitcoind -daemon      # Starts the bitcoin daemon.
./src/bitcoin-cli --help    # Outputs a list of command-line options.
./src/bitcoin-cli help      # Outputs a list of RPC commands when the daemon is running.
</code></pre>
<h2 id="notes-1">Notes</h2>
<ul>
<li>Tested on OS X 10.12 Sierra through macOS 10.15 Catalina on 64-bit Intel processors only.</li>
<li>Building with downloaded Qt binaries is not officially supported. See the notes in <a href="https://github.com/bitcoin/bitcoin/issues/7714">#7714</a>. UNIX BUILD NOTES ==================== Some notes on how to build Bitcoin Core in Unix.</li>
</ul>
<p>(For BSD specific instructions, see <code>build-*bsd.html</code> in this directory.)</p>
<h2 id="note">Note</h2>
<p>Always use absolute paths to configure and compile Bitcoin Core and the dependencies. For example, when specifying the path of the dependency:</p>
<pre><code>../dist/configure --enable-cxx --disable-shared --with-pic --prefix=$BDB_PREFIX
</code></pre>
<p>Here BDB_PREFIX must be an absolute path - it is defined using $(pwd) which ensures the usage of the absolute path.</p>
<h2 id="to-build">To Build</h2>
<div class="sourceCode" id="cb43"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb43-1" title="1"><span class="ex">./autogen.sh</span></a>
<a class="sourceLine" id="cb43-2" title="2"><span class="ex">./configure</span></a>
<a class="sourceLine" id="cb43-3" title="3"><span class="fu">make</span></a>
<a class="sourceLine" id="cb43-4" title="4"><span class="fu">make</span> install <span class="co"># optional</span></a></code></pre></div>
<p>This will build bitcoin-qt as well, if the dependencies are met.</p>
<h2 id="dependencies-1">Dependencies</h2>
<p>These dependencies are required:</p>
<table>
<thead>
<tr class="header">
<th>Library</th>
<th>Purpose</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>libboost</td>
<td>Utility</td>
<td>Library for threading, data structures, etc</td>
</tr>
<tr class="even">
<td>libevent</td>
<td>Networking</td>
<td>OS independent asynchronous networking</td>
</tr>
</tbody>
</table>
<p>Optional dependencies:</p>
<table>
<thead>
<tr class="header">
<th>Library</th>
<th>Purpose</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>miniupnpc</td>
<td>UPnP Support</td>
<td>Firewall-jumping support</td>
</tr>
<tr class="even">
<td>libdb4.8</td>
<td>Berkeley DB</td>
<td>Wallet storage (only needed when wallet enabled)</td>
</tr>
<tr class="odd">
<td>qt</td>
<td>GUI</td>
<td>GUI toolkit (only needed when GUI enabled)</td>
</tr>
<tr class="even">
<td>libqrencode</td>
<td>QR codes in GUI</td>
<td>Optional for generating QR codes (only needed when GUI enabled)</td>
</tr>
<tr class="odd">
<td>univalue</td>
<td>Utility</td>
<td>JSON parsing and encoding (bundled version will be used unless --with-system-univalue passed to configure)</td>
</tr>
<tr class="even">
<td>libzmq3</td>
<td>ZMQ notification</td>
<td>Optional, allows generating ZMQ notifications (requires ZMQ version &gt;= 4.0.0)</td>
</tr>
<tr class="odd">
<td>sqlite3</td>
<td>SQLite DB</td>
<td>Optional, wallet storage (only needed when wallet enabled)</td>
</tr>
</tbody>
</table>
<p>For the versions used, see <a href="dependencies.html">dependencies.html</a></p>
<h2 id="memory-requirements">Memory Requirements</h2>
<p>C++ compilers are memory-hungry. It is recommended to have at least 1.5 GB of memory available when compiling Bitcoin Core. On systems with less, gcc can be tuned to conserve memory with additional CXXFLAGS:</p>
<pre><code>./configure CXXFLAGS=&quot;--param ggc-min-expand=1 --param ggc-min-heapsize=32768&quot;
</code></pre>
<p>Alternatively, or in addition, debugging information can be skipped for compilation. The default compile flags are <code>-g -O2</code>, and can be changed with:</p>
<pre><code>./configure CXXFLAGS=&quot;-O2&quot;
</code></pre>
<p>Finally, clang (often less resource hungry) can be used instead of gcc, which is used by default:</p>
<pre><code>./configure CXX=clang++ CC=clang
</code></pre>
<h2 id="linux-distribution-specific-instructions">Linux Distribution Specific Instructions</h2>
<h3 id="ubuntu--debian">Ubuntu &amp; Debian</h3>
<h4 id="dependency-build-instructions">Dependency Build Instructions</h4>
<p>Build requirements:</p>
<pre><code>sudo apt-get install build-essential libtool autotools-dev automake pkg-config bsdmainutils python3
</code></pre>
<p>Now, you can either build from self-compiled <a href="/depends/README.html">depends</a> or install the required dependencies:</p>
<pre><code>sudo apt-get install libevent-dev libboost-system-dev libboost-filesystem-dev libboost-test-dev libboost-thread-dev
</code></pre>
<p>BerkeleyDB is required for the wallet.</p>
<p>Ubuntu and Debian have their own <code>libdb-dev</code> and <code>libdb++-dev</code> packages, but these will install BerkeleyDB 5.1 or later. This will break binary wallet compatibility with the distributed executables, which are based on BerkeleyDB 4.8. If you do not care about wallet compatibility, pass <code>--with-incompatible-bdb</code> to configure.</p>
<p>Otherwise, you can build from self-compiled <code>depends</code> (see above).</p>
<p>SQLite is required for the wallet:</p>
<pre><code>sudo apt install libsqlite3-dev
</code></pre>
<p>To build Bitcoin Core without wallet, see <a href="/doc/build-unix.html#disable-wallet-mode"><em>Disable-wallet mode</em></a></p>
<p>Optional (see <code>--with-miniupnpc</code> and <code>--enable-upnp-default</code>):</p>
<pre><code>sudo apt-get install libminiupnpc-dev
</code></pre>
<p>ZMQ dependencies (provides ZMQ API):</p>
<pre><code>sudo apt-get install libzmq3-dev
</code></pre>
<p>GUI dependencies:</p>
<p>If you want to build bitcoin-qt, make sure that the required packages for Qt development are installed. Qt 5 is necessary to build the GUI. To build without GUI pass <code>--without-gui</code>.</p>
<p>To build with Qt 5 you need the following:</p>
<pre><code>sudo apt-get install libqt5gui5 libqt5core5a libqt5dbus5 qttools5-dev qttools5-dev-tools
</code></pre>
<p>libqrencode (optional) can be installed with:</p>
<pre><code>sudo apt-get install libqrencode-dev
</code></pre>
<p>Once these are installed, they will be found by configure and a bitcoin-qt executable will be built by default.</p>
<h3 id="fedora">Fedora</h3>
<h4 id="dependency-build-instructions-1">Dependency Build Instructions</h4>
<p>Build requirements:</p>
<pre><code>sudo dnf install gcc-c++ libtool make autoconf automake libevent-devel boost-devel libdb4-devel libdb4-cxx-devel python3
</code></pre>
<p>Optional (see <code>--with-miniupnpc</code> and <code>--enable-upnp-default</code>):</p>
<pre><code>sudo dnf install miniupnpc-devel
</code></pre>
<p>ZMQ dependencies (provides ZMQ API):</p>
<pre><code>sudo dnf install zeromq-devel
</code></pre>
<p>To build with Qt 5 you need the following:</p>
<pre><code>sudo dnf install qt5-qttools-devel qt5-qtbase-devel
</code></pre>
<p>libqrencode (optional) can be installed with:</p>
<pre><code>sudo dnf install qrencode-devel
</code></pre>
<p>SQLite can be installed with:</p>
<pre><code>sudo dnf install sqlite-devel
</code></pre>
<h2 id="notes-2">Notes</h2>
<p>The release is built with GCC and then "strip bitcoind" to strip the debug symbols, which reduces the executable size by about 90%.</p>
<h2 id="miniupnpc">miniupnpc</h2>
<p><a href="https://miniupnp.tuxfamily.org">miniupnpc</a> may be used for UPnP port mapping. It can be downloaded from <a href="https://miniupnp.tuxfamily.org/files/">here</a>. UPnP support is compiled in and turned off by default. See the configure options for upnp behavior desired:</p>
<pre><code>--without-miniupnpc      No UPnP support miniupnp not required
--disable-upnp-default   (the default) UPnP support turned off by default at runtime
--enable-upnp-default    UPnP support turned on by default at runtime
</code></pre>
<h2 id="berkeley-db-1">Berkeley DB</h2>
<p>It is recommended to use Berkeley DB 4.8. If you have to build it yourself, you can use <a href="/contrib/install_db4.sh">the installation script included in contrib/</a> like so:</p>
<pre class="shell"><code>./contrib/install_db4.sh `pwd`
</code></pre>
<p>from the root of the repository.</p>
<p><strong>Note</strong>: You only need Berkeley DB if the wallet is enabled (see <a href="/doc/build-unix.html#disable-wallet-mode"><em>Disable-wallet mode</em></a>).</p>
<h2 id="boost">Boost</h2>
<p>If you need to build Boost yourself:</p>
<pre><code>sudo su
./bootstrap.sh
./bjam install
</code></pre>
<h2 id="security-1">Security</h2>
<p>To help make your Bitcoin Core installation more secure by making certain attacks impossible to exploit even if a vulnerability is found, binaries are hardened by default. This can be disabled with:</p>
<p>Hardening Flags:</p>
<pre><code>./configure --enable-hardening
./configure --disable-hardening
</code></pre>
<p>Hardening enables the following features:</p>
<ul>
<li><p><em>Position Independent Executable</em>: Build position independent code to take advantage of Address Space Layout Randomization offered by some kernels. Attackers who can cause execution of code at an arbitrary memory location are thwarted if they don't know where anything useful is located. The stack and heap are randomly located by default, but this allows the code section to be randomly located as well.</p>
<p>On an AMD64 processor where a library was not compiled with -fPIC, this will cause an error such as: "relocation R_X86_64_32 against `......' can not be used when making a shared object;"</p>
<p>To test that you have built PIE executable, install scanelf, part of paxutils, and use:</p>
<pre><code>  scanelf -e ./bitcoin
</code></pre>
<p>The output should contain:</p>
<p>TYPE ET_DYN</p></li>
<li><p><em>Non-executable Stack</em>: If the stack is executable then trivial stack-based buffer overflow exploits are possible if vulnerable buffers are found. By default, Bitcoin Core should be built with a non-executable stack, but if one of the libraries it uses asks for an executable stack or someone makes a mistake and uses a compiler extension which requires an executable stack, it will silently build an executable without the non-executable stack protection.</p>
<p>To verify that the stack is non-executable after compiling use: <code>scanelf -e ./bitcoin</code></p>
<p>The output should contain: STK/REL/PTL RW- R-- RW-</p>
<p>The STK RW- means that the stack is readable and writeable but not executable.</p></li>
</ul>
<h2 id="disable-wallet-mode-1">Disable-wallet mode</h2>
<p>When the intention is to run only a P2P node without a wallet, Bitcoin Core may be compiled in disable-wallet mode with:</p>
<pre><code>./configure --disable-wallet
</code></pre>
<p>In this case there is no dependency on Berkeley DB 4.8 and SQLite.</p>
<p>Mining is also possible in disable-wallet mode using the <code>getblocktemplate</code> RPC call.</p>
<h2 id="additional-configure-flags">Additional Configure Flags</h2>
<p>A list of additional configure flags can be displayed with:</p>
<pre><code>./configure --help
</code></pre>
<h2 id="setup-and-build-example-arch-linux">Setup and Build Example: Arch Linux</h2>
<p>This example lists the steps necessary to setup and build a command line only, non-wallet distribution of the latest changes on Arch Linux:</p>
<pre><code>pacman -S git base-devel boost libevent python
git clone https://github.com/bitcoin/bitcoin.git
cd bitcoin/
./autogen.sh
./configure --disable-wallet --without-gui --without-miniupnpc
make check
</code></pre>
<p>Note: Enabling wallet support requires either compiling against a Berkeley DB newer than 4.8 (package <code>db</code>) using <code>--with-incompatible-bdb</code>, or building and depending on a local version of Berkeley DB 4.8. The readily available Arch Linux packages are currently built using <code>--with-incompatible-bdb</code> according to the <a href="https://projects.archlinux.org/svntogit/community.git/tree/bitcoin/trunk/PKGBUILD">PKGBUILD</a>. As mentioned above, when maintaining portability of the wallet between the standard Bitcoin Core distributions and independently built node software is desired, Berkeley DB 4.8 must be used.</p>
<h2 id="arm-cross-compilation">ARM Cross-compilation</h2>
<p>These steps can be performed on, for example, an Ubuntu VM. The depends system will also work on other Linux distributions, however the commands for installing the toolchain will be different.</p>
<p>Make sure you install the build requirements mentioned above. Then, install the toolchain and curl:</p>
<pre><code>sudo apt-get install g++-arm-linux-gnueabihf curl
</code></pre>
<p>To build executables for ARM:</p>
<pre><code>cd depends
make HOST=arm-linux-gnueabihf NO_QT=1
cd ..
./autogen.sh
./configure --prefix=$PWD/depends/arm-linux-gnueabihf --enable-glibc-back-compat --enable-reduce-exports LDFLAGS=-static-libstdc++
make
</code></pre>
<h1 id="for-further-documentation-on-the-depends-system-see-readmehtml-in-the-depends-directory-windows-build-notes">For further documentation on the depends system see <a href="../depends/README.html">README.html</a> in the depends directory. WINDOWS BUILD NOTES</h1>
<p>Below are some notes on how to build Bitcoin Core for Windows.</p>
<p>The options known to work for building Bitcoin Core on Windows are:</p>
<ul>
<li>On Linux, using the <a href="https://mingw-w64.org/doku.php">Mingw-w64</a> cross compiler tool chain. Ubuntu Bionic 18.04 is required and is the platform used to build the Bitcoin Core Windows release binaries.</li>
<li>On Windows, using <a href="https://docs.microsoft.com/windows/wsl/about">Windows Subsystem for Linux (WSL)</a> and the Mingw-w64 cross compiler tool chain.</li>
<li>On Windows, using a native compiler tool chain such as <a href="https://www.visualstudio.com">Visual Studio</a>. See <a href="/build_msvc/README.html">README.html</a>.</li>
</ul>
<p>Other options which may work, but which have not been extensively tested are (please contribute instructions):</p>
<ul>
<li>On Windows, using a POSIX compatibility layer application such as <a href="https://www.cygwin.com/">cygwin</a> or <a href="https://www.msys2.org/">msys2</a>.</li>
</ul>
<h2 id="installing-windows-subsystem-for-linux">Installing Windows Subsystem for Linux</h2>
<p>With Windows 10, Microsoft has released a new feature named the <a href="https://docs.microsoft.com/windows/wsl/about">Windows Subsystem for Linux (WSL)</a>. This feature allows you to run a bash shell directly on Windows in an Ubuntu-based environment. Within this environment you can cross compile for Windows without the need for a separate Linux VM or server. Note that while WSL can be installed with other Linux variants, such as OpenSUSE, the following instructions have only been tested with Ubuntu.</p>
<p>This feature is not supported in versions of Windows prior to Windows 10 or on Windows Server SKUs. In addition, it is available <a href="https://docs.microsoft.com/windows/wsl/install-win10">only for 64-bit versions of Windows</a>.</p>
<p>Full instructions to install WSL are available on the above link. To install WSL on Windows 10 with Fall Creators Update installed (version &gt;= 16215.0) do the following:</p>
<ol>
<li>Enable the Windows Subsystem for Linux feature</li>
</ol>
<ul>
<li>Open the Windows Features dialog (<code>OptionalFeatures.exe</code>)</li>
<li>Enable 'Windows Subsystem for Linux'</li>
<li>Click 'OK' and restart if necessary</li>
</ul>
<ol start="2">
<li>Install Ubuntu</li>
</ol>
<ul>
<li>Open Microsoft Store and search for "Ubuntu 18.04" or use <a href="https://www.microsoft.com/store/productId/9N9TNGVNDL3Q">this link</a></li>
<li>Click Install</li>
</ul>
<ol start="3">
<li>Complete Installation</li>
</ol>
<ul>
<li>Open a .html prompt and type "Ubuntu1804"</li>
<li>Create a new UNIX user account (this is a separate account from your Windows account)</li>
</ul>
<p>After the bash shell is active, you can follow the instructions below, starting with the "Cross-compilation" section. Compiling the 64-bit version is recommended, but it is possible to compile the 32-bit version.</p>
<h2 id="cross-compilation-for-ubuntu-and-windows-subsystem-for-linux">Cross-compilation for Ubuntu and Windows Subsystem for Linux</h2>
<p>The steps below can be performed on Ubuntu (including in a VM) or WSL. The depends system will also work on other Linux distributions, however the commands for installing the toolchain will be different.</p>
<p>First, install the general dependencies:</p>
<pre><code>sudo apt update
sudo apt upgrade
sudo apt install build-essential libtool autotools-dev automake pkg-config bsdmainutils curl git
</code></pre>
<p>A host toolchain (<code>build-essential</code>) is necessary because some dependency packages need to build host utilities that are used in the build process.</p>
<p>See <a href="dependencies.html">dependencies.html</a> for a complete overview.</p>
<p>If you want to build the windows installer with <code>make deploy</code> you need <a href="https://nsis.sourceforge.io/Main_Page">NSIS</a>:</p>
<pre><code>sudo apt install nsis
</code></pre>
<p>Acquire the source in the usual way:</p>
<pre><code>git clone https://github.com/bitcoin/bitcoin.git
cd bitcoin
</code></pre>
<h2 id="building-for-64-bit-windows">Building for 64-bit Windows</h2>
<p>The first step is to install the mingw-w64 cross-compilation tool chain:</p>
<pre><code>sudo apt install g++-mingw-w64-x86-64
</code></pre>
<p>Ubuntu Bionic 18.04 <sup><a href="#footnote1">1</a></sup>:</p>
<pre><code>sudo update-alternatives --config x86_64-w64-mingw32-g++ # Set the default mingw32 g++ compiler option to posix.
</code></pre>
<p>Once the toolchain is installed the build steps are common:</p>
<p>Note that for WSL the Bitcoin Core source path MUST be somewhere in the default mount file system, for example /usr/src/bitcoin, AND not under /mnt/d/. If this is not the case the dependency autoconf scripts will fail. This means you cannot use a directory that is located directly on the host Windows file system to perform the build.</p>
<p>Additional WSL Note: WSL support for <a href="https://docs.microsoft.com/en-us/archive/blogs/wsl/windows-and-ubuntu-interoperability#launching-win32-applications-from-within-wsl">launching Win32 applications</a> results in <code>Autoconf</code> configure scripts being able to execute Windows Portable Executable files. This can cause unexpected behaviour during the build, such as Win32 error dialogs for missing libraries. The recommended approach is to temporarily disable WSL support for Win32 applications.</p>
<p>Build using:</p>
<pre><code>PATH=$(echo &quot;$PATH&quot; | sed -e &#39;s/:\/mnt.*//g&#39;) # strip out problematic Windows %PATH% imported var
sudo bash -c &quot;echo 0 &gt; /proc/sys/fs/binfmt_misc/status&quot; # Disable WSL support for Win32 applications.
cd depends
make HOST=x86_64-w64-mingw32
cd ..
./autogen.sh # not required when building from tarball
CONFIG_SITE=$PWD/depends/x86_64-w64-mingw32/share/config.site ./configure --prefix=/
make
sudo bash -c &quot;echo 1 &gt; /proc/sys/fs/binfmt_misc/status&quot; # Enable WSL support for Win32 applications.
</code></pre>
<h2 id="depends-system">Depends system</h2>
<p>For further documentation on the depends system see <a href="../depends/README.html">README.html</a> in the depends directory.</p>
<h2 id="installation">Installation</h2>
<p>After building using the Windows subsystem it can be useful to copy the compiled executables to a directory on the Windows drive in the same directory structure as they appear in the release <code>.zip</code> archive. This can be done in the following way. This will install to <code>c:\workspace\bitcoin</code>, for example:</p>
<pre><code>make install DESTDIR=/mnt/c/workspace/bitcoin
</code></pre>
<p>You can also create an installer using:</p>
<pre><code>make deploy
</code></pre>
<h2 id="footnotes">Footnotes</h2>
<h1 id="1-starting-from-ubuntu-xenial-1604-both-the-32-and-64-bit-mingw-w64-packages-install-two-different-compiler-options-to-allow-a-choice-between-either-posix-or-win32-threads-the-default-option-is-win32-threads-which-is-the-more-efficient-since-it-will-result-in-binary-code-that-links-directly-with-the-windows-kernel32lib-unfortunately-the-headers-required-to-support-win32-threads-conflict-with-some-of-the-classes-in-the-c11-standard-library-in-particular-stdmutex-its-not-possible-to-build-the-bitcoin-core-code-using-the-win32-version-of-the-mingw-w64-cross-compilers-at-least-not-without-modifying-headers-in-the-bitcoin-core-source-code-dependencies"><a name="footnote1">1</a>: Starting from Ubuntu Xenial 16.04, both the 32 and 64 bit Mingw-w64 packages install two different compiler options to allow a choice between either posix or win32 threads. The default option is win32 threads which is the more efficient since it will result in binary code that links directly with the Windows kernel32.lib. Unfortunately, the headers required to support win32 threads conflict with some of the classes in the C++11 standard library, in particular std::mutex. It's not possible to build the Bitcoin Core code using the win32 version of the Mingw-w64 cross compilers (at least not without modifying headers in the Bitcoin Core source code). Dependencies</h1>
<p>These are the dependencies currently used by Bitcoin Core. You can find instructions for installing them in the <code>build-*.html</code> file for your platform.</p>
<table>
<thead>
<tr class="header">
<th>Dependency</th>
<th>Version used</th>
<th>Minimum required</th>
<th>CVEs</th>
<th>Shared</th>
<th><a href="https://doc.qt.io/qt-5/configure-options.html#third-party-libraries">Bundled Qt library</a></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Berkeley DB</td>
<td><a href="https://www.oracle.com/technetwork/database/database-technologies/berkeleydb/downloads/index.html">4.8.30</a></td>
<td>4.8.x</td>
<td>No</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Boost</td>
<td><a href="https://www.boost.org/users/download/">1.70.0</a></td>
<td><a href="https://github.com/bitcoin/bitcoin/pull/19667">1.58.0</a></td>
<td>No</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>Clang</td>
<td></td>
<td><a href="https://releases.llvm.org/download.html">3.3+</a> (C++11 support)</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Expat</td>
<td><a href="https://libexpat.github.io/">2.2.7</a></td>
<td></td>
<td>No</td>
<td>Yes</td>
<td></td>
</tr>
<tr class="odd">
<td>fontconfig</td>
<td><a href="https://www.freedesktop.org/software/fontconfig/release/">2.12.1</a></td>
<td></td>
<td>No</td>
<td>Yes</td>
<td></td>
</tr>
<tr class="even">
<td>FreeType</td>
<td><a href="https://download.savannah.gnu.org/releases/freetype">2.7.1</a></td>
<td></td>
<td>No</td>
<td></td>
<td><a href="https://github.com/bitcoin/bitcoin/blob/master/depends/packages/qt.mk">Yes</a> (Android only)</td>
</tr>
<tr class="odd">
<td>GCC</td>
<td></td>
<td><a href="https://gcc.gnu.org/">4.8+</a> (C++11 support)</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>HarfBuzz-NG</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><a href="https://github.com/bitcoin/bitcoin/blob/master/depends/packages/qt.mk">Yes</a></td>
</tr>
<tr class="odd">
<td>libevent</td>
<td><a href="https://github.com/libevent/libevent/releases">2.1.11-stable</a></td>
<td><a href="https://github.com/bitcoin/bitcoin/pull/18676">2.0.21</a></td>
<td>No</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>libpng</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><a href="https://github.com/bitcoin/bitcoin/blob/master/depends/packages/qt.mk">Yes</a></td>
</tr>
<tr class="odd">
<td>librsvg</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>MiniUPnPc</td>
<td><a href="https://miniupnp.tuxfamily.org/files">2.0.20180203</a></td>
<td></td>
<td>No</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>PCRE</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><a href="https://github.com/bitcoin/bitcoin/blob/master/depends/packages/qt.mk">Yes</a></td>
</tr>
<tr class="even">
<td>Python (tests)</td>
<td></td>
<td><a href="https://www.python.org/downloads">3.5</a></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>qrencode</td>
<td><a href="https://fukuchi.org/works/qrencode">3.4.4</a></td>
<td></td>
<td>No</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>Qt</td>
<td><a href="https://download.qt.io/official_releases/qt/">5.9.8</a></td>
<td><a href="https://github.com/bitcoin/bitcoin/issues/13478">5.5.1</a></td>
<td>No</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>SQLite</td>
<td><a href="https://sqlite.org/download.html">3.32.1</a></td>
<td><a href="https://github.com/bitcoin/bitcoin/pull/19077">3.7.17</a></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>XCB</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><a href="https://github.com/bitcoin/bitcoin/blob/master/depends/packages/qt.mk">Yes</a> (Linux only)</td>
</tr>
<tr class="odd">
<td>xkbcommon</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td><a href="https://github.com/bitcoin/bitcoin/blob/master/depends/packages/qt.mk">Yes</a> (Linux only)</td>
</tr>
<tr class="even">
<td>ZeroMQ</td>
<td><a href="https://github.com/zeromq/libzmq/releases">4.3.1</a></td>
<td>4.0.0</td>
<td>No</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>zlib</td>
<td><a href="https://zlib.net/">1.2.11</a></td>
<td></td>
<td></td>
<td></td>
<td>No</td>
</tr>
</tbody>
</table>
<h2 id="controlling-dependencies">Controlling dependencies</h2>
<p>Some dependencies are not needed in all configurations. The following are some factors that affect the dependency list.</p>
<h4 id="options-passed-to-configure">Options passed to <code>./configure</code></h4>
<ul>
<li>MiniUPnPc is not needed with <code>--with-miniupnpc=no</code>.</li>
<li>Berkeley DB is not needed with <code>--disable-wallet</code>.</li>
<li>SQLite is not needed with <code>--disable-wallet</code> or <code>--without-sqlite</code>.</li>
<li>Qt is not needed with <code>--without-gui</code>.</li>
<li>If the qrencode dependency is absent, QR support won't be added. To force an error when that happens, pass <code>--with-qrencode</code>.</li>
<li>ZeroMQ is needed only with the <code>--with-zmq</code> option.</li>
</ul>
<h4 id="other">Other</h4>
<ul>
<li>librsvg is only needed if you need to run <code>make deploy</code> on (cross-compilation to) macOS.</li>
</ul>
<h1 id="support-for-output-descriptors-in-bitcoin-core">Support for Output Descriptors in Bitcoin Core</h1>
<p>Since Bitcoin Core v0.17, there is support for Output Descriptors. This is a simple language which can be used to describe collections of output scripts. Supporting RPCs are:</p>
<ul>
<li><code>scantxoutset</code> takes as input descriptors to scan for, and also reports specialized descriptors for the matching UTXOs.</li>
<li><code>getdescriptorinfo</code> analyzes a descriptor, and reports a canonicalized version with checksum added.</li>
<li><code>deriveaddresses</code> takes as input a descriptor and computes the corresponding addresses.</li>
<li><code>listunspent</code> outputs a specialized descriptor for the reported unspent outputs.</li>
<li><code>getaddressinfo</code> outputs a descriptor for solvable addresses (since v0.18).</li>
<li><code>importmulti</code> takes as input descriptors to import into the wallet (since v0.18).</li>
<li><code>generatetodescriptor</code> takes as input a descriptor and generates coins to it (<code>regtest</code> only, since v0.19).</li>
<li><code>utxoupdatepsbt</code> takes as input descriptors to add information to the psbt (since v0.19).</li>
<li><code>createmultisig</code> and <code>addmultisigaddress</code> return descriptors as well (since v0.20)</li>
</ul>
<p>This document describes the language. For the specifics on usage, see the RPC documentation for the functions mentioned above.</p>
<h2 id="features">Features</h2>
<p>Output descriptors currently support:</p>
<ul>
<li>Pay-to-pubkey scripts (P2PK), through the <code>pk</code> function.</li>
<li>Pay-to-pubkey-hash scripts (P2PKH), through the <code>pkh</code> function.</li>
<li>Pay-to-witness-pubkey-hash scripts (P2WPKH), through the <code>wpkh</code> function.</li>
<li>Pay-to-script-hash scripts (P2SH), through the <code>sh</code> function.</li>
<li>Pay-to-witness-script-hash scripts (P2WSH), through the <code>wsh</code> function.</li>
<li>Multisig scripts, through the <code>multi</code> function.</li>
<li>Multisig scripts where the public keys are sorted lexicographically, through the <code>sortedmulti</code> function.</li>
<li>Any type of supported address through the <code>addr</code> function.</li>
<li>Raw hex scripts through the <code>raw</code> function.</li>
<li>Public keys (compressed and uncompressed) in hex notation, or BIP32 extended pubkeys with derivation paths.</li>
</ul>
<h2 id="examples">Examples</h2>
<ul>
<li><code>pk(0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798)</code> describes a P2PK output with the specified public key.</li>
<li><code>pkh(02c6047f9441ed7d6d3045406e95c07cd85c778e4b8cef3ca7abac09b95c709ee5)</code> describes a P2PKH output with the specified public key.</li>
<li><code>wpkh(02f9308a019258c31049344f85f89d5229b531c845836f99b08601f113bce036f9)</code> describes a P2WPKH output with the specified public key.</li>
<li><code>sh(wpkh(03fff97bd5755eeea420453a14355235d382f6472f8568a18b2f057a1460297556))</code> describes a P2SH-P2WPKH output with the specified public key.</li>
<li><code>combo(0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798)</code> describes any P2PK, P2PKH, P2WPKH, or P2SH-P2WPKH output with the specified public key.</li>
<li><code>sh(wsh(pkh(02e493dbf1c10d80f3581e4904930b1404cc6c13900ee0758474fa94abe8c4cd13)))</code> describes an (overly complicated) P2SH-P2WSH-P2PKH output with the specified public key.</li>
<li><code>multi(1,022f8bde4d1a07209355b4a7250a5c5128e88b84bddc619ab7cba8d569b240efe4,025cbdf0646e5db4eaa398f365f2ea7a0e3d419b7e0330e39ce92bddedcac4f9bc)</code> describes a bare <em>1-of-2</em> multisig output with keys in the specified order.</li>
<li><code>sh(multi(2,022f01e5e15cca351daff3843fb70f3c2f0a1bdd05e5af888a67784ef3e10a2a01,03acd484e2f0c7f65309ad178a9f559abde09796974c57e714c35f110dfc27ccbe))</code> describes a P2SH <em>2-of-2</em> multisig output with keys in the specified order.</li>
<li><code>sh(sortedmulti(2,03acd484e2f0c7f65309ad178a9f559abde09796974c57e714c35f110dfc27ccbe,022f01e5e15cca351daff3843fb70f3c2f0a1bdd05e5af888a67784ef3e10a2a01))</code> describes a P2SH <em>2-of-2</em> multisig output with keys sorted lexicographically in the resulting redeemScript.</li>
<li><code>wsh(multi(2,03a0434d9e47f3c86235477c7b1ae6ae5d3442d49b1943c2b752a68e2a47e247c7,03774ae7f858a9411e5ef4246b70c65aac5649980be5c17891bbec17895da008cb,03d01115d548e7561b15c38f004d734633687cf4419620095bc5b0f47070afe85a))</code> describes a P2WSH <em>2-of-3</em> multisig output with keys in the specified order.</li>
<li><code>sh(wsh(multi(1,03f28773c2d975288bc7d1d205c3748651b075fbc6610e58cddeeddf8f19405aa8,03499fdf9e895e719cfd64e67f07d38e3226aa7b63678949e6e49b241a60e823e4,02d7924d4f7d43ea965a465ae3095ff41131e5946f3c85f79e44adbcf8e27e080e)))</code> describes a P2SH-P2WSH <em>1-of-3</em> multisig output with keys in the specified order.</li>
<li><code>pk(xpub661MyMwAqRbcFtXgS5sYJABqqG9YLmC4Q1Rdap9gSE8NqtwybGhePY2gZ29ESFjqJoCu1Rupje8YtGqsefD265TMg7usUDFdp6W1EGMcet8)</code> describes a P2PK output with the public key of the specified xpub.</li>
<li><code>pkh(xpub68Gmy5EdvgibQVfPdqkBBCHxA5htiqg55crXYuXoQRKfDBFA1WEjWgP6LHhwBZeNK1VTsfTFUHCdrfp1bgwQ9xv5ski8PX9rL2dZXvgGDnw/1'/2)</code> describes a P2PKH output with child key <em>1'/2</em> of the specified xpub.</li>
<li><code>pkh([d34db33f/44'/0'/0']xpub6ERApfZwUNrhLCkDtcHTcxd75RbzS1ed54G1LkBUHQVHQKqhMkhgbmJbZRkrgZw4koxb5JaHWkY4ALHY2grBGRjaDMzQLcgJvLJuZZvRcEL/1/*)</code> describes a set of P2PKH outputs, but additionally specifies that the specified xpub is a child of a master with fingerprint <code>d34db33f</code>, and derived using path <code>44'/0'/0'</code>.</li>
<li><code>wsh(multi(1,xpub661MyMwAqRbcFW31YEwpkMuc5THy2PSt5bDMsktWQcFF8syAmRUapSCGu8ED9W6oDMSgv6Zz8idoc4a6mr8BDzTJY47LJhkJ8UB7WEGuduB/1/0/*,xpub69H7F5d8KSRg.htmlJg2KhpAK8SR3DjMwAdkxj3ZuxV27CprR9LgpeyGmXUbC6wb7ERfvrnKZjXoUmmDznezpbZb7ap6r1D3tgFxHmwMkQTPH/0/0/*))</code> describes a set of <em>1-of-2</em> P2WSH multisig outputs where the first multisig key is the <em>1/0/<code>i</code></em> child of the first specified xpub and the second multisig key is the <em>0/0/<code>i</code></em> child of the second specified xpub, and <code>i</code> is any number in a configurable range (<code>0-1000</code> by default).</li>
<li><code>wsh(sortedmulti(1,xpub661MyMwAqRbcFW31YEwpkMuc5THy2PSt5bDMsktWQcFF8syAmRUapSCGu8ED9W6oDMSgv6Zz8idoc4a6mr8BDzTJY47LJhkJ8UB7WEGuduB/1/0/*,xpub69H7F5d8KSRg.htmlJg2KhpAK8SR3DjMwAdkxj3ZuxV27CprR9LgpeyGmXUbC6wb7ERfvrnKZjXoUmmDznezpbZb7ap6r1D3tgFxHmwMkQTPH/0/0/*))</code> describes a set of <em>1-of-2</em> P2WSH multisig outputs where one multisig key is the <em>1/0/<code>i</code></em> child of the first specified xpub and the other multisig key is the <em>0/0/<code>i</code></em> child of the second specified xpub, and <code>i</code> is any number in a configurable range (<code>0-1000</code> by default). The order of public keys in the resulting witnessScripts is determined by the lexicographic order of the public keys at that index.</li>
</ul>
<h2 id="reference">Reference</h2>
<p>Descriptors consist of several types of expressions. The top level expression is either a <code>SCRIPT</code>, or <code>SCRIPT#CHECKSUM</code> where <code>CHECKSUM</code> is an 8-character alphanumeric descriptor checksum.</p>
<p><code>SCRIPT</code> expressions:</p>
<ul>
<li><code>sh(SCRIPT)</code> (top level only): P2SH embed the argument.</li>
<li><code>wsh(SCRIPT)</code> (not inside another 'wsh'): P2WSH embed the argument.</li>
<li><code>pk(KEY)</code> (anywhere): P2PK output for the given public key.</li>
<li><code>pkh(KEY)</code> (anywhere): P2PKH output for the given public key (use <code>addr</code> if you only know the pubkey hash).</li>
<li><code>wpkh(KEY)</code> (not inside <code>wsh</code>): P2WPKH output for the given compressed pubkey.</li>
<li><code>combo(KEY)</code> (top level only): an alias for the collection of <code>pk(KEY)</code> and <code>pkh(KEY)</code>. If the key is compressed, it also includes <code>wpkh(KEY)</code> and <code>sh(wpkh(KEY))</code>.</li>
<li><code>multi(k,KEY_1,KEY_2,...,KEY_n)</code> (anywhere): k-of-n multisig script.</li>
<li><code>sortedmulti(k,KEY_1,KEY_2,...,KEY_n)</code> (anywhere): k-of-n multisig script with keys sorted lexicographically in the resulting script.</li>
<li><code>addr(ADDR)</code> (top level only): the script which ADDR expands to.</li>
<li><code>raw(HEX)</code> (top level only): the script whose hex encoding is HEX.</li>
</ul>
<p><code>KEY</code> expressions:</p>
<ul>
<li>Optionally, key origin information, consisting of:
<ul>
<li>An open bracket <code>[</code></li>
<li>Exactly 8 hex characters for the fingerprint of the key where the derivation starts (see BIP32 for details)</li>
<li>Followed by zero or more <code>/NUM</code> or <code>/NUM'</code> path elements to indicate unhardened or hardened derivation steps between the fingerprint and the key or xpub/xprv root that follows</li>
<li>A closing bracket <code>]</code></li>
</ul></li>
<li>Followed by the actual key, which is either:
<ul>
<li>Hex encoded public keys (either 66 characters starting with <code>02</code> or <code>03</code> for a compressed pubkey, or 130 characters starting with <code>04</code> for an uncompressed pubkey).
<ul>
<li>Inside <code>wpkh</code> and <code>wsh</code>, only compressed public keys are permitted.</li>
</ul></li>
<li><a href="https://en.bitcoin.it/wiki/Wallet_import_format">WIF</a> encoded private keys may be specified instead of the corresponding public key, with the same meaning.</li>
<li><code>xpub</code> encoded extended public key or <code>xprv</code> encoded extended private key (as defined in <a href="https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki">BIP 32</a>).
<ul>
<li>Followed by zero or more <code>/NUM</code> unhardened and <code>/NUM'</code> hardened BIP32 derivation steps.</li>
<li>Optionally followed by a single <code>/*</code> or <code>/*'</code> final step to denote all (direct) unhardened or hardened children.</li>
<li>The usage of hardened derivation steps requires providing the private key.</li>
</ul></li>
</ul></li>
</ul>
<p>(Anywhere a <code>'</code> suffix is permitted to denote hardened derivation, the suffix <code>h</code> can be used instead.)</p>
<p><code>ADDR</code> expressions are any type of supported address:</p>
<ul>
<li>P2PKH addresses (base58, of the form <code>1...</code> for mainnet or <code>[nm]...</code> for testnet). Note that P2PKH addresses in descriptors cannot be used for P2PK outputs (use the <code>pk</code> function instead).</li>
<li>P2SH addresses (base58, of the form <code>3...</code> for mainnet or <code>2...</code> for testnet, defined in <a href="https://github.com/bitcoin/bips/blob/master/bip-0013.mediawiki">BIP 13</a>).</li>
<li>Segwit addresses (bech32, of the form <code>bc1...</code> for mainnet or <code>tb1...</code> for testnet, defined in <a href="https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki">BIP 173</a>).</li>
</ul>
<h2 id="explanation">Explanation</h2>
<h3 id="single-key-scripts">Single-key scripts</h3>
<p>Many single-key constructions are used in practice, generally including P2PK, P2PKH, P2WPKH, and P2SH-P2WPKH. Many more combinations are imaginable, though they may not be optimal: P2SH-P2PK, P2SH-P2PKH, P2WSH-P2PK, P2WSH-P2PKH, P2SH-P2WSH-P2PK, P2SH-P2WSH-P2PKH.</p>
<p>To describe these, we model these as functions. The functions <code>pk</code> (P2PK), <code>pkh</code> (P2PKH) and <code>wpkh</code> (P2WPKH) take as input a <code>KEY</code> expression, and return the corresponding <em>scriptPubKey</em>. The functions <code>sh</code> (P2SH) and <code>wsh</code> (P2WSH) take as input a <code>SCRIPT</code> expression, and return the script describing P2SH and P2WSH outputs with the input as embedded script. The names of the functions do not contain "p2" for brevity.</p>
<h3 id="multisig">Multisig</h3>
<p>Several pieces of software use multi-signature (multisig) scripts based on Bitcoin's OP_CHECKMULTISIG opcode. To support these, we introduce the <code>multi(k,key_1,key_2,...,key_n)</code> and <code>sortedmulti(k,key_1,key_2,...,key_n)</code> functions. They represent a <em>k-of-n</em> multisig policy, where any <em>k</em> out of the <em>n</em> provided <code>KEY</code> expressions must sign.</p>
<p>Key order is significant for <code>multi()</code>. A <code>multi()</code> expression describes a multisig script with keys in the specified order, and in a search for TXOs, it will not match outputs with multisig scriptPubKeys that have the same keys in a different order. Also, to prevent a combinatorial explosion of the search space, if more than one of the <code>multi()</code> key arguments is a BIP32 wildcard path ending in <code>/*</code> or <code>*'</code>, the <code>multi()</code> expression only matches multisig scripts with the <code>i</code>th child key from each wildcard path in lockstep, rather than scripts with any combination of child keys from each wildcard path.</p>
<p>Key order does not matter for <code>sortedmulti()</code>. <code>sortedmulti()</code> behaves in the same way as <code>multi()</code> does but the keys are reordered in the resulting script such that they are lexicographically ordered as described in BIP67.</p>
<h3 id="bip32-derived-keys-and-chains">BIP32 derived keys and chains</h3>
<p>Most modern wallet software and hardware uses keys that are derived using BIP32 ("HD keys"). We support these directly by permitting strings consisting of an extended public key (commonly referred to as an <em>xpub</em>) plus derivation path anywhere a public key is expected. The derivation path consists of a sequence of 0 or more integers (in the range <em>0..2<sup>31</sup>-1</em>) each optionally followed by <code>'</code> or <code>h</code>, and separated by <code>/</code> characters. The string may optionally end with the literal <code>/*</code> or <code>/*'</code> (or <code>/*h</code>) to refer to all unhardened or hardened child keys in a configurable range (by default <code>0-1000</code>, inclusive).</p>
<p>Whenever a public key is described using a hardened derivation step, the script cannot be computed without access to the corresponding private key.</p>
<h3 id="key-origin-identification">Key origin identification</h3>
<p>In order to describe scripts whose signing keys reside on another device, it may be necessary to identify the master key and derivation path an xpub was derived with.</p>
<p>For example, when following BIP44, it would be useful to describe a change chain directly as <code>xpub.../44'/0'/0'/1/*</code> where <code>xpub...</code> corresponds with the master key <code>m</code>. Unfortunately, since there are hardened derivation steps that follow the xpub, this descriptor does not let you compute scripts without access to the corresponding private keys. Instead, it should be written as <code>xpub.../1/*</code>, where xpub corresponds to <code>m/44'/0'/0'</code>.</p>
<p>When interacting with a hardware device, it may be necessary to include the entire path from the master down. <a href="https://github.com/bitcoin/bips/blob/master/bip-0174.mediawiki">BIP174</a> standardizes this by providing the master key <em>fingerprint</em> (first 32 bit of the Hash160 of the master pubkey), plus all derivation steps. To support constructing these, we permit providing this key origin information inside the descriptor language, even though it does not affect the actual scriptPubKeys it refers to.</p>
<p>Every public key can be prefixed by an 8-character hexadecimal fingerprint plus optional derivation steps (hardened and unhardened) surrounded by brackets, identifying the master and derivation path the key or xpub that follows was derived with.</p>
<p>Note that the fingerprint of the parent only serves as a fast way to detect parent and child nodes in software, and software must be willing to deal with collisions.</p>
<h3 id="including-private-keys">Including private keys</h3>
<p>Often it is useful to communicate a description of scripts along with the necessary private keys. For this reason, anywhere a public key or xpub is supported, a private key in WIF format or xprv may be provided instead. This is useful when private keys are necessary for hardened derivation steps, or for dumping wallet descriptors including private key material.</p>
<h3 id="compatibility-with-old-wallets">Compatibility with old wallets</h3>
<p>In order to easily represent the sets of scripts currently supported by existing Bitcoin Core wallets, a convenience function <code>combo</code> is provided, which takes as input a public key, and describes a set of P2PK, P2PKH, P2WPKH, and P2SH-P2WPH scripts for that key. In case the key is uncompressed, the set only includes P2PK and P2PKH scripts.</p>
<h3 id="checksums">Checksums</h3>
<p>Descriptors can optionally be suffixed with a checksum to protect against typos or copy-paste errors.</p>
<p>These checksums consist of 8 alphanumeric characters. As long as errors are restricted to substituting characters in <code>0123456789()[],'/*abcdefgh@:$%{}</code> for others in that set and changes in letter case, up to 4 errors will always be detected in descriptors up to 501 characters, and up to 3 errors in longer ones. For larger numbers of errors, or other types of errors, there is a roughly 1 in a trillion chance of not detecting the errors.</p>
<h1 id="all-rpcs-in-bitcoin-core-will-include-the-checksum-in-their-output-only-certain-rpcs-require-checksums-on-input-including-deriveaddress-and-importmulti-the-checksum-for-a-descriptor-without-one-can-be-computed-using-the-getdescriptorinfo-rpc-developer-notes">All RPCs in Bitcoin Core will include the checksum in their output. Only certain RPCs require checksums on input, including <code>deriveaddress</code> and <code>importmulti</code>. The checksum for a descriptor without one can be computed using the <code>getdescriptorinfo</code> RPC. Developer Notes</h1>
<!-- markdown-toc start -->

<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="#developer-notes">Developer Notes</a>
<ul>
<li><a href="#coding-style-general">Coding Style (General)</a></li>
<li><a href="#coding-style-c">Coding Style (C++)</a></li>
<li><a href="#coding-style-python">Coding Style (Python)</a></li>
<li><a href="#coding-style-doxygen-compatible-comments">Coding Style (Doxygen-compatible comments)</a>
<ul>
<li><a href="#generating-documentation">Generating Documentation</a></li>
</ul></li>
<li><a href="#development-tips-and-tricks">Development tips and tricks</a>
<ul>
<li><a href="#compiling-for-debugging">Compiling for debugging</a></li>
<li><a href="#compiling-for-gprof-profiling">Compiling for gprof profiling</a></li>
<li><a href="#debuglog"><code>debug.log</code></a></li>
<li><a href="#testnet-and-regtest-modes">Testnet and Regtest modes</a></li>
<li><a href="#debug_lockorder">DEBUG_LOCKORDER</a></li>
<li><a href="#valgrind-suppressions-file">Valgrind suppressions file</a></li>
<li><a href="#compiling-for-test-coverage">Compiling for test coverage</a></li>
<li><a href="#performance-profiling-with-perf">Performance profiling with perf</a></li>
<li><a href="#sanitizers">Sanitizers</a></li>
</ul></li>
<li><a href="#lockingmutex-usage-notes">Locking/mutex usage notes</a></li>
<li><a href="#threads">Threads</a></li>
<li><a href="#ignoring-ideeditor-files">Ignoring IDE/editor files</a></li>
</ul></li>
<li><a href="#development-guidelines">Development guidelines</a>
<ul>
<li><a href="#general-bitcoin-core">General Bitcoin Core</a></li>
<li><a href="#wallet">Wallet</a></li>
<li><a href="#general-c">General C++</a></li>
<li><a href="#c-data-structures">C++ data structures</a></li>
<li><a href="#strings-and-formatting">Strings and formatting</a></li>
<li><a href="#shadowing">Shadowing</a></li>
<li><a href="#threads-and-synchronization">Threads and synchronization</a></li>
<li><a href="#scripts">Scripts</a>
<ul>
<li><a href="#shebang">Shebang</a></li>
</ul></li>
<li><a href="#source-code-organization">Source code organization</a></li>
<li><a href="#gui">GUI</a></li>
<li><a href="#subtrees">Subtrees</a></li>
<li><a href="#upgrading-leveldb">Upgrading LevelDB</a>
<ul>
<li><a href="#file-descriptor-counts">File Descriptor Counts</a></li>
<li><a href="#consensus-compatibility">Consensus Compatibility</a></li>
</ul></li>
<li><a href="#scripted-diffs">Scripted diffs</a>
<ul>
<li><a href="#suggestions-and-examples">Suggestions and examples</a></li>
</ul></li>
<li><a href="#release-notes">Release notes</a></li>
<li><a href="#rpc-interface-guidelines">RPC interface guidelines</a></li>
<li><a href="#internal-interface-guidelines">Internal interface guidelines</a></li>
</ul></li>
</ul>
<!-- markdown-toc end -->

<h2 id="coding-style-general">Coding Style (General)</h2>
<p>Various coding styles have been used during the history of the codebase, and the result is not very consistent. However, we're now trying to converge to a single style, which is specified below. When writing patches, favor the new style over attempting to mimic the surrounding style, except for move-only commits.</p>
<p>Do not submit patches solely to modify the style of existing code.</p>
<h2 id="coding-style-c">Coding Style (C++)</h2>
<ul>
<li><p><strong>Indentation and whitespace rules</strong> as specified in <a href="/src/.clang-format">src/.clang-format</a>. You can use the provided <a href="/contrib/devtools/README.html#clang-format-diffpy">clang-format-diff script</a> tool to clean up patches automatically before submission.</p>
<ul>
<li>Braces on new lines for classes, functions, methods.</li>
<li>Braces on the same line for everything else.</li>
<li>4 space indentation (no tabs) for every block except namespaces.</li>
<li>No indentation for <code>public</code>/<code>protected</code>/<code>private</code> or for <code>namespace</code>.</li>
<li>No extra spaces inside parenthesis; don't do <code>( this )</code>.</li>
<li>No space after function names; one space after <code>if</code>, <code>for</code> and <code>while</code>.</li>
<li>If an <code>if</code> only has a single-statement <code>then</code>-clause, it can appear on the same line as the <code>if</code>, without braces. In every other case, braces are required, and the <code>then</code> and <code>else</code> clauses must appear correctly indented on a new line.</li>
</ul></li>
<li><p><strong>Symbol naming conventions</strong>. These are preferred in new code, but are not required when doing so would need changes to significant pieces of existing code.</p>
<ul>
<li>Variable (including function arguments) and namespace names are all lowercase and may use <code>_</code> to separate words (snake_case).
<ul>
<li>Class member variables have a <code>m_</code> prefix.</li>
<li>Global variables have a <code>g_</code> prefix.</li>
</ul></li>
<li>Compile-time constant names are all uppercase, and use <code>_</code> to separate words.</li>
<li>Class names, function names, and method names are UpperCamelCase (PascalCase). Do not prefix class names with <code>C</code>.</li>
<li>Test suite naming convention: The Boost test suite in file <code>src/test/foo_tests.cpp</code> should be named <code>foo_tests</code>. Test suite names must be unique.</li>
</ul></li>
<li><p><strong>Miscellaneous</strong></p>
<ul>
<li><code>++i</code> is preferred over <code>i++</code>.</li>
<li><code>nullptr</code> is preferred over <code>NULL</code> or <code>(void*)0</code>.</li>
<li><code>static_assert</code> is preferred over <code>assert</code> where possible. Generally; compile-time checking is preferred over run-time checking.</li>
</ul></li>
</ul>
<p>Block style example:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode c++"><code class="sourceCode cpp"><a class="sourceLine" id="cb78-1" title="1"><span class="dt">int</span> <span class="va">g_count</span> = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb78-2" title="2"></a>
<a class="sourceLine" id="cb78-3" title="3"><span class="kw">namespace</span> foo {</a>
<a class="sourceLine" id="cb78-4" title="4"><span class="kw">class</span> Class</a>
<a class="sourceLine" id="cb78-5" title="5">{</a>
<a class="sourceLine" id="cb78-6" title="6">    <span class="bu">std::</span>string <span class="va">m_name</span>;</a>
<a class="sourceLine" id="cb78-7" title="7"></a>
<a class="sourceLine" id="cb78-8" title="8"><span class="kw">public</span>:</a>
<a class="sourceLine" id="cb78-9" title="9">    <span class="dt">bool</span> Function(<span class="at">const</span> <span class="bu">std::</span>string&amp; s, <span class="dt">int</span> n)</a>
<a class="sourceLine" id="cb78-10" title="10">    {</a>
<a class="sourceLine" id="cb78-11" title="11">        <span class="co">// Comment summarising what this section of code does</span></a>
<a class="sourceLine" id="cb78-12" title="12">        <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; n; ++i) {</a>
<a class="sourceLine" id="cb78-13" title="13">            <span class="dt">int</span> total_sum = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb78-14" title="14">            <span class="co">// When something fails, return early</span></a>
<a class="sourceLine" id="cb78-15" title="15">            <span class="cf">if</span> (!Something()) <span class="cf">return</span> <span class="kw">false</span>;</a>
<a class="sourceLine" id="cb78-16" title="16">            ...</a>
<a class="sourceLine" id="cb78-17" title="17">            <span class="cf">if</span> (SomethingElse(i)) {</a>
<a class="sourceLine" id="cb78-18" title="18">                total_sum += ComputeSomething(<span class="va">g_count</span>);</a>
<a class="sourceLine" id="cb78-19" title="19">            } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb78-20" title="20">                DoSomething(<span class="va">m_name</span>, total_sum);</a>
<a class="sourceLine" id="cb78-21" title="21">            }</a>
<a class="sourceLine" id="cb78-22" title="22">        }</a>
<a class="sourceLine" id="cb78-23" title="23"></a>
<a class="sourceLine" id="cb78-24" title="24">        <span class="co">// Success return is usually at the end</span></a>
<a class="sourceLine" id="cb78-25" title="25">        <span class="cf">return</span> <span class="kw">true</span>;</a>
<a class="sourceLine" id="cb78-26" title="26">    }</a>
<a class="sourceLine" id="cb78-27" title="27">}</a>
<a class="sourceLine" id="cb78-28" title="28">} <span class="co">// namespace foo</span></a></code></pre></div>
<h2 id="coding-style-python">Coding Style (Python)</h2>
<p>Refer to <a href="/test/functional/README.html#style-guidelines">/test/functional/README.html#style-guidelines</a>.</p>
<h2 id="coding-style-doxygen-compatible-comments">Coding Style (Doxygen-compatible comments)</h2>
<p>Bitcoin Core uses <a href="http://www.doxygen.nl/">Doxygen</a> to generate its official documentation.</p>
<p>Use Doxygen-compatible comment blocks for functions, methods, and fields.</p>
<p>For example, to describe a function use:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode c++"><code class="sourceCode cpp"><a class="sourceLine" id="cb79-1" title="1"><span class="co">/**</span></a>
<a class="sourceLine" id="cb79-2" title="2"><span class="co"> * ... Description ...</span></a>
<a class="sourceLine" id="cb79-3" title="3"><span class="co"> *</span></a>
<a class="sourceLine" id="cb79-4" title="4"><span class="co"> * </span><span class="an">@param[in]</span><span class="co">  </span><span class="cv">arg1</span><span class="co"> input description...</span></a>
<a class="sourceLine" id="cb79-5" title="5"><span class="co"> * </span><span class="an">@param[in]</span><span class="co">  </span><span class="cv">arg2</span><span class="co"> input description...</span></a>
<a class="sourceLine" id="cb79-6" title="6"><span class="co"> * </span><span class="an">@param[out]</span><span class="co"> </span><span class="cv">arg3</span><span class="co"> output description...</span></a>
<a class="sourceLine" id="cb79-7" title="7"><span class="co"> * </span><span class="an">@return</span><span class="co"> Return cases...</span></a>
<a class="sourceLine" id="cb79-8" title="8"><span class="co"> * </span><span class="an">@throws</span><span class="co"> </span><span class="cv">Error</span><span class="co"> type and cases...</span></a>
<a class="sourceLine" id="cb79-9" title="9"><span class="co"> * </span><span class="an">@pre</span><span class="co">  Pre-condition for function...</span></a>
<a class="sourceLine" id="cb79-10" title="10"><span class="co"> * </span><span class="an">@post</span><span class="co"> Post-condition for function...</span></a>
<a class="sourceLine" id="cb79-11" title="11"><span class="co"> */</span></a>
<a class="sourceLine" id="cb79-12" title="12"><span class="dt">bool</span> function(<span class="dt">int</span> arg1, <span class="at">const</span> <span class="dt">char</span> *arg2, <span class="bu">std::</span>string&amp; arg3)</a></code></pre></div>
<p>A complete list of <code>@xxx</code> commands can be found at <a href="http://www.doxygen.nl/manual/commands.html">http://www.doxygen.nl/manual/commands.html</a>. As Doxygen recognizes the comments by the delimiters (<code>/**</code> and <code>*/</code> in this case), you don't <em>need</em> to provide any commands for a comment to be valid; just a description text is fine.</p>
<p>To describe a class, use the same construct above the class definition:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode c++"><code class="sourceCode cpp"><a class="sourceLine" id="cb80-1" title="1"><span class="co">/**</span></a>
<a class="sourceLine" id="cb80-2" title="2"><span class="co"> * Alerts are for notifying old versions if they become too obsolete and</span></a>
<a class="sourceLine" id="cb80-3" title="3"><span class="co"> * need to upgrade. The message is displayed in the status bar.</span></a>
<a class="sourceLine" id="cb80-4" title="4"><span class="co"> * </span><span class="an">@see</span><span class="co"> GetWarnings()</span></a>
<a class="sourceLine" id="cb80-5" title="5"><span class="co"> */</span></a>
<a class="sourceLine" id="cb80-6" title="6"><span class="kw">class</span> CAlert</a></code></pre></div>
<p>To describe a member or variable use:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode c++"><code class="sourceCode cpp"><a class="sourceLine" id="cb81-1" title="1"><span class="co">//! Description before the member</span></a>
<a class="sourceLine" id="cb81-2" title="2"><span class="dt">int</span> var;</a></code></pre></div>
<p>or</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode c++"><code class="sourceCode cpp"><a class="sourceLine" id="cb82-1" title="1"><span class="dt">int</span> var; <span class="co">//!&lt; Description after the member</span></a></code></pre></div>
<p>Also OK:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode c++"><code class="sourceCode cpp"><a class="sourceLine" id="cb83-1" title="1"><span class="co">///</span></a>
<a class="sourceLine" id="cb83-2" title="2"><span class="co">/// ... Description ...</span></a>
<a class="sourceLine" id="cb83-3" title="3"><span class="co">///</span></a>
<a class="sourceLine" id="cb83-4" title="4"><span class="dt">bool</span> function2(<span class="dt">int</span> arg1, <span class="at">const</span> <span class="dt">char</span> *arg2)</a></code></pre></div>
<p>Not picked up by Doxygen:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode c++"><code class="sourceCode cpp"><a class="sourceLine" id="cb84-1" title="1"><span class="co">//</span></a>
<a class="sourceLine" id="cb84-2" title="2"><span class="co">// ... Description ...</span></a>
<a class="sourceLine" id="cb84-3" title="3"><span class="co">//</span></a></code></pre></div>
<p>Also not picked up by Doxygen:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode c++"><code class="sourceCode cpp"><a class="sourceLine" id="cb85-1" title="1"><span class="co">/*</span></a>
<a class="sourceLine" id="cb85-2" title="2"><span class="co"> * ... Description ...</span></a>
<a class="sourceLine" id="cb85-3" title="3"><span class="co"> */</span></a></code></pre></div>
<p>A full list of comment syntaxes picked up by Doxygen can be found at <a href="http://www.doxygen.nl/manual/docblocks.html">http://www.doxygen.nl/manual/docblocks.html</a>, but the above styles are favored.</p>
<p>Recommendations:</p>
<ul>
<li><p>Avoiding duplicating type and input/output information in function descriptions.</p></li>
<li><p>Use backticks (``) to refer to <code>argument</code> names in function and parameter descriptions.</p></li>
<li><p>Backticks aren't required when referring to functions Doxygen already knows about; it will build hyperlinks for these automatically. See <a href="http://www.doxygen.nl/manual/autolink.html">http://www.doxygen.nl/manual/autolink.html</a> for complete info.</p></li>
<li><p>Avoid linking to external documentation; links can break.</p></li>
<li><p>Javadoc and all valid Doxygen comments are stripped from Doxygen source code previews (<code>STRIP_CODE_COMMENTS = YES</code> in <a href="doc/Doxyfile.in">Doxyfile.in</a>). If you want a comment to be preserved, it must instead use <code>//</code> or <code>/* */</code>.</p></li>
</ul>
<h3 id="generating-documentation">Generating Documentation</h3>
<p>The documentation can be generated with <code>make docs</code> and cleaned up with <code>make clean-docs</code>. The resulting files are located in <code>doc/doxygen/html</code>; open <code>index.html</code> in that directory to view the homepage.</p>
<p>Before running <code>make docs</code>, you'll need to install these dependencies:</p>
<p>Linux: <code>sudo apt install doxygen graphviz</code></p>
<p>MacOS: <code>brew install doxygen graphviz</code></p>
<h2 id="development-tips-and-tricks">Development tips and tricks</h2>
<h3 id="compiling-for-debugging">Compiling for debugging</h3>
<p>Run configure with <code>--enable-debug</code> to add additional compiler flags that produce better debugging builds.</p>
<h3 id="compiling-for-gprof-profiling">Compiling for gprof profiling</h3>
<p>Run configure with the <code>--enable-gprof</code> option, then make.</p>
<h3 id="debuglog"><code>debug.log</code></h3>
<p>If the code is behaving strangely, take a look in the <code>debug.log</code> file in the data directory; error and debugging messages are written there.</p>
<p>The <code>-debug=...</code> command-line option controls debugging; running with just <code>-debug</code> or <code>-debug=1</code> will turn on all categories (and give you a very large <code>debug.log</code> file).</p>
<p>The Qt code routes <code>qDebug()</code> output to <code>debug.log</code> under category "qt": run with <code>-debug=qt</code> to see it.</p>
<h3 id="testnet-and-regtest-modes">Testnet and Regtest modes</h3>
<p>Run with the <code>-testnet</code> option to run with "play bitcoins" on the test network, if you are testing multi-machine code that needs to operate across the internet.</p>
<p>If you are testing something that can run on one machine, run with the <code>-regtest</code> option. In regression test mode, blocks can be created on-demand; see <a href="/test/functional">test/functional/</a> for tests that run in <code>-regtest</code> mode.</p>
<h3 id="debug_lockorder">DEBUG_LOCKORDER</h3>
<p>Bitcoin Core is a multi-threaded application, and deadlocks or other multi-threading bugs can be very difficult to track down. The <code>--enable-debug</code> configure option adds <code>-DDEBUG_LOCKORDER</code> to the compiler flags. This inserts run-time checks to keep track of which locks are held and adds warnings to the <code>debug.log</code> file if inconsistencies are detected.</p>
<h3 id="valgrind-suppressions-file">Valgrind suppressions file</h3>
<p>Valgrind is a programming tool for memory debugging, memory leak detection, and profiling. The repo contains a Valgrind suppressions file (<a href="https://github.com/bitcoin/bitcoin/blob/master/contrib/valgrind.supp"><code>valgrind.supp</code></a>) which includes known Valgrind warnings in our dependencies that cannot be fixed in-tree. Example use:</p>
<pre class="shell"><code>$ valgrind --suppressions=contrib/valgrind.supp src/test/test_bitcoin
$ valgrind --suppressions=contrib/valgrind.supp --leak-check=full \
      --show-leak-kinds=all src/test/test_bitcoin --log_level=test_suite
$ valgrind -v --leak-check=full src/bitcoind -printtoconsole
$ ./test/functional/test_runner.py --valgrind
</code></pre>
<h3 id="compiling-for-test-coverage">Compiling for test coverage</h3>
<p>LCOV can be used to generate a test coverage report based upon <code>make check</code> execution. LCOV must be installed on your system (e.g. the <code>lcov</code> package on Debian/Ubuntu).</p>
<p>To enable LCOV report generation during test runs:</p>
<pre class="shell"><code>./configure --enable-lcov
make
make cov

# A coverage report will now be accessible at `./test_bitcoin.coverage/index.html`.
</code></pre>
<h3 id="performance-profiling-with-perf">Performance profiling with perf</h3>
<p>Profiling is a good way to get a precise idea of where time is being spent in code. One tool for doing profiling on Linux platforms is called <a href="http://www.brendangregg.com/perf.html"><code>perf</code></a>, and has been integrated into the functional test framework. Perf can observe a running process and sample (at some frequency) where its execution is.</p>
<p>Perf installation is contingent on which kernel version you're running; see <a href="https://askubuntu.com/questions/50145/how-to-install-perf-monitoring-tool">this thread</a> for specific instructions.</p>
<p>Certain kernel parameters may need to be set for perf to be able to inspect the running process's stack.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb88-1" title="1">$ <span class="fu">sudo</span> sysctl -w kernel.perf_event_paranoid=-1</a>
<a class="sourceLine" id="cb88-2" title="2">$ <span class="fu">sudo</span> sysctl -w kernel.kptr_restrict=0</a></code></pre></div>
<p>Make sure you <a href="https://lwn.net/Articles/420403/">understand the security trade-offs</a> of setting these kernel parameters.</p>
<p>To profile a running bitcoind process for 60 seconds, you could use an invocation of <code>perf record</code> like this:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb89-1" title="1">$ <span class="ex">perf</span> record \</a>
<a class="sourceLine" id="cb89-2" title="2">    -g --call-graph dwarf --per-thread -F 140 \</a>
<a class="sourceLine" id="cb89-3" title="3">    -p <span class="kw">`</span><span class="ex">pgrep</span> bitcoind<span class="kw">`</span> -- sleep 60</a></code></pre></div>
<p>You could then analyze the results by running:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb90-1" title="1"><span class="ex">perf</span> report --stdio <span class="kw">|</span> <span class="ex">c++filt</span> <span class="kw">|</span> <span class="fu">less</span></a></code></pre></div>
<p>or using a graphical tool like <a href="https://github.com/KDAB/hotspot">Hotspot</a>.</p>
<p>See the functional test documentation for how to invoke perf within tests.</p>
<h3 id="sanitizers">Sanitizers</h3>
<p>Bitcoin Core can be compiled with various "sanitizers" enabled, which add instrumentation for issues regarding things like memory safety, thread race conditions, or undefined behavior. This is controlled with the <code>--with-sanitizers</code> configure flag, which should be a comma separated list of sanitizers to enable. The sanitizer list should correspond to supported <code>-fsanitize=</code> options in your compiler. These sanitizers have runtime overhead, so they are most useful when testing changes or producing debugging builds.</p>
<p>Some examples:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb91-1" title="1"><span class="co"># Enable both the address sanitizer and the undefined behavior sanitizer</span></a>
<a class="sourceLine" id="cb91-2" title="2"><span class="ex">./configure</span> --with-sanitizers=address,undefined</a>
<a class="sourceLine" id="cb91-3" title="3"></a>
<a class="sourceLine" id="cb91-4" title="4"><span class="co"># Enable the thread sanitizer</span></a>
<a class="sourceLine" id="cb91-5" title="5"><span class="ex">./configure</span> --with-sanitizers=thread</a></code></pre></div>
<p>If you are compiling with GCC you will typically need to install corresponding "san" libraries to actually compile with these flags, e.g. libasan for the address sanitizer, libtsan for the thread sanitizer, and libubsan for the undefined sanitizer. If you are missing required libraries, the configure script will fail with a linker error when testing the sanitizer flags.</p>
<p>The test suite should pass cleanly with the <code>thread</code> and <code>undefined</code> sanitizers, but there are a number of known problems when using the <code>address</code> sanitizer. The address sanitizer is known to fail in <a href="/src/crypto/sha256_sse4.cpp">sha256_sse4::Transform</a> which makes it unusable unless you also use <code>--disable-asm</code> when running configure. We would like to fix sanitizer issues, so please send pull requests if you can fix any errors found by the address sanitizer (or any other sanitizer).</p>
<p>Not all sanitizer options can be enabled at the same time, e.g. trying to build with <code>--with-sanitizers=address,thread</code> will fail in the configure script as these sanitizers are mutually incompatible. Refer to your compiler manual to learn more about these options and which sanitizers are supported by your compiler.</p>
<p>Additional resources:</p>
<ul>
<li><a href="https://clang.llvm.org/docs/AddressSanitizer.html">AddressSanitizer</a></li>
<li><a href="https://clang.llvm.org/docs/LeakSanitizer.html">LeakSanitizer</a></li>
<li><a href="https://clang.llvm.org/docs/MemorySanitizer.html">MemorySanitizer</a></li>
<li><a href="https://clang.llvm.org/docs/ThreadSanitizer.html">ThreadSanitizer</a></li>
<li><a href="https://clang.llvm.org/docs/UndefinedBehaviorSanitizer.html">UndefinedBehaviorSanitizer</a></li>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc/Instrumentation-Options.html">GCC Instrumentation Options</a></li>
<li><a href="https://github.com/google/sanitizers/wiki">Google Sanitizers Wiki</a></li>
<li><a href="https://github.com/bitcoin/bitcoin/issues/12691">Issue #12691: Enable -fsanitize flags in Travis</a></li>
</ul>
<h2 id="lockingmutex-usage-notes">Locking/mutex usage notes</h2>
<p>The code is multi-threaded and uses mutexes and the <code>LOCK</code> and <code>TRY_LOCK</code> macros to protect data structures.</p>
<p>Deadlocks due to inconsistent lock ordering (thread 1 locks <code>cs_main</code> and then <code>cs_wallet</code>, while thread 2 locks them in the opposite order: result, deadlock as each waits for the other to release its lock) are a problem. Compile with <code>-DDEBUG_LOCKORDER</code> (or use <code>--enable-debug</code>) to get lock order inconsistencies reported in the <code>debug.log</code> file.</p>
<p>Re-architecting the core code so there are better-defined interfaces between the various components is a goal, with any necessary locking done by the components (e.g. see the self-contained <code>FillableSigningProvider</code> class and its <code>cs_KeyStore</code> lock for example).</p>
<h2 id="threads">Threads</h2>
<ul>
<li><p><a href="https://doxygen.bitcoincore.org/bitcoind_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">Main thread (<code>bitcoind</code>)</a> : Started from <code>main()</code> in <code>bitcoind.cpp</code>. Responsible for starting up and shutting down the application.</p></li>
<li><p><a href="https://doxygen.bitcoincore.org/init_8cpp.html#ae9e290a0e829ec0198518de2eda579d1">ThreadImport (<code>b-loadblk</code>)</a> : Loads blocks from <code>blk*.dat</code> files or <code>-loadblock=&lt;file&gt;</code> on startup.</p></li>
<li><p><a href="https://doxygen.bitcoincore.org/validation_8cpp.html#a925a33e7952a157922b0bbb8dab29a20">ThreadScriptCheck (<code>b-scriptch.x</code>)</a> : Parallel script validation threads for transactions in blocks.</p></li>
<li><p><a href="https://doxygen.bitcoincore.org/httpserver_8cpp.html#abb9f6ea8819672bd9a62d3695070709c">ThreadHTTP (<code>b-http</code>)</a> : Libevent thread to listen for RPC and REST connections.</p></li>
<li><p><a href="https://doxygen.bitcoincore.org/httpserver_8cpp.html#aa6a7bc27265043bc0193220c5ae3a55f">HTTP worker threads(<code>b-httpworker.x</code>)</a> : Threads to service RPC and REST requests.</p></li>
<li><p><a href="https://doxygen.bitcoincore.org/class_base_index.html#a96a7407421fbf877509248bbe64f8d87">Indexer threads (<code>b-txindex</code>, etc)</a> : One thread per indexer.</p></li>
<li><p><a href="https://doxygen.bitcoincore.org/class_c_scheduler.html#a14d2800815da93577858ea078aed1fba">SchedulerThread (<code>b-scheduler</code>)</a> : Does asynchronous background tasks like dumping wallet contents, dumping addrman and running asynchronous validationinterface callbacks.</p></li>
<li><p><a href="https://doxygen.bitcoincore.org/torcontrol_8cpp.html#a4faed3692d57a0d7bdbecf3b37f72de0">TorControlThread (<code>b-torcontrol</code>)</a> : Libevent thread for tor connections.</p></li>
<li><p>Net threads:</p>
<ul>
<li><p><a href="https://doxygen.bitcoincore.org/class_c_connman.html#aacdbb7148575a31bb33bc345e2bf22a9">ThreadMessageHandler (<code>b-msghand</code>)</a> : Application level message handling (sending and receiving). Almost all net_processing and validation logic runs on this thread.</p></li>
<li><p><a href="https://doxygen.bitcoincore.org/class_c_connman.html#aa7c6970ed98a4a7bafbc071d24897d13">ThreadDNSAddressSeed (<code>b-dnsseed</code>)</a> : Loads addresses of peers from the DNS.</p></li>
<li><p><a href="https://doxygen.bitcoincore.org/net_8cpp.html#a63f82a71c4169290c2db1651a9bbe249">ThreadMapPort (<code>b-upnp</code>)</a> : Universal plug-and-play startup/shutdown.</p></li>
<li><p><a href="https://doxygen.bitcoincore.org/class_c_connman.html#a765597cbfe99c083d8fa3d61bb464e34">ThreadSocketHandler (<code>b-net</code>)</a> : Sends/Receives data from peers on port 8333.</p></li>
<li><p><a href="https://doxygen.bitcoincore.org/class_c_connman.html#a0b787caf95e52a346a2b31a580d60a62">ThreadOpenAddedConnections (<code>b-addcon</code>)</a> : Opens network connections to added nodes.</p></li>
<li><p><a href="https://doxygen.bitcoincore.org/class_c_connman.html#a55e9feafc3bab78e5c9d408c207faa45">ThreadOpenConnections (<code>b-opencon</code>)</a> : Initiates new connections to peers.</p></li>
</ul></li>
</ul>
<h2 id="ignoring-ideeditor-files">Ignoring IDE/editor files</h2>
<p>In closed-source environments in which everyone uses the same IDE, it is common to add temporary files it produces to the project-wide <code>.gitignore</code> file.</p>
<p>However, in open source software such as Bitcoin Core, where everyone uses their own editors/IDE/tools, it is less common. Only you know what files your editor produces and this may change from version to version. The canonical way to do this is thus to create your local gitignore. Add this to <code>~/.gitconfig</code>:</p>
<pre><code>[core]
        excludesfile = /home/.../.gitignore_global
</code></pre>
<p>(alternatively, type the command <code>git config --global core.excludesfile ~/.gitignore_global</code> on a terminal)</p>
<p>Then put your favourite tool's temporary filenames in that file, e.g.</p>
<pre><code># NetBeans
nbproject/
</code></pre>
<p>Another option is to create a per-repository excludes file <code>.git/info/exclude</code>. These are not committed but apply only to one repository.</p>
<p>If a set of tools is used by the build system or scripts the repository (for example, lcov) it is perfectly acceptable to add its files to <code>.gitignore</code> and commit them.</p>
<h1 id="development-guidelines">Development guidelines</h1>
<p>A few non-style-related recommendations for developers, as well as points to pay attention to for reviewers of Bitcoin Core code.</p>
<h2 id="general-bitcoin-core">General Bitcoin Core</h2>
<ul>
<li><p>New features should be exposed on RPC first, then can be made available in the GUI.</p>
<ul>
<li><em>Rationale</em>: RPC allows for better automatic testing. The test suite for the GUI is very limited.</li>
</ul></li>
<li><p>Make sure pull requests pass Travis CI before merging.</p>
<ul>
<li><p><em>Rationale</em>: Makes sure that they pass thorough testing, and that the tester will keep passing on the master branch. Otherwise, all new pull requests will start failing the tests, resulting in confusion and mayhem.</p></li>
<li><p><em>Explanation</em>: If the test suite is to be updated for a change, this has to be done first.</p></li>
</ul></li>
</ul>
<h2 id="wallet-1">Wallet</h2>
<ul>
<li><p>Make sure that no crashes happen with run-time option <code>-disablewallet</code>.</p></li>
<li><p>Include <code>db_cxx.h</code> (BerkeleyDB header) only when <code>ENABLE_WALLET</code> is set.</p>
<ul>
<li><em>Rationale</em>: Otherwise compilation of the disable-wallet build will fail in environments without BerkeleyDB.</li>
</ul></li>
</ul>
<h2 id="general-c">General C++</h2>
<p>For general C++ guidelines, you may refer to the <a href="https://isocpp.github.io/CppCoreGuidelines/">C++ Core Guidelines</a>.</p>
<p>Common misconceptions are clarified in those sections:</p>
<ul>
<li><p>Passing (non-)fundamental types in the <a href="https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rf-conventional">C++ Core Guideline</a>.</p></li>
<li><p>Assertions should not have side-effects.</p>
<ul>
<li><em>Rationale</em>: Even though the source code is set to refuse to compile with assertions disabled, having side-effects in assertions is unexpected and makes the code harder to understand.</li>
</ul></li>
<li><p>If you use the <code>.h</code>, you must link the <code>.cpp</code>.</p>
<ul>
<li><em>Rationale</em>: Include files define the interface for the code in implementation files. Including one but not linking the other is confusing. Please avoid that. Moving functions from the <code>.h</code> to the <code>.cpp</code> should not result in build errors.</li>
</ul></li>
<li><p>Use the RAII (Resource Acquisition Is Initialization) paradigm where possible. For example, by using <code>unique_ptr</code> for allocations in a function.</p>
<ul>
<li><em>Rationale</em>: This avoids memory and resource leaks, and ensures exception safety.</li>
</ul></li>
<li><p>Use <code>MakeUnique()</code> to construct objects owned by <code>unique_ptr</code>s.</p>
<ul>
<li><em>Rationale</em>: <code>MakeUnique</code> is concise and ensures exception safety in complex expressions. <code>MakeUnique</code> is a temporary project local implementation of <code>std::make_unique</code> (C++14).</li>
</ul></li>
</ul>
<h2 id="c-data-structures">C++ data structures</h2>
<ul>
<li><p>Never use the <code>std::map []</code> syntax when reading from a map, but instead use <code>.find()</code>.</p>
<ul>
<li><em>Rationale</em>: <code>[]</code> does an insert (of the default element) if the item doesn't exist in the map yet. This has resulted in memory leaks in the past, as well as race conditions (expecting read-read behavior). Using <code>[]</code> is fine for <em>writing</em> to a map.</li>
</ul></li>
<li><p>Do not compare an iterator from one data structure with an iterator of another data structure (even if of the same type).</p>
<ul>
<li><em>Rationale</em>: Behavior is undefined. In C++ parlor this means "may reformat the universe", in practice this has resulted in at least one hard-to-debug crash bug.</li>
</ul></li>
<li><p>Watch out for out-of-bounds vector access. <code>&amp;vch[vch.size()]</code> is illegal, including <code>&amp;vch[0]</code> for an empty vector. Use <code>vch.data()</code> and <code>vch.data() + vch.size()</code> instead.</p></li>
<li><p>Vector bounds checking is only enabled in debug mode. Do not rely on it.</p></li>
<li><p>Initialize all non-static class members where they are defined. If this is skipped for a good reason (i.e., optimization on the critical path), add an explicit comment about this.</p>
<ul>
<li><em>Rationale</em>: Ensure determinism by avoiding accidental use of uninitialized values. Also, static analyzers balk about this. Initializing the members in the declaration makes it easy to spot uninitialized ones.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb94"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb94-1" title="1"><span class="kw">class</span> A</a>
<a class="sourceLine" id="cb94-2" title="2">{</a>
<a class="sourceLine" id="cb94-3" title="3">    <span class="dt">uint32_t</span> <span class="va">m_count</span>{<span class="dv">0</span>};</a>
<a class="sourceLine" id="cb94-4" title="4">}</a></code></pre></div>
<ul>
<li><p>By default, declare constructors <code>explicit</code>.</p>
<ul>
<li><em>Rationale</em>: This is a precaution to avoid unintended <a href="https://en.cppreference.com/w/cpp/language/converting_constructor">conversions</a>.</li>
</ul></li>
<li><p>Use explicitly signed or unsigned <code>char</code>s, or even better <code>uint8_t</code> and <code>int8_t</code>. Do not use bare <code>char</code> unless it is to pass to a third-party API. This type can be signed or unsigned depending on the architecture, which can lead to interoperability problems or dangerous conditions such as out-of-bounds array accesses.</p></li>
<li><p>Prefer explicit constructions over implicit ones that rely on 'magical' C++ behavior.</p>
<ul>
<li><em>Rationale</em>: Easier to understand what is happening, thus easier to spot mistakes, even for those that are not language lawyers.</li>
</ul></li>
<li><p>Use <code>Span</code> as function argument when it can operate on any range-like container.</p>
<ul>
<li><em>Rationale</em>: Compared to <code>Foo(const vector&lt;int&gt;&amp;)</code> this avoids the need for a (potentially expensive) conversion to vector if the caller happens to have the input stored in another type of container. However, be aware of the pitfalls documented in <a href="../src/span.h">span.h</a>.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb95"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb95-1" title="1"><span class="dt">void</span> Foo(Span&lt;<span class="at">const</span> <span class="dt">int</span>&gt; data);</a>
<a class="sourceLine" id="cb95-2" title="2"></a>
<a class="sourceLine" id="cb95-3" title="3"><span class="bu">std::</span>vector&lt;<span class="dt">int</span>&gt; vec{<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>};</a>
<a class="sourceLine" id="cb95-4" title="4">Foo(vec);</a></code></pre></div>
<ul>
<li><p>Prefer <code>enum class</code> (scoped enumerations) over <code>enum</code> (traditional enumerations) where possible.</p>
<ul>
<li><em>Rationale</em>: Scoped enumerations avoid two potential pitfalls/problems with traditional C++ enumerations: implicit conversions to <code>int</code>, and name clashes due to enumerators being exported to the surrounding scope.</li>
</ul></li>
<li><p><code>switch</code> statement on an enumeration example:</p></li>
</ul>
<div class="sourceCode" id="cb96"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb96-1" title="1"><span class="kw">enum</span> <span class="kw">class</span> Tabs {</a>
<a class="sourceLine" id="cb96-2" title="2">    INFO,</a>
<a class="sourceLine" id="cb96-3" title="3">    CONSOLE,</a>
<a class="sourceLine" id="cb96-4" title="4">    GRAPH,</a>
<a class="sourceLine" id="cb96-5" title="5">    PEERS</a>
<a class="sourceLine" id="cb96-6" title="6">};</a>
<a class="sourceLine" id="cb96-7" title="7"></a>
<a class="sourceLine" id="cb96-8" title="8"><span class="dt">int</span> GetInt(Tabs tab)</a>
<a class="sourceLine" id="cb96-9" title="9">{</a>
<a class="sourceLine" id="cb96-10" title="10">    <span class="cf">switch</span> (tab) {</a>
<a class="sourceLine" id="cb96-11" title="11">    <span class="cf">case</span> Tabs::INFO: <span class="cf">return</span> <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb96-12" title="12">    <span class="cf">case</span> Tabs::CONSOLE: <span class="cf">return</span> <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb96-13" title="13">    <span class="cf">case</span> Tabs::GRAPH: <span class="cf">return</span> <span class="dv">2</span>;</a>
<a class="sourceLine" id="cb96-14" title="14">    <span class="cf">case</span> Tabs::PEERS: <span class="cf">return</span> <span class="dv">3</span>;</a>
<a class="sourceLine" id="cb96-15" title="15">    } <span class="co">// no default case, so the compiler can warn about missing cases</span></a>
<a class="sourceLine" id="cb96-16" title="16">    <span class="ot">assert</span>(<span class="kw">false</span>);</a>
<a class="sourceLine" id="cb96-17" title="17">}</a></code></pre></div>
<p><em>Rationale</em>: The comment documents skipping <code>default:</code> label, and it complies with <code>clang-format</code> rules. The assertion prevents firing of <code>-Wreturn-type</code> warning on some compilers.</p>
<h2 id="strings-and-formatting">Strings and formatting</h2>
<ul>
<li><p>Be careful of <code>LogPrint</code> versus <code>LogPrintf</code>. <code>LogPrint</code> takes a <code>category</code> argument, <code>LogPrintf</code> does not.</p>
<ul>
<li><em>Rationale</em>: Confusion of these can result in runtime exceptions due to formatting mismatch, and it is easy to get wrong because of subtly similar naming.</li>
</ul></li>
<li><p>Use <code>std::string</code>, avoid C string manipulation functions.</p>
<ul>
<li><em>Rationale</em>: C++ string handling is marginally safer, less scope for buffer overflows, and surprises with <code>\0</code> characters. Also, some C string manipulations tend to act differently depending on platform, or even the user locale.</li>
</ul></li>
<li><p>Use <code>ParseInt32</code>, <code>ParseInt64</code>, <code>ParseUInt32</code>, <code>ParseUInt64</code>, <code>ParseDouble</code> from <code>utilstrencodings.h</code> for number parsing.</p>
<ul>
<li><em>Rationale</em>: These functions do overflow checking and avoid pesky locale issues.</li>
</ul></li>
<li><p>Avoid using locale dependent functions if possible. You can use the provided <a href="/test/lint/lint-locale-dependence.sh"><code>lint-locale-dependence.sh</code></a> to check for accidental use of locale dependent functions.</p>
<ul>
<li><p><em>Rationale</em>: Unnecessary locale dependence can cause bugs that are very tricky to isolate and fix.</p></li>
<li><p>These functions are known to be locale dependent: <code>alphasort</code>, <code>asctime</code>, <code>asprintf</code>, <code>atof</code>, <code>atoi</code>, <code>atol</code>, <code>atoll</code>, <code>atoq</code>, <code>btowc</code>, <code>ctime</code>, <code>dprintf</code>, <code>fgetwc</code>, <code>fgetws</code>, <code>fprintf</code>, <code>fputwc</code>, <code>fputws</code>, <code>fscanf</code>, <code>fwprintf</code>, <code>getdate</code>, <code>getwc</code>, <code>getwchar</code>, <code>isalnum</code>, <code>isalpha</code>, <code>isblank</code>, <code>iscntrl</code>, <code>isdigit</code>, <code>isgraph</code>, <code>islower</code>, <code>isprint</code>, <code>ispunct</code>, <code>isspace</code>, <code>isupper</code>, <code>iswalnum</code>, <code>iswalpha</code>, <code>iswblank</code>, <code>iswcntrl</code>, <code>iswctype</code>, <code>iswdigit</code>, <code>iswgraph</code>, <code>iswlower</code>, <code>iswprint</code>, <code>iswpunct</code>, <code>iswspace</code>, <code>iswupper</code>, <code>iswxdigit</code>, <code>isxdigit</code>, <code>mblen</code>, <code>mbrlen</code>, <code>mbrtowc</code>, <code>mbsinit</code>, <code>mbsnrtowcs</code>, <code>mbsrtowcs</code>, <code>mbstowcs</code>, <code>mbtowc</code>, <code>mktime</code>, <code>putwc</code>, <code>putwchar</code>, <code>scanf</code>, <code>snprintf</code>, <code>sprintf</code>, <code>sscanf</code>, <code>stoi</code>, <code>stol</code>, <code>stoll</code>, <code>strcasecmp</code>, <code>strcasestr</code>, <code>strcoll</code>, <code>strfmon</code>, <code>strftime</code>, <code>strncasecmp</code>, <code>strptime</code>, <code>strtod</code>, <code>strtof</code>, <code>strtoimax</code>, <code>strtol</code>, <code>strtold</code>, <code>strtoll</code>, <code>strtoq</code>, <code>strtoul</code>, <code>strtoull</code>, <code>strtoumax</code>, <code>strtouq</code>, <code>strxfrm</code>, <code>swprintf</code>, <code>tolower</code>, <code>toupper</code>, <code>towctrans</code>, <code>towlower</code>, <code>towupper</code>, <code>ungetwc</code>, <code>vasprintf</code>, <code>vdprintf</code>, <code>versionsort</code>, <code>vfprintf</code>, <code>vfscanf</code>, <code>vfwprintf</code>, <code>vprintf</code>, <code>vscanf</code>, <code>vsnprintf</code>, <code>vsprintf</code>, <code>vsscanf</code>, <code>vswprintf</code>, <code>vwprintf</code>, <code>wcrtomb</code>, <code>wcscasecmp</code>, <code>wcscoll</code>, <code>wcsftime</code>, <code>wcsncasecmp</code>, <code>wcsnrtombs</code>, <code>wcsrtombs</code>, <code>wcstod</code>, <code>wcstof</code>, <code>wcstoimax</code>, <code>wcstol</code>, <code>wcstold</code>, <code>wcstoll</code>, <code>wcstombs</code>, <code>wcstoul</code>, <code>wcstoull</code>, <code>wcstoumax</code>, <code>wcswidth</code>, <code>wcsxfrm</code>, <code>wctob</code>, <code>wctomb</code>, <code>wctrans</code>, <code>wctype</code>, <code>wcwidth</code>, <code>wprintf</code></p></li>
</ul></li>
<li><p>For <code>strprintf</code>, <code>LogPrint</code>, <code>LogPrintf</code> formatting characters don't need size specifiers.</p>
<ul>
<li><em>Rationale</em>: Bitcoin Core uses tinyformat, which is type safe. Leave them out to avoid confusion.</li>
</ul></li>
<li><p>Use <code>.c_str()</code> sparingly. Its only valid use is to pass C++ strings to C functions that take NULL-terminated strings.</p>
<ul>
<li><p>Do not use it when passing a sized array (so along with <code>.size()</code>). Use <code>.data()</code> instead to get a pointer to the raw data.</p>
<ul>
<li><em>Rationale</em>: Although this is guaranteed to be safe starting with C++11, <code>.data()</code> communicates the intent better.</li>
</ul></li>
<li><p>Do not use it when passing strings to <code>tfm::format</code>, <code>strprintf</code>, <code>LogPrint[f]</code>.</p>
<ul>
<li><em>Rationale</em>: This is redundant. Tinyformat handles strings.</li>
</ul></li>
<li><p>Do not use it to convert to <code>QString</code>. Use <code>QString::fromStdString()</code>.</p>
<ul>
<li><em>Rationale</em>: Qt has built-in functionality for converting their string type from/to C++. No need to roll your own.</li>
</ul></li>
<li><p>In cases where do you call <code>.c_str()</code>, you might want to additionally check that the string does not contain embedded '\0' characters, because it will (necessarily) truncate the string. This might be used to hide parts of the string from logging or to circumvent checks. If a use of strings is sensitive to this, take care to check the string for embedded NULL characters first and reject it if there are any (see <code>ParsePrechecks</code> in <code>strencodings.cpp</code> for an example).</p></li>
</ul></li>
</ul>
<h2 id="shadowing">Shadowing</h2>
<p>Although the shadowing warning (<code>-Wshadow</code>) is not enabled by default (it prevents issues arising from using a different variable with the same name), please name variables so that their names do not shadow variables defined in the source code.</p>
<p>When using nested cycles, do not name the inner cycle variable the same as in the upper cycle, etc.</p>
<h2 id="threads-and-synchronization">Threads and synchronization</h2>
<ul>
<li><p>Prefer <code>Mutex</code> type to <code>RecursiveMutex</code> one</p></li>
<li><p>Consistently use <a href="https://clang.llvm.org/docs/ThreadSafetyAnalysis.html">Clang Thread Safety Analysis</a> annotations to get compile-time warnings about potential race conditions in code. Combine annotations in function declarations with run-time asserts in function definitions:</p></li>
</ul>
<div class="sourceCode" id="cb97"><pre class="sourceCode C++"><code class="sourceCode cpp"><a class="sourceLine" id="cb97-1" title="1"><span class="co">// txmempool.h</span></a>
<a class="sourceLine" id="cb97-2" title="2"><span class="kw">class</span> CTxMemPool</a>
<a class="sourceLine" id="cb97-3" title="3">{</a>
<a class="sourceLine" id="cb97-4" title="4"><span class="kw">public</span>:</a>
<a class="sourceLine" id="cb97-5" title="5">    ...</a>
<a class="sourceLine" id="cb97-6" title="6">    <span class="at">mutable</span> RecursiveMutex cs;</a>
<a class="sourceLine" id="cb97-7" title="7">    ...</a>
<a class="sourceLine" id="cb97-8" title="8">    <span class="dt">void</span> UpdateTransactionsFromBlock(...) EXCLUSIVE_LOCKS_REQUIRED(::cs_main, cs);</a>
<a class="sourceLine" id="cb97-9" title="9">    ...</a>
<a class="sourceLine" id="cb97-10" title="10">}</a>
<a class="sourceLine" id="cb97-11" title="11"></a>
<a class="sourceLine" id="cb97-12" title="12"><span class="co">// txmempool.cpp</span></a>
<a class="sourceLine" id="cb97-13" title="13"><span class="dt">void</span> CTxMemPool::UpdateTransactionsFromBlock(...)</a>
<a class="sourceLine" id="cb97-14" title="14">{</a>
<a class="sourceLine" id="cb97-15" title="15">    AssertLockHeld(::cs_main);</a>
<a class="sourceLine" id="cb97-16" title="16">    AssertLockHeld(cs);</a>
<a class="sourceLine" id="cb97-17" title="17">    ...</a>
<a class="sourceLine" id="cb97-18" title="18">}</a></code></pre></div>
<div class="sourceCode" id="cb98"><pre class="sourceCode C++"><code class="sourceCode cpp"><a class="sourceLine" id="cb98-1" title="1"><span class="co">// validation.h</span></a>
<a class="sourceLine" id="cb98-2" title="2"><span class="kw">class</span> ChainstateManager</a>
<a class="sourceLine" id="cb98-3" title="3">{</a>
<a class="sourceLine" id="cb98-4" title="4"><span class="kw">public</span>:</a>
<a class="sourceLine" id="cb98-5" title="5">    ...</a>
<a class="sourceLine" id="cb98-6" title="6">    <span class="dt">bool</span> ProcessNewBlock(...) EXCLUSIVE_LOCKS_REQUIRED(!::cs_main);</a>
<a class="sourceLine" id="cb98-7" title="7">    ...</a>
<a class="sourceLine" id="cb98-8" title="8">}</a>
<a class="sourceLine" id="cb98-9" title="9"></a>
<a class="sourceLine" id="cb98-10" title="10"><span class="co">// validation.cpp</span></a>
<a class="sourceLine" id="cb98-11" title="11"><span class="dt">bool</span> ChainstateManager::ProcessNewBlock(...)</a>
<a class="sourceLine" id="cb98-12" title="12">{</a>
<a class="sourceLine" id="cb98-13" title="13">    AssertLockNotHeld(::cs_main);</a>
<a class="sourceLine" id="cb98-14" title="14">    ...</a>
<a class="sourceLine" id="cb98-15" title="15">    LOCK(::cs_main);</a>
<a class="sourceLine" id="cb98-16" title="16">    ...</a>
<a class="sourceLine" id="cb98-17" title="17">}</a></code></pre></div>
<ul>
<li><p>Build and run tests with <code>-DDEBUG_LOCKORDER</code> to verify that no potential deadlocks are introduced. As of 0.12, this is defined by default when configuring with <code>--enable-debug</code>.</p></li>
<li><p>When using <code>LOCK</code>/<code>TRY_LOCK</code> be aware that the lock exists in the context of the current scope, so surround the statement and the code that needs the lock with braces.</p>
<p>OK:</p></li>
</ul>
<div class="sourceCode" id="cb99"><pre class="sourceCode c++"><code class="sourceCode cpp"><a class="sourceLine" id="cb99-1" title="1">{</a>
<a class="sourceLine" id="cb99-2" title="2">    TRY_LOCK(cs_vNodes, lockNodes);</a>
<a class="sourceLine" id="cb99-3" title="3">    ...</a>
<a class="sourceLine" id="cb99-4" title="4">}</a></code></pre></div>
<p>Wrong:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode c++"><code class="sourceCode cpp"><a class="sourceLine" id="cb100-1" title="1">TRY_LOCK(cs_vNodes, lockNodes);</a>
<a class="sourceLine" id="cb100-2" title="2">{</a>
<a class="sourceLine" id="cb100-3" title="3">    ...</a>
<a class="sourceLine" id="cb100-4" title="4">}</a></code></pre></div>
<h2 id="scripts">Scripts</h2>
<h3 id="shebang">Shebang</h3>
<ul>
<li><p>Use <code>#!/usr/bin/env bash</code> instead of obsolete <code>#!/bin/bash</code>.</p>
<ul>
<li><p><a href="https://github.com/dylanaraps/pure-bash-bible#shebang"><em>Rationale</em></a>:</p>
<p><code>#!/bin/bash</code> assumes it is always installed to /bin/ which can cause issues;</p>
<p><code>#!/usr/bin/env bash</code> searches the user's PATH to find the bash binary.</p></li>
</ul>
<p>OK:</p></li>
</ul>
<div class="sourceCode" id="cb101"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb101-1" title="1"><span class="co">#!/usr/bin/env bash</span></a></code></pre></div>
<p>Wrong:</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb102-1" title="1"><span class="co">#!/bin/bash</span></a></code></pre></div>
<h2 id="source-code-organization">Source code organization</h2>
<ul>
<li><p>Implementation code should go into the <code>.cpp</code> file and not the <code>.h</code>, unless necessary due to template usage or when performance due to inlining is critical.</p>
<ul>
<li><em>Rationale</em>: Shorter and simpler header files are easier to read and reduce compile time.</li>
</ul></li>
<li><p>Use only the lowercase alphanumerics (<code>a-z0-9</code>), underscore (<code>_</code>) and hyphen (<code>-</code>) in source code filenames.</p>
<ul>
<li><em>Rationale</em>: <code>grep</code>:ing and auto-completing filenames is easier when using a consistent naming pattern. Potential problems when building on case-insensitive filesystems are avoided when using only lowercase characters in source code filenames.</li>
</ul></li>
<li><p>Every <code>.cpp</code> and <code>.h</code> file should <code>#include</code> every header file it directly uses classes, functions or other definitions from, even if those headers are already included indirectly through other headers.</p>
<ul>
<li><em>Rationale</em>: Excluding headers because they are already indirectly included results in compilation failures when those indirect dependencies change. Furthermore, it obscures what the real code dependencies are.</li>
</ul></li>
<li><p>Don't import anything into the global namespace (<code>using namespace ...</code>). Use fully specified types such as <code>std::string</code>.</p>
<ul>
<li><em>Rationale</em>: Avoids symbol conflicts.</li>
</ul></li>
<li><p>Terminate namespaces with a comment (<code>// namespace mynamespace</code>). The comment should be placed on the same line as the brace closing the namespace, e.g.</p></li>
</ul>
<div class="sourceCode" id="cb103"><pre class="sourceCode c++"><code class="sourceCode cpp"><a class="sourceLine" id="cb103-1" title="1"><span class="kw">namespace</span> mynamespace {</a>
<a class="sourceLine" id="cb103-2" title="2">...</a>
<a class="sourceLine" id="cb103-3" title="3">} <span class="co">// namespace mynamespace</span></a>
<a class="sourceLine" id="cb103-4" title="4"></a>
<a class="sourceLine" id="cb103-5" title="5"><span class="kw">namespace</span> {</a>
<a class="sourceLine" id="cb103-6" title="6">...</a>
<a class="sourceLine" id="cb103-7" title="7">} <span class="co">// namespace</span></a></code></pre></div>
<ul>
<li><p><em>Rationale</em>: Avoids confusion about the namespace context.</p></li>
<li><p>Use <code>#include &lt;primitives/transaction.h&gt;</code> bracket syntax instead of <code>#include "primitives/transactions.h"</code> quote syntax.</p>
<ul>
<li><em>Rationale</em>: Bracket syntax is less ambiguous because the preprocessor searches a fixed list of include directories without taking location of the source file into account. This allows quoted includes to stand out more when the location of the source file actually is relevant.</li>
</ul></li>
<li><p>Use include guards to avoid the problem of double inclusion. The header file <code>foo/bar.h</code> should use the include guard identifier <code>BITCOIN_FOO_BAR_H</code>, e.g.</p></li>
</ul>
<div class="sourceCode" id="cb104"><pre class="sourceCode c++"><code class="sourceCode cpp"><a class="sourceLine" id="cb104-1" title="1"><span class="pp">#ifndef BITCOIN_FOO_BAR_H</span></a>
<a class="sourceLine" id="cb104-2" title="2"><span class="pp">#define B</span>ITCOIN_FOO_BAR_H</a>
<a class="sourceLine" id="cb104-3" title="3">...</a>
<a class="sourceLine" id="cb104-4" title="4"><span class="pp">#endif </span><span class="co">// BITCOIN_FOO_BAR_H</span></a></code></pre></div>
<h2 id="gui">GUI</h2>
<ul>
<li><p>Do not display or manipulate dialogs in model code (classes <code>*Model</code>).</p>
<ul>
<li><em>Rationale</em>: Model classes pass through events and data from the core, they should not interact with the user. That's where View classes come in. The converse also holds: try to not directly access core data structures from Views.</li>
</ul></li>
<li><p>Avoid adding slow or blocking code in the GUI thread. In particular, do not add new <code>interfaces::Node</code> and <code>interfaces::Wallet</code> method calls, even if they may be fast now, in case they are changed to lock or communicate across processes in the future.</p>
<p>Prefer to offload work from the GUI thread to worker threads (see <code>RPCExecutor</code> in console code as an example) or take other steps (see <a href="https://doc.qt.io/archives/qq/qq27-responsive-guis.html">https://doc.qt.io/archives/qq/qq27-responsive-guis.html</a>) to keep the GUI responsive.</p>
<ul>
<li><em>Rationale</em>: Blocking the GUI thread can increase latency, and lead to hangs and deadlocks.</li>
</ul></li>
</ul>
<h2 id="subtrees">Subtrees</h2>
<p>Several parts of the repository are subtrees of software maintained elsewhere.</p>
<p>Some of these are maintained by active developers of Bitcoin Core, in which case changes should probably go directly upstream without being PRed directly against the project. They will be merged back in the next subtree merge.</p>
<p>Others are external projects without a tight relationship with our project. Changes to these should also be sent upstream, but bugfixes may also be prudent to PR against Bitcoin Core so that they can be integrated quickly. Cosmetic changes should be purely taken upstream.</p>
<p>There is a tool in <code>test/lint/git-subtree-check.sh</code> (<a href="../test/lint#git-subtree-checksh">instructions</a>) to check a subtree directory for consistency with its upstream repository.</p>
<p>Current subtrees include:</p>
<ul>
<li><p>src/leveldb</p>
<ul>
<li>Upstream at <a href="https://github.com/google/leveldb">https://github.com/google/leveldb</a> ; Maintained by Google, but open important PRs to Core to avoid delay.</li>
<li><strong>Note</strong>: Follow the instructions in <a href="#upgrading-leveldb">Upgrading LevelDB</a> when merging upstream changes to the LevelDB subtree.</li>
</ul></li>
<li><p>src/crc32c</p>
<ul>
<li>Used by leveldb for hardware acceleration of CRC32C checksums for data integrity.</li>
<li>Upstream at <a href="https://github.com/google/crc32c">https://github.com/google/crc32c</a> ; Maintained by Google.</li>
</ul></li>
<li><p>src/secp256k1</p>
<ul>
<li>Upstream at <a href="https://github.com/bitcoin-core/secp256k1/">https://github.com/bitcoin-core/secp256k1/</a> ; actively maintained by Core contributors.</li>
</ul></li>
<li><p>src/crypto/ctaes</p>
<ul>
<li>Upstream at <a href="https://github.com/bitcoin-core/ctaes">https://github.com/bitcoin-core/ctaes</a> ; actively maintained by Core contributors.</li>
</ul></li>
<li><p>src/univalue</p>
<ul>
<li>Upstream at <a href="https://github.com/bitcoin-core/univalue">https://github.com/bitcoin-core/univalue</a> ; actively maintained by Core contributors, deviates from upstream <a href="https://github.com/jgarzik/univalue">https://github.com/jgarzik/univalue</a></li>
</ul></li>
</ul>
<h2 id="upgrading-leveldb">Upgrading LevelDB</h2>
<p>Extra care must be taken when upgrading LevelDB. This section explains issues you must be aware of.</p>
<h3 id="file-descriptor-counts">File Descriptor Counts</h3>
<p>In most configurations, we use the default LevelDB value for <code>max_open_files</code>, which is 1000 at the time of this writing. If LevelDB actually uses this many file descriptors, it will cause problems with Bitcoin's <code>select()</code> loop, because it may cause new sockets to be created where the fd value is &gt;= 1024. For this reason, on 64-bit Unix systems, we rely on an internal LevelDB optimization that uses <code>mmap()</code> + <code>close()</code> to open table files without actually retaining references to the table file descriptors. If you are upgrading LevelDB, you must sanity check the changes to make sure that this assumption remains valid.</p>
<p>In addition to reviewing the upstream changes in <code>env_posix.cc</code>, you can use <code>lsof</code> to check this. For example, on Linux this command will show open <code>.ldb</code> file counts:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb105-1" title="1">$ <span class="ex">lsof</span> -p <span class="va">$(</span><span class="fu">pidof</span> bitcoind<span class="va">)</span> <span class="kw">|\</span></a>
<a class="sourceLine" id="cb105-2" title="2">    <span class="fu">awk</span> <span class="st">&#39;BEGIN { fd=0; mem=0; } /ldb$/ { if ($4 == &quot;mem&quot;) mem++; else fd++ } END { printf &quot;mem = %s, fd = %s\n&quot;, mem, fd}&#39;</span></a>
<a class="sourceLine" id="cb105-3" title="3"><span class="ex">mem</span> = 119, fd = 0</a></code></pre></div>
<p>The <code>mem</code> value shows how many files are mmap'ed, and the <code>fd</code> value shows you many file descriptors these files are using. You should check that <code>fd</code> is a small number (usually 0 on 64-bit hosts).</p>
<p>See the notes in the <code>SetMaxOpenFiles()</code> function in <code>dbwrapper.cc</code> for more details.</p>
<h3 id="consensus-compatibility">Consensus Compatibility</h3>
<p>It is possible for LevelDB changes to inadvertently change consensus compatibility between nodes. This happened in Bitcoin 0.8 (when LevelDB was first introduced). When upgrading LevelDB, you should review the upstream changes to check for issues affecting consensus compatibility.</p>
<p>For example, if LevelDB had a bug that accidentally prevented a key from being returned in an edge case, and that bug was fixed upstream, the bug "fix" would be an incompatible consensus change. In this situation, the correct behavior would be to revert the upstream fix before applying the updates to Bitcoin's copy of LevelDB. In general, you should be wary of any upstream changes affecting what data is returned from LevelDB queries.</p>
<h2 id="scripted-diffs">Scripted diffs</h2>
<p>For reformatting and refactoring commits where the changes can be easily automated using a bash script, we use scripted-diff commits. The bash script is included in the commit message and our Travis CI job checks that the result of the script is identical to the commit. This aids reviewers since they can verify that the script does exactly what it is supposed to do. It is also helpful for rebasing (since the same script can just be re-run on the new master commit).</p>
<p>To create a scripted-diff:</p>
<ul>
<li>start the commit message with <code>scripted-diff:</code> (and then a description of the diff on the same line)</li>
<li>in the commit message include the bash script between lines containing just the following text:
<ul>
<li><code>-BEGIN VERIFY SCRIPT-</code></li>
<li><code>-END VERIFY SCRIPT-</code></li>
</ul></li>
</ul>
<p>The scripted-diff is verified by the tool <code>test/lint/commit-script-check.sh</code>. The tool's default behavior, when supplied with a commit is to verify all scripted-diffs from the beginning of time up to said commit. Internally, the tool passes the first supplied argument to <code>git rev-list --reverse</code> to determine which commits to verify script-diffs for, ignoring commits that don't conform to the commit message format described above.</p>
<p>For development, it might be more convenient to verify all scripted-diffs in a range <code>A..B</code>, for example:</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb106-1" title="1"><span class="ex">test/lint/commit-script-check.sh</span> origin/master..HEAD</a></code></pre></div>
<h3 id="suggestions-and-examples">Suggestions and examples</h3>
<p>If you need to replace in multiple files, prefer <code>git ls-files</code> to <code>find</code> or globbing, and <code>git grep</code> to <code>grep</code>, to avoid changing files that are not under version control.</p>
<p>For efficient replacement scripts, reduce the selection to the files that potentially need to be modified, so for example, instead of a blanket <code>git ls-files src | xargs sed -i s/apple/orange/</code>, use <code>git grep -l apple src | xargs sed -i s/apple/orange/</code>.</p>
<p>Also, it is good to keep the selection of files as specific as possible — for example, replace only in directories where you expect replacements — because it reduces the risk that a rebase of your commit by re-running the script will introduce accidental changes.</p>
<p>Some good examples of scripted-diff:</p>
<ul>
<li><p><a href="https://github.com/bitcoin/bitcoin/commit/301bd41a2e6765b185bd55f4c541f9e27aeea29d">scripted-diff: Rename InitInterfaces to NodeContext</a> uses an elegant script to replace occurrences of multiple terms in all source files.</p></li>
<li><p><a href="https://github.com/bitcoin/bitcoin/commit/8922d7f6b751a3e6b3b9f6fb7961c442877fb65a">scripted-diff: Remove g_connman, g_banman globals</a> replaces specific terms in a list of specific source files.</p></li>
<li><p><a href="https://github.com/bitcoin/bitcoin/commit/fac03ec43a15ad547161e37e53ea82482cc508f9">scripted-diff: Replace fprintf with tfm::format</a> does a global replacement but excludes certain directories.</p></li>
</ul>
<p>To find all previous uses of scripted diffs in the repository, do:</p>
<pre><code>git log --grep=&quot;-BEGIN VERIFY SCRIPT-&quot;
</code></pre>
<h2 id="release-notes">Release notes</h2>
<p>Release notes should be written for any PR that:</p>
<ul>
<li>introduces a notable new feature</li>
<li>fixes a significant bug</li>
<li>changes an API or configuration model</li>
<li>makes any other visible change to the end-user experience.</li>
</ul>
<p>Release notes should be added to a PR-specific release note file at <code>/doc/release-notes-&lt;PR number&gt;.html</code> to avoid conflicts between multiple PRs. All <code>release-notes*</code> files are merged into a single <a href="/doc/release-notes.html">/doc/release-notes.html</a> file prior to the release.</p>
<h2 id="rpc-interface-guidelines">RPC interface guidelines</h2>
<p>A few guidelines for introducing and reviewing new RPC interfaces:</p>
<ul>
<li><p>Method naming: use consecutive lower-case names such as <code>getrawtransaction</code> and <code>submitblock</code>.</p>
<ul>
<li><em>Rationale</em>: Consistency with the existing interface.</li>
</ul></li>
<li><p>Argument naming: use snake case <code>fee_delta</code> (and not, e.g. camel case <code>feeDelta</code>)</p>
<ul>
<li><em>Rationale</em>: Consistency with the existing interface.</li>
</ul></li>
<li><p>Use the JSON parser for parsing, don't manually parse integers or strings from arguments unless absolutely necessary.</p>
<ul>
<li><p><em>Rationale</em>: Introduces hand-rolled string manipulation code at both the caller and callee sites, which is error-prone, and it is easy to get things such as escaping wrong. JSON already supports nested data structures, no need to re-invent the wheel.</p></li>
<li><p><em>Exception</em>: AmountFromValue can parse amounts as string. This was introduced because many JSON parsers and formatters hard-code handling decimal numbers as floating-point values, resulting in potential loss of precision. This is unacceptable for monetary values. <strong>Always</strong> use <code>AmountFromValue</code> and <code>ValueFromAmount</code> when inputting or outputting monetary values. The only exceptions to this are <code>prioritisetransaction</code> and <code>getblocktemplate</code> because their interface is specified as-is in BIP22.</p></li>
</ul></li>
<li><p>Missing arguments and 'null' should be treated the same: as default values. If there is no default value, both cases should fail in the same way. The easiest way to follow this guideline is to detect unspecified arguments with <code>params[x].isNull()</code> instead of <code>params.size() &lt;= x</code>. The former returns true if the argument is either null or missing, while the latter returns true if is missing, and false if it is null.</p>
<ul>
<li><em>Rationale</em>: Avoids surprises when switching to name-based arguments. Missing name-based arguments are passed as 'null'.</li>
</ul></li>
<li><p>Try not to overload methods on argument type. E.g. don't make <code>getblock(true)</code> and <code>getblock("hash")</code> do different things.</p>
<ul>
<li><p><em>Rationale</em>: This is impossible to use with <code>bitcoin-cli</code>, and can be surprising to users.</p></li>
<li><p><em>Exception</em>: Some RPC calls can take both an <code>int</code> and <code>bool</code>, most notably when a bool was switched to a multi-value, or due to other historical reasons. <strong>Always</strong> have false map to 0 and true to 1 in this case.</p></li>
</ul></li>
<li><p>Don't forget to fill in the argument names correctly in the RPC command table.</p>
<ul>
<li><em>Rationale</em>: If not, the call can not be used with name-based arguments.</li>
</ul></li>
<li><p>Set okSafeMode in the RPC command table to a sensible value: safe mode is when the blockchain is regarded to be in a confused state, and the client deems it unsafe to do anything irreversible such as send. Anything that just queries should be permitted.</p>
<ul>
<li><em>Rationale</em>: Troubleshooting a node in safe mode is difficult if half the RPCs don't work.</li>
</ul></li>
<li><p>Add every non-string RPC argument <code>(method, idx, name)</code> to the table <code>vRPCConvertParams</code> in <code>rpc/client.cpp</code>.</p>
<ul>
<li><em>Rationale</em>: <code>bitcoin-cli</code> and the GUI debug console use this table to determine how to convert a plaintext command line to JSON. If the types don't match, the method can be unusable from there.</li>
</ul></li>
<li><p>A RPC method must either be a wallet method or a non-wallet method. Do not introduce new methods that differ in behavior based on the presence of a wallet.</p>
<ul>
<li><em>Rationale</em>: As well as complicating the implementation and interfering with the introduction of multi-wallet, wallet and non-wallet code should be separated to avoid introducing circular dependencies between code units.</li>
</ul></li>
<li><p>Try to make the RPC response a JSON object.</p>
<ul>
<li><em>Rationale</em>: If a RPC response is not a JSON object, then it is harder to avoid API breakage if new data in the response is needed.</li>
</ul></li>
<li><p>Wallet RPCs call BlockUntilSyncedToCurrentChain to maintain consistency with <code>getblockchaininfo</code>'s state immediately prior to the call's execution. Wallet RPCs whose behavior does <em>not</em> depend on the current chainstate may omit this call.</p>
<ul>
<li><em>Rationale</em>: In previous versions of Bitcoin Core, the wallet was always in-sync with the chainstate (by virtue of them all being updated in the same cs_main lock). In order to maintain the behavior that wallet RPCs return results as of at least the highest best-known block an RPC client may be aware of prior to entering a wallet RPC call, we must block until the wallet is caught up to the chainstate as of the RPC call's entry. This also makes the API much easier for RPC clients to reason about.</li>
</ul></li>
<li><p>Be aware of RPC method aliases and generally avoid registering the same callback function pointer for different RPCs.</p>
<ul>
<li><p><em>Rationale</em>: RPC methods registered with the same function pointer will be considered aliases and only the first method name will show up in the <code>help</code> RPC command list.</p></li>
<li><p><em>Exception</em>: Using RPC method aliases may be appropriate in cases where a new RPC is replacing a deprecated RPC, to avoid both RPCs confusingly showing up in the command list.</p></li>
</ul></li>
<li><p>Use <em>invalid</em> bech32 addresses (e.g. in the constant array <code>EXAMPLE_ADDRESS</code>) for <code>RPCExamples</code> help documentation.</p>
<ul>
<li><em>Rationale</em>: Prevent accidental transactions by users and encourage the use of bech32 addresses by default.</li>
</ul></li>
<li><p>Use the <code>UNIX_EPOCH_TIME</code> constant when describing UNIX epoch time or timestamps in the documentation.</p>
<ul>
<li><em>Rationale</em>: User-facing consistency.</li>
</ul></li>
</ul>
<h2 id="internal-interface-guidelines">Internal interface guidelines</h2>
<p>Internal interfaces between parts of the codebase that are meant to be independent (node, wallet, GUI), are defined in <a href="../src/interfaces/"><code>src/interfaces/</code></a>. The main interface classes defined there are <a href="../src/interfaces/chain.h"><code>interfaces::Chain</code></a>, used by wallet to access the node's latest chain state, <a href="../src/interfaces/node.h"><code>interfaces::Node</code></a>, used by the GUI to control the node, and <a href="../src/interfaces/wallet.h"><code>interfaces::Wallet</code></a>, used by the GUI to control an individual wallet. There are also more specialized interface types like <a href="../src/interfaces/handler.h"><code>interfaces::Handler</code></a> <a href="../src/interfaces/chain.h"><code>interfaces::ChainClient</code></a> passed to and from various interface methods.</p>
<p>Interface classes are written in a particular style so node, wallet, and GUI code doesn't need to run in the same process, and so the class declarations work more easily with tools and libraries supporting interprocess communication:</p>
<ul>
<li><p>Interface classes should be abstract and have methods that are <a href="https://en.cppreference.com/w/cpp/language/abstract_class">pure virtual</a>. This allows multiple implementations to inherit from the same interface class, particularly so one implementation can execute functionality in the local process, and other implementations can forward calls to remote processes.</p></li>
<li><p>Interface method definitions should wrap existing functionality instead of implementing new functionality. Any substantial new node or wallet functionality should be implemented in <a href="../src/node/"><code>src/node/</code></a> or <a href="../src/wallet/"><code>src/wallet/</code></a> and just exposed in <a href="../src/interfaces/"><code>src/interfaces/</code></a> instead of being implemented there, so it can be more modular and accessible to unit tests.</p></li>
<li><p>Interface method parameter and return types should either be serializable or be other interface classes. Interface methods shouldn't pass references to objects that can't be serialized or accessed from another process.</p>
<p>Examples:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode c++"><code class="sourceCode cpp"><a class="sourceLine" id="cb108-1" title="1"><span class="co">// Good: takes string argument and returns interface class pointer</span></a>
<a class="sourceLine" id="cb108-2" title="2"><span class="kw">virtual</span> unique_ptr&lt;interfaces::Wallet&gt; loadWallet(<span class="bu">std::</span>string filename) = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb108-3" title="3"></a>
<a class="sourceLine" id="cb108-4" title="4"><span class="co">// Bad: returns CWallet reference that can&#39;t be used from another process</span></a>
<a class="sourceLine" id="cb108-5" title="5"><span class="kw">virtual</span> CWallet&amp; loadWallet(<span class="bu">std::</span>string filename) = <span class="dv">0</span>;</a></code></pre></div>
<div class="sourceCode" id="cb109"><pre class="sourceCode c++"><code class="sourceCode cpp"><a class="sourceLine" id="cb109-1" title="1"><span class="co">// Good: accepts and returns primitive types</span></a>
<a class="sourceLine" id="cb109-2" title="2"><span class="kw">virtual</span> <span class="dt">bool</span> findBlock(<span class="at">const</span> uint256&amp; hash, <span class="dt">int</span>&amp; out_height, <span class="dt">int64_t</span>&amp; out_time) = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb109-3" title="3"></a>
<a class="sourceLine" id="cb109-4" title="4"><span class="co">// Bad: returns pointer to internal node in a linked list inaccessible to</span></a>
<a class="sourceLine" id="cb109-5" title="5"><span class="co">// other processes</span></a>
<a class="sourceLine" id="cb109-6" title="6"><span class="kw">virtual</span> <span class="at">const</span> CBlockIndex* findBlock(<span class="at">const</span> uint256&amp; hash) = <span class="dv">0</span>;</a></code></pre></div>
<div class="sourceCode" id="cb110"><pre class="sourceCode c++"><code class="sourceCode cpp"><a class="sourceLine" id="cb110-1" title="1"><span class="co">// Good: takes plain callback type and returns interface pointer</span></a>
<a class="sourceLine" id="cb110-2" title="2"><span class="kw">using</span> TipChangedFn = <span class="bu">std::</span>function&lt;<span class="dt">void</span>(<span class="dt">int</span> block_height, <span class="dt">int64_t</span> block_time)&gt;;</a>
<a class="sourceLine" id="cb110-3" title="3"><span class="kw">virtual</span> <span class="bu">std::</span>unique_ptr&lt;interfaces::Handler&gt; handleTipChanged(TipChangedFn fn) = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb110-4" title="4"></a>
<a class="sourceLine" id="cb110-5" title="5"><span class="co">// Bad: returns boost connection specific to local process</span></a>
<a class="sourceLine" id="cb110-6" title="6"><span class="kw">using</span> TipChangedFn = <span class="bu">std::</span>function&lt;<span class="dt">void</span>(<span class="dt">int</span> block_height, <span class="dt">int64_t</span> block_time)&gt;;</a>
<a class="sourceLine" id="cb110-7" title="7"><span class="kw">virtual</span> <span class="ex">boost::</span>signals2<span class="ex">::</span>scoped_connection connectTipChanged(TipChangedFn fn) = <span class="dv">0</span>;</a></code></pre></div></li>
<li><p>For consistency and friendliness to code generation tools, interface method input and inout parameters should be ordered first and output parameters should come last.</p>
<p>Example:</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode c++"><code class="sourceCode cpp"><a class="sourceLine" id="cb111-1" title="1"><span class="co">// Good: error output param is last</span></a>
<a class="sourceLine" id="cb111-2" title="2"><span class="kw">virtual</span> <span class="dt">bool</span> broadcastTransaction(<span class="at">const</span> CTransactionRef&amp; tx, CAmount max_fee, <span class="bu">std::</span>string&amp; error) = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb111-3" title="3"></a>
<a class="sourceLine" id="cb111-4" title="4"><span class="co">// Bad: error output param is between input params</span></a>
<a class="sourceLine" id="cb111-5" title="5"><span class="kw">virtual</span> <span class="dt">bool</span> broadcastTransaction(<span class="at">const</span> CTransactionRef&amp; tx, <span class="bu">std::</span>string&amp; error, CAmount max_fee) = <span class="dv">0</span>;</a></code></pre></div></li>
<li><p>For friendliness to code generation tools, interface methods should not be overloaded:</p>
<p>Example:</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode c++"><code class="sourceCode cpp"><a class="sourceLine" id="cb112-1" title="1"><span class="co">// Good: method names are unique</span></a>
<a class="sourceLine" id="cb112-2" title="2"><span class="kw">virtual</span> <span class="dt">bool</span> disconnectByAddress(<span class="at">const</span> CNetAddr&amp; net_addr) = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb112-3" title="3"><span class="kw">virtual</span> <span class="dt">bool</span> disconnectById(NodeId id) = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb112-4" title="4"></a>
<a class="sourceLine" id="cb112-5" title="5"><span class="co">// Bad: methods are overloaded by type</span></a>
<a class="sourceLine" id="cb112-6" title="6"><span class="kw">virtual</span> <span class="dt">bool</span> <span class="fu">disconnect</span>(<span class="at">const</span> CNetAddr&amp; net_addr) = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb112-7" title="7"><span class="kw">virtual</span> <span class="dt">bool</span> <span class="fu">disconnect</span>(NodeId id) = <span class="dv">0</span>;</a></code></pre></div></li>
<li><p>For consistency and friendliness to code generation tools, interface method names should be <code>lowerCamelCase</code> and standalone function names should be <code>UpperCamelCase</code>.</p>
<p>Examples:</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode c++"><code class="sourceCode cpp"><a class="sourceLine" id="cb113-1" title="1"><span class="co">// Good: lowerCamelCase method name</span></a>
<a class="sourceLine" id="cb113-2" title="2"><span class="kw">virtual</span> <span class="dt">void</span> blockConnected(<span class="at">const</span> CBlock&amp; block, <span class="dt">int</span> height) = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb113-3" title="3"></a>
<a class="sourceLine" id="cb113-4" title="4"><span class="co">// Bad: uppercase class method</span></a>
<a class="sourceLine" id="cb113-5" title="5"><span class="kw">virtual</span> <span class="dt">void</span> BlockConnected(<span class="at">const</span> CBlock&amp; block, <span class="dt">int</span> height) = <span class="dv">0</span>;</a></code></pre></div>
<div class="sourceCode" id="cb114"><pre class="sourceCode c++"><code class="sourceCode cpp"><a class="sourceLine" id="cb114-1" title="1"><span class="co">// Good: UpperCamelCase standalone function name</span></a>
<a class="sourceLine" id="cb114-2" title="2"><span class="bu">std::</span>unique_ptr&lt;Node&gt; MakeNode(LocalInit&amp; init);</a>
<a class="sourceLine" id="cb114-3" title="3"></a>
<a class="sourceLine" id="cb114-4" title="4"><span class="co">// Bad: lowercase standalone function</span></a>
<a class="sourceLine" id="cb114-5" title="5"><span class="bu">std::</span>unique_ptr&lt;Node&gt; makeNode(LocalInit&amp; init);</a></code></pre></div>
<p>Note: This last convention isn't generally followed outside of <a href="../src/interfaces/"><code>src/interfaces/</code></a>, though it did come up for discussion before in <a href="https://github.com/bitcoin/bitcoin/pull/14635">#14635</a>. Expectations for DNS Seed operators ====================================</p></li>
</ul>
<p>Bitcoin Core attempts to minimize the level of trust in DNS seeds, but DNS seeds still pose a small amount of risk for the network. As such, DNS seeds must be run by entities which have some minimum level of trust within the Bitcoin community.</p>
<p>Other implementations of Bitcoin software may also use the same seeds and may be more exposed. In light of this exposure, this document establishes some basic expectations for operating dnsseeds.</p>
<ol start="0">
<li><p>A DNS seed operating organization or person is expected to follow good host security practices, maintain control of applicable infrastructure, and not sell or transfer control of the DNS seed. Any hosting services contracted by the operator are equally expected to uphold these expectations.</p></li>
<li><p>The DNS seed results must consist exclusively of fairly selected and functioning Bitcoin nodes from the public network to the best of the operator's understanding and capability.</p></li>
<li><p>For the avoidance of doubt, the results may be randomized but must not single-out any group of hosts to receive different results unless due to an urgent technical necessity and disclosed.</p></li>
<li><p>The results may not be served with a DNS TTL of less than one minute.</p></li>
<li><p>Any logging of DNS queries should be only that which is necessary for the operation of the service or urgent health of the Bitcoin network and must not be retained longer than necessary nor disclosed to any third party.</p></li>
<li><p>Information gathered as a result of the operators node-spidering (not from DNS queries) may be freely published or retained, but only if this data was not made more complete by biasing node connectivity (a violation of expectation (1)).</p></li>
<li><p>Operators are encouraged, but not required, to publicly document the details of their operating practices.</p></li>
<li><p>A reachable email contact address must be published for inquiries related to the DNS seed operation.</p></li>
</ol>
<p>If these expectations cannot be satisfied the operator should discontinue providing services and contact the active Bitcoin Core development team as well as posting on <a href="https://lists.linuxfoundation.org/mailman/listinfo/bitcoin-dev">bitcoin-dev</a>.</p>
<p>Behavior outside of these expectations may be reasonable in some situations but should be discussed in public in advance.</p>
<h2 id="see-also">See also</h2>
<ul>
<li><a href="https://github.com/sipa/bitcoin-seeder">bitcoin-seeder</a> is a reference implementation of a DNS seed.</li>
</ul>
<h1 id="bitcoin-core-file-system">Bitcoin Core file system</h1>
<p><strong>Contents</strong></p>
<ul>
<li><p><a href="#data-directory-location">Data directory location</a></p></li>
<li><p><a href="#data-directory-layout">Data directory layout</a></p></li>
<li><p><a href="#multi-wallet-environment">Multi-wallet environment</a></p>
<ul>
<li><p><a href="#berkeley-db-database-based-wallets">Berkeley DB database based wallets</a></p></li>
<li><p><a href="#sqlite-database-based-wallets">SQLite database based wallets</a></p></li>
</ul></li>
<li><p><a href="#gui-settings">GUI settings</a></p></li>
<li><p><a href="#legacy-subdirectories-and-files">Legacy subdirectories and files</a></p></li>
<li><p><a href="#notes">Notes</a></p></li>
</ul>
<h2 id="data-directory-location">Data directory location</h2>
<p>The data directory is the default location where the Bitcoin Core files are stored.</p>
<ol>
<li>The default data directory paths for supported platforms are:</li>
</ol>
<table>
<thead>
<tr class="header">
<th>Platform</th>
<th>Data directory path</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Linux</td>
<td><code>$HOME/.bitcoin/</code></td>
</tr>
<tr class="even">
<td>macOS</td>
<td><code>$HOME/Library/Application Support/Bitcoin/</code></td>
</tr>
<tr class="odd">
<td>Windows</td>
<td><code>%APPDATA%\Bitcoin\</code> <sup><a href="#note1">[1]</a></sup></td>
</tr>
</tbody>
</table>
<ol start="2">
<li><p>A custom data directory path can be specified with the <code>-datadir</code> option.</p></li>
<li><p>All content of the data directory, except for <code>bitcoin.conf</code> file, is chain-specific. This means the actual data directory paths for non-mainnet cases differ:</p></li>
</ol>
<table>
<thead>
<tr class="header">
<th>Chain option</th>
<th>Data directory path</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>-chain=main</code> (default)</td>
<td><em>path_to_datadir</em><code>/</code></td>
</tr>
<tr class="even">
<td><code>-chain=test</code> or <code>-testnet</code></td>
<td><em>path_to_datadir</em><code>/testnet3/</code></td>
</tr>
<tr class="odd">
<td><code>-chain=signet</code> or <code>-signet</code></td>
<td><em>path_to_datadir</em><code>/signet/</code></td>
</tr>
<tr class="even">
<td><code>-chain=regtest</code> or <code>-regtest</code></td>
<td><em>path_to_datadir</em><code>/regtest/</code></td>
</tr>
</tbody>
</table>
<h2 id="data-directory-layout">Data directory layout</h2>
<table>
<thead>
<tr class="header">
<th>Subdirectory</th>
<th>File(s)</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>blocks/</code></td>
<td></td>
<td>Blocks directory; can be specified by <code>-blocksdir</code> option (except for <code>blocks/index/</code>)</td>
</tr>
<tr class="even">
<td><code>blocks/index/</code></td>
<td>LevelDB database</td>
<td>Block index; <code>-blocksdir</code> option does not affect this path</td>
</tr>
<tr class="odd">
<td><code>blocks/</code></td>
<td><code>blkNNNNN.dat</code><sup><a href="#note2">[2]</a></sup></td>
<td>Actual Bitcoin blocks (in network format, dumped in raw on disk, 128 MiB per file)</td>
</tr>
<tr class="even">
<td><code>blocks/</code></td>
<td><code>revNNNNN.dat</code><sup><a href="#note2">[2]</a></sup></td>
<td>Block undo data (custom format)</td>
</tr>
<tr class="odd">
<td><code>chainstate/</code></td>
<td>LevelDB database</td>
<td>Blockchain state (a compact representation of all currently unspent transaction outputs (UTXOs) and metadata about the transactions they are from)</td>
</tr>
<tr class="even">
<td><code>indexes/txindex/</code></td>
<td>LevelDB database</td>
<td>Transaction index; <em>optional</em>, used if <code>-txindex=1</code></td>
</tr>
<tr class="odd">
<td><code>indexes/blockfilter/basic/db/</code></td>
<td>LevelDB database</td>
<td>Blockfilter index LevelDB database for the basic filtertype; <em>optional</em>, used if <code>-blockfilterindex=basic</code></td>
</tr>
<tr class="even">
<td><code>indexes/blockfilter/basic/</code></td>
<td><code>fltrNNNNN.dat</code><sup><a href="#note2">[2]</a></sup></td>
<td>Blockfilter index filters for the basic filtertype; <em>optional</em>, used if <code>-blockfilterindex=basic</code></td>
</tr>
<tr class="odd">
<td><code>wallets/</code></td>
<td></td>
<td><a href="#multi-wallet-environment">Contains wallets</a>; can be specified by <code>-walletdir</code> option; if <code>wallets/</code> subdirectory does not exist, wallets reside in the <a href="#data-directory-location">data directory</a></td>
</tr>
<tr class="even">
<td><code>./</code></td>
<td><code>anchors.dat</code></td>
<td>Anchor IP address database, created on shutdown and deleted at startup. Anchors are last known outgoing block-relay-only peers that are tried to re-connect to on startup</td>
</tr>
<tr class="odd">
<td><code>./</code></td>
<td><code>banlist.dat</code></td>
<td>Stores the IPs/subnets of banned nodes</td>
</tr>
<tr class="even">
<td><code>./</code></td>
<td><code>bitcoin.conf</code></td>
<td>User-defined <a href="bitcoin-conf.html">configuration settings</a> for <code>bitcoind</code> or <code>bitcoin-qt</code>. File is not written to by the software and must be created manually. Path can be specified by <code>-conf</code> option</td>
</tr>
<tr class="odd">
<td><code>./</code></td>
<td><code>bitcoind.pid</code></td>
<td>Stores the process ID (PID) of <code>bitcoind</code> or <code>bitcoin-qt</code> while running; created at start and deleted on shutdown; can be specified by <code>-pid</code> option</td>
</tr>
<tr class="even">
<td><code>./</code></td>
<td><code>debug.log</code></td>
<td>Contains debug information and general logging generated by <code>bitcoind</code> or <code>bitcoin-qt</code>; can be specified by <code>-debuglogfile</code> option</td>
</tr>
<tr class="odd">
<td><code>./</code></td>
<td><code>fee_estimates.dat</code></td>
<td>Stores statistics used to estimate minimum transaction fees and priorities required for confirmation</td>
</tr>
<tr class="even">
<td><code>./</code></td>
<td><code>guisettings.ini.bak</code></td>
<td>Backup of former <a href="#gui-settings">GUI settings</a> after <code>-resetguisettings</code> option is used</td>
</tr>
<tr class="odd">
<td><code>./</code></td>
<td><code>ip_asn.map</code></td>
<td>IP addresses to Autonomous System Numbers (ASNs) mapping used for bucketing of the peers; path can be specified with the <code>-asmap</code> option</td>
</tr>
<tr class="even">
<td><code>./</code></td>
<td><code>mempool.dat</code></td>
<td>Dump of the mempool's transactions</td>
</tr>
<tr class="odd">
<td><code>./</code></td>
<td><code>onion_v3_private_key</code></td>
<td>Cached Tor onion service private key for <code>-listenonion</code> option</td>
</tr>
<tr class="even">
<td><code>./</code></td>
<td><code>peers.dat</code></td>
<td>Peer IP address database (custom format)</td>
</tr>
<tr class="odd">
<td><code>./</code></td>
<td><code>settings.json</code></td>
<td>Read-write settings set through GUI or RPC interfaces, augmenting manual settings from <a href="bitcoin-conf.html">bitcoin.conf</a>. File is created automatically if read-write settings storage is not disabled with <code>-nosettings</code> option. Path can be specified with <code>-settings</code> option</td>
</tr>
<tr class="even">
<td><code>./</code></td>
<td><code>.cookie</code></td>
<td>Session RPC authentication cookie; if used, created at start and deleted on shutdown; can be specified by <code>-rpccookiefile</code> option</td>
</tr>
<tr class="odd">
<td><code>./</code></td>
<td><code>.lock</code></td>
<td>Data directory lock file</td>
</tr>
</tbody>
</table>
<h2 id="multi-wallet-environment">Multi-wallet environment</h2>
<p>Wallets are Berkeley DB (BDB) or SQLite databases.</p>
<ol>
<li><p>Each user-defined wallet named "wallet_name" resides in the <code>wallets/wallet_name/</code> subdirectory.</p></li>
<li><p>The default (unnamed) wallet resides in <code>wallets/</code> subdirectory; if the latter does not exist, the wallet resides in the data directory.</p></li>
<li><p>A wallet database path can be specified with the <code>-wallet</code> option.</p></li>
<li><p><code>wallet.dat</code> files must not be shared across different node instances, as that can result in key-reuse and double-spends due the lack of synchronization between instances.</p></li>
<li><p>Any copy or backup of the wallet should be done through a <code>backupwallet</code> call in order to update and lock the wallet, preventing any file corruption caused by updates during the copy.</p></li>
</ol>
<h3 id="berkeley-db-database-based-wallets">Berkeley DB database based wallets</h3>
<table>
<thead>
<tr class="header">
<th>Subdirectory</th>
<th>File(s)</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>database/</code></td>
<td>BDB logging files</td>
<td>Part of BDB environment; created at start and deleted on shutdown; a user <em>must keep it as safe</em> as personal wallet <code>wallet.dat</code></td>
</tr>
<tr class="even">
<td><code>./</code></td>
<td><code>db.log</code></td>
<td>BDB error file</td>
</tr>
<tr class="odd">
<td><code>./</code></td>
<td><code>wallet.dat</code></td>
<td>Personal wallet (a BDB database) with keys and transactions</td>
</tr>
<tr class="even">
<td><code>./</code></td>
<td><code>.walletlock</code></td>
<td>BDB wallet lock file</td>
</tr>
</tbody>
</table>
<h3 id="sqlite-database-based-wallets">SQLite database based wallets</h3>
<table>
<thead>
<tr class="header">
<th>Subdirectory</th>
<th>File</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>./</code></td>
<td><code>wallet.dat</code></td>
<td>Personal wallet (a SQLite database) with keys and transactions</td>
</tr>
<tr class="even">
<td><code>./</code></td>
<td><code>wallet.dat-journal</code></td>
<td>SQLite Rollback Journal file for <code>wallet.dat</code>. Usually created at start and deleted on shutdown. A user <em>must keep it as safe</em> as the <code>wallet.dat</code> file.</td>
</tr>
</tbody>
</table>
<h2 id="gui-settings">GUI settings</h2>
<p><code>bitcoin-qt</code> uses <a href="https://doc.qt.io/qt-5/qsettings.html"><code>QSettings</code></a> class; this implies platform-specific <a href="https://doc.qt.io/qt-5/qsettings.html#locations-where-application-settings-are-stored">locations where application settings are stored</a>.</p>
<h2 id="legacy-subdirectories-and-files">Legacy subdirectories and files</h2>
<p>These subdirectories and files are no longer used by the Bitcoin Core:</p>
<table>
<thead>
<tr class="header">
<th>Path</th>
<th>Description</th>
<th>Repository notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>blktree/</code></td>
<td>Blockchain index; replaced by <code>blocks/index/</code> in <a href="https://github.com/bitcoin/bitcoin/blob/master/doc/release-notes/release-notes-0.8.0.html#improvements">0.8.0</a></td>
<td><a href="https://github.com/bitcoin/bitcoin/pull/2231">PR #2231</a>, <a href="https://github.com/bitcoin/bitcoin/commit/8fdc94cc8f0341e96b1edb3a5b56811c0b20bd15"><code>8fdc94cc</code></a></td>
</tr>
<tr class="even">
<td><code>coins/</code></td>
<td>Unspent transaction output database; replaced by <code>chainstate/</code> in 0.8.0</td>
<td><a href="https://github.com/bitcoin/bitcoin/pull/2231">PR #2231</a>, <a href="https://github.com/bitcoin/bitcoin/commit/8fdc94cc8f0341e96b1edb3a5b56811c0b20bd15"><code>8fdc94cc</code></a></td>
</tr>
<tr class="odd">
<td><code>blkindex.dat</code></td>
<td>Blockchain index BDB database; replaced by {<code>chainstate/</code>, <code>blocks/index/</code>, <code>blocks/revNNNNN.dat</code><sup><a href="#note2">[2]</a></sup>} in 0.8.0</td>
<td><a href="https://github.com/bitcoin/bitcoin/pull/1677">PR #1677</a></td>
</tr>
<tr class="even">
<td><code>blk000?.dat</code></td>
<td>Block data (custom format, 2 GiB per file); replaced by <code>blocks/blkNNNNN.dat</code><sup><a href="#note2">[2]</a></sup> in 0.8.0</td>
<td><a href="https://github.com/bitcoin/bitcoin/pull/1677">PR #1677</a></td>
</tr>
<tr class="odd">
<td><code>addr.dat</code></td>
<td>Peer IP address BDB database; replaced by <code>peers.dat</code> in <a href="https://github.com/bitcoin/bitcoin/blob/master/doc/release-notes/release-notes-0.7.0.html">0.7.0</a></td>
<td><a href="https://github.com/bitcoin/bitcoin/pull/1198">PR #1198</a>, <a href="https://github.com/bitcoin/bitcoin/commit/928d3a011cc66c7f907c4d053f674ea77dc611cc"><code>928d3a01</code></a></td>
</tr>
<tr class="even">
<td><code>onion_private_key</code></td>
<td>Cached Tor onion service private key for <code>-listenonion</code> option. Was used for Tor v2 services; replaced by <code>onion_v3_private_key</code> in <a href="https://github.com/bitcoin/bitcoin/blob/master/doc/release-notes/release-notes-0.21.0.html">0.21.0</a></td>
<td><a href="https://github.com/bitcoin/bitcoin/pull/19954">PR #19954</a></td>
</tr>
</tbody>
</table>
<h2 id="notes-3">Notes</h2>
<p><a name="note1">1</a>. The <code>/</code> (slash, U+002F) is used as the platform-independent path component separator in this document.</p>
<p><a name="note2">2</a>. <code>NNNNN</code> matches <code>[0-9]{5}</code> regex.</p>
<h1 id="fuzzing-bitcoin-core-using-libfuzzer">Fuzzing Bitcoin Core using libFuzzer</h1>
<h2 id="quickstart-guide">Quickstart guide</h2>
<p>To quickly get started fuzzing Bitcoin Core using <a href="https://llvm.org/docs/LibFuzzer.html">libFuzzer</a>:</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb115-1" title="1">$ <span class="fu">git</span> clone https://github.com/bitcoin/bitcoin</a>
<a class="sourceLine" id="cb115-2" title="2">$ <span class="bu">cd</span> bitcoin/</a>
<a class="sourceLine" id="cb115-3" title="3">$ <span class="ex">./autogen.sh</span></a>
<a class="sourceLine" id="cb115-4" title="4">$ <span class="va">CC=</span>clang <span class="va">CXX=</span>clang++ <span class="ex">./configure</span> --enable-fuzz --with-sanitizers=address,fuzzer,undefined</a>
<a class="sourceLine" id="cb115-5" title="5"><span class="co"># macOS users: If you have problem with this step then make sure to read &quot;macOS hints for</span></a>
<a class="sourceLine" id="cb115-6" title="6"><span class="co"># libFuzzer&quot; on https://github.com/bitcoin/bitcoin/blob/master/doc/fuzzing.html#macos-hints-for-libfuzzer</span></a>
<a class="sourceLine" id="cb115-7" title="7">$ <span class="fu">make</span></a>
<a class="sourceLine" id="cb115-8" title="8">$ <span class="ex">src/test/fuzz/process_message</span></a>
<a class="sourceLine" id="cb115-9" title="9"><span class="co"># abort fuzzing using ctrl-c</span></a></code></pre></div>
<h2 id="fuzzing-harnesses-fuzzing-output-and-fuzzing-corpora">Fuzzing harnesses, fuzzing output and fuzzing corpora</h2>
<p><a href="https://github.com/bitcoin/bitcoin/blob/master/src/test/fuzz/process_message.cpp"><code>process_message</code></a> is a fuzzing harness for the <a href="https://github.com/bitcoin/bitcoin/blob/master/src/net_processing.cpp"><code>ProcessMessage(...)</code> function (<code>net_processing</code>)</a>. The available fuzzing harnesses are found in <a href="https://github.com/bitcoin/bitcoin/tree/master/src/test/fuzz"><code>src/test/fuzz/</code></a>.</p>
<p>The fuzzer will output <code>NEW</code> every time it has created a test input that covers new areas of the code under test. For more information on how to interpret the fuzzer output, see the <a href="https://llvm.org/docs/LibFuzzer.html">libFuzzer documentation</a>.</p>
<p>If you specify a corpus directory then any new coverage increasing inputs will be saved there:</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb116-1" title="1">$ <span class="fu">mkdir</span> -p process_message-seeded-from-thin-air/</a>
<a class="sourceLine" id="cb116-2" title="2">$ <span class="ex">src/test/fuzz/process_message</span> process_message-seeded-from-thin-air/</a>
<a class="sourceLine" id="cb116-3" title="3"><span class="ex">INFO</span>: Seed: 840522292</a>
<a class="sourceLine" id="cb116-4" title="4"><span class="ex">INFO</span>: Loaded 1 modules   (424174 inline 8-bit counters)<span class="bu">:</span> 424174 [0x55e121ef9ab8, 0x55e121f613a6),</a>
<a class="sourceLine" id="cb116-5" title="5"><span class="ex">INFO</span>: Loaded 1 PC tables (424174 PCs)<span class="bu">:</span> 424174 [0x55e121f613a8,0x55e1225da288),</a>
<a class="sourceLine" id="cb116-6" title="6"><span class="ex">INFO</span>:        0 files found in process_message-seeded-from-thin-air/</a>
<a class="sourceLine" id="cb116-7" title="7"><span class="ex">INFO</span>: -max_len is not provided<span class="kw">;</span> <span class="ex">libFuzzer</span> will not generate inputs larger than 4096 bytes</a>
<a class="sourceLine" id="cb116-8" title="8"><span class="ex">INFO</span>: A corpus is not provided, starting from an empty corpus</a>
<a class="sourceLine" id="cb116-9" title="9"><span class="co">#2      INITED cov: 94 ft: 95 corp: 1/1b exec/s: 0 rss: 150Mb</span></a>
<a class="sourceLine" id="cb116-10" title="10"><span class="co">#3      NEW    cov: 95 ft: 96 corp: 2/3b lim: 4 exec/s: 0 rss: 150Mb L: 2/2 MS: 1 InsertByte-</span></a>
<a class="sourceLine" id="cb116-11" title="11"><span class="co">#4      NEW    cov: 96 ft: 98 corp: 3/7b lim: 4 exec/s: 0 rss: 150Mb L: 4/4 MS: 1 CrossOver-</span></a>
<a class="sourceLine" id="cb116-12" title="12"><span class="co">#21     NEW    cov: 96 ft: 100 corp: 4/11b lim: 4 exec/s: 0 rss: 150Mb L: 4/4 MS: 2 ChangeBit-CrossOver-</span></a>
<a class="sourceLine" id="cb116-13" title="13"><span class="co">#324    NEW    cov: 101 ft: 105 corp: 5/12b lim: 6 exec/s: 0 rss: 150Mb L: 6/6 MS: 5 CrossOver-ChangeBit-CopyPart-ChangeBit-ChangeBinInt-</span></a>
<a class="sourceLine" id="cb116-14" title="14"><span class="co">#1239   REDUCE cov: 102 ft: 106 corp: 6/24b lim: 14 exec/s: 0 rss: 150Mb L: 13/13 MS: 5 ChangeBit-CrossOver-EraseBytes-ChangeBit-InsertRepeatedBytes-</span></a>
<a class="sourceLine" id="cb116-15" title="15"><span class="co">#1272   REDUCE cov: 102 ft: 106 corp: 6/23b lim: 14 exec/s: 0 rss: 150Mb L: 12/12 MS: 3 ChangeBinInt-ChangeBit-EraseBytes-</span></a>
<a class="sourceLine" id="cb116-16" title="16">        <span class="ex">NEW_FUNC</span>[1/677]: 0x55e11f456690 in std::_Function_base::~_Function_base() <span class="ex">/usr/lib/gcc/x86_64-linux-gnu/8/../../../../include/c++/8/bits</span>/std_function.h:<span class="ex">255</span></a>
<a class="sourceLine" id="cb116-17" title="17">        <span class="ex">NEW_FUNC</span>[2/677]: 0x55e11f465800 in CDataStream::CDataStream(std::vector<span class="op">&lt;</span>unsigned char, std::allocator<span class="op">&lt;</span>unsigned char<span class="op">&gt;</span> <span class="op">&gt;</span> const<span class="kw">&amp;</span>, <span class="ex">int</span>, int) <span class="ex">src/.</span>/streams.h:<span class="ex">248</span></a>
<a class="sourceLine" id="cb116-18" title="18"><span class="co">#2125   REDUCE cov: 4820 ft: 4867 corp: 7/29b lim: 21 exec/s: 0 rss: 155Mb L: 6/12 MS: 2 CopyPart-CMP- DE: &quot;block&quot;-</span></a>
<a class="sourceLine" id="cb116-19" title="19">        <span class="ex">NEW_FUNC</span>[1/9]: 0x55e11f64d790 in std::_Rb_tree<span class="op">&lt;</span>uint256, std::pair<span class="op">&lt;</span>uint256 const, std::chrono::duration<span class="op">&lt;</span>long, std::ratio<span class="op">&lt;</span>1l, 1000000l<span class="op">&gt;</span> <span class="op">&gt;</span> <span class="op">&gt;</span>, std::_Select1st<span class="op">&lt;</span>std::pair<span class="op">&lt;</span>uint256 const, std::chrono::duration<span class="op">&lt;</span>long, std::ratio<span class="op">&lt;</span>1l, 1000000l<span class="op">&gt;</span> <span class="op">&gt;</span> <span class="op">&gt;</span> <span class="op">&gt;</span>, std::less<span class="op">&lt;</span>uint256<span class="op">&gt;</span>, std::allocator<span class="op">&lt;</span>std::pair<span class="op">&lt;</span>uint256 const, std::chrono::duration<span class="op">&lt;</span>long, std::ratio<span class="op">&lt;</span>1l, 1000000l<span class="op">&gt;</span> <span class="op">&gt;</span> <span class="op">&gt;</span> <span class="op">&gt;</span> <span class="op">&gt;</span>::~_Rb_tree() <span class="ex">/usr/lib/gcc/x86_64-linux-gnu/8/../../../../include/c++/8/bits</span>/stl_tree.h:<span class="ex">972</span></a>
<a class="sourceLine" id="cb116-20" title="20">        <span class="ex">NEW_FUNC</span>[2/9]: 0x55e11f64d870 in std::_Rb_tree<span class="op">&lt;</span>uint256, std::pair<span class="op">&lt;</span>uint256 const, std::chrono::duration<span class="op">&lt;</span>long, std::ratio<span class="op">&lt;</span>1l, 1000000l<span class="op">&gt;</span> <span class="op">&gt;</span> <span class="op">&gt;</span>, std::_Select1st<span class="op">&lt;</span>std::pair<span class="op">&lt;</span>uint256 const, std::chrono::duration<span class="op">&lt;</span>long, std::ratio<span class="op">&lt;</span>1l, 1000000l<span class="op">&gt;</span> <span class="op">&gt;</span> <span class="op">&gt;</span> <span class="op">&gt;</span>, std::less<span class="op">&lt;</span>uint256<span class="op">&gt;</span>, std::allocator<span class="op">&lt;</span>std::pair<span class="op">&lt;</span>uint256 const, std::chrono::duration<span class="op">&lt;</span>long, std::ratio<span class="op">&lt;</span>1l, 1000000l<span class="op">&gt;</span> <span class="op">&gt;</span> <span class="op">&gt;</span> <span class="op">&gt;</span> <span class="op">&gt;</span>::_M_erase(std::_Rb_tree_node<span class="op">&lt;</span>std::pair<span class="op">&lt;</span>uint256 const, std::chrono::duration<span class="op">&lt;</span>long, std::ratio<span class="op">&lt;</span>1l, 1000000l<span class="op">&gt;</span> <span class="op">&gt;</span> <span class="op">&gt;</span> <span class="op">&gt;</span>*) <span class="ex">/usr/lib/gcc/x86_64-linux-gnu/8/../../../../include/c++/8/bits</span>/stl_tree.h:<span class="ex">1875</span></a>
<a class="sourceLine" id="cb116-21" title="21"><span class="co">#2228   NEW    cov: 4898 ft: 4971 corp: 8/35b lim: 21 exec/s: 0 rss: 156Mb L: 6/12 MS: 3 EraseBytes-CopyPart-PersAutoDict- DE: &quot;block&quot;-</span></a>
<a class="sourceLine" id="cb116-22" title="22">        <span class="ex">NEW_FUNC</span>[1/5]: 0x55e11f46df70 in std::enable_if<span class="op">&lt;</span>__and_<span class="op">&lt;</span>std::allocator_traits<span class="op">&lt;</span>zero_after_free_allocator<span class="op">&lt;</span>char<span class="op">&gt;</span> <span class="op">&gt;</span>::__construct_helper<span class="op">&lt;</span>char, unsigned char const<span class="op">&amp;&gt;</span>::type<span class="op">&gt;</span>::value, void<span class="op">&gt;</span>::type std::allocator_traits<span class="op">&lt;</span>zero_after_free_allocator<span class="op">&lt;</span>char<span class="op">&gt;</span> <span class="op">&gt;</span>::_S_construct<span class="op">&lt;</span>char, unsigned char const<span class="op">&amp;&gt;</span>(zero_after_free_allocator<span class="op">&lt;</span>char<span class="op">&gt;</span><span class="kw">&amp;</span>, <span class="ex">char*</span>, unsigned char const<span class="kw">&amp;</span>) <span class="ex">/usr/lib/gcc/x86_64-linux-gnu/8/../../../../include/c++/8/bits</span>/alloc_traits.h:<span class="ex">243</span></a>
<a class="sourceLine" id="cb116-23" title="23">        <span class="ex">NEW_FUNC</span>[2/5]: 0x55e11f477390 in std::vector<span class="op">&lt;</span>unsigned char, std::allocator<span class="op">&lt;</span>unsigned char<span class="op">&gt;</span> <span class="op">&gt;</span>::data() <span class="ex">/usr/lib/gcc/x86_64-linux-gnu/8/../../../../include/c++/8/bits</span>/stl_vector.h:<span class="ex">1056</span></a>
<a class="sourceLine" id="cb116-24" title="24"><span class="co">#2456   NEW    cov: 4933 ft: 5042 corp: 9/55b lim: 21 exec/s: 0 rss: 160Mb L: 20/20 MS: 3 ChangeByte-InsertRepeatedBytes-PersAutoDict- DE: &quot;block&quot;-</span></a>
<a class="sourceLine" id="cb116-25" title="25"><span class="co">#2467   NEW    cov: 4933 ft: 5043 corp: 10/76b lim: 21 exec/s: 0 rss: 161Mb L: 21/21 MS: 1 InsertByte-</span></a>
<a class="sourceLine" id="cb116-26" title="26"><span class="co">#4215   NEW    cov: 4941 ft: 5129 corp: 17/205b lim: 29 exec/s: 4215 rss: 350Mb L: 29/29 MS: 5 InsertByte-ChangeBit-CopyPart-InsertRepeatedBytes-CrossOver-</span></a>
<a class="sourceLine" id="cb116-27" title="27"><span class="co">#4567   REDUCE cov: 4941 ft: 5129 corp: 17/204b lim: 29 exec/s: 4567 rss: 404Mb L: 24/29 MS: 2 ChangeByte-EraseBytes-</span></a>
<a class="sourceLine" id="cb116-28" title="28"><span class="co">#6642   NEW    cov: 4941 ft: 5138 corp: 18/244b lim: 43 exec/s: 2214 rss: 450Mb L: 43/43 MS: 3 CopyPart-CMP-CrossOver- DE: &quot;verack&quot;-</span></a>
<a class="sourceLine" id="cb116-29" title="29"><span class="co"># abort fuzzing using ctrl-c</span></a>
<a class="sourceLine" id="cb116-30" title="30">$ <span class="fu">ls</span> process_message-seeded-from-thin-air/</a>
<a class="sourceLine" id="cb116-31" title="31"><span class="ex">349ac589fc66a09abc0b72bb4ae445a7a19e2cd8</span> 4df479f1f421f2ea64b383cd4919a272604087a7</a>
<a class="sourceLine" id="cb116-32" title="32"><span class="ex">a640312c98dcc55d6744730c33e41c5168c55f09</span> b135de16e4709558c0797c15f86046d31c5d86d7</a>
<a class="sourceLine" id="cb116-33" title="33"><span class="ex">c000f7b41b05139de8b63f4cbf7d1ad4c6e2aa7f</span> fc52cc00ec1eb1c08470e69f809ae4993fa70082</a>
<a class="sourceLine" id="cb116-34" title="34">$ <span class="fu">cat</span> --show-nonprinting process_message-seeded-from-thin-air/349ac589fc66a09abc0b72bb4ae445a7a19e2cd8</a>
<a class="sourceLine" id="cb116-35" title="35"><span class="ex">block</span>^@M-^?M-^?M-^?M-^?M-^?nM-^?M-^?</a></code></pre></div>
<p>In this case the fuzzer managed to create a <code>block</code> message which when passed to <code>ProcessMessage(...)</code> increased coverage.</p>
<p>The project's collection of seed corpora is found in the <a href="https://github.com/bitcoin-core/qa-assets"><code>bitcoin-core/qa-assets</code></a> repo.</p>
<p>To fuzz <code>process_message</code> using the <a href="https://github.com/bitcoin-core/qa-assets"><code>bitcoin-core/qa-assets</code></a> seed corpus:</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb117-1" title="1">$ <span class="fu">git</span> clone https://github.com/bitcoin-core/qa-assets</a>
<a class="sourceLine" id="cb117-2" title="2">$ <span class="ex">src/test/fuzz/process_message</span> qa-assets/fuzz_seed_corpus/process_message/</a>
<a class="sourceLine" id="cb117-3" title="3"><span class="ex">INFO</span>: Seed: 1346407872</a>
<a class="sourceLine" id="cb117-4" title="4"><span class="ex">INFO</span>: Loaded 1 modules   (424174 inline 8-bit counters)<span class="bu">:</span> 424174 [0x55d8a9004ab8, 0x55d8a906c3a6),</a>
<a class="sourceLine" id="cb117-5" title="5"><span class="ex">INFO</span>: Loaded 1 PC tables (424174 PCs)<span class="bu">:</span> 424174 [0x55d8a906c3a8,0x55d8a96e5288),</a>
<a class="sourceLine" id="cb117-6" title="6"><span class="ex">INFO</span>:      991 files found in qa-assets/fuzz_seed_corpus/process_message/</a>
<a class="sourceLine" id="cb117-7" title="7"><span class="ex">INFO</span>: -max_len is not provided<span class="kw">;</span> <span class="ex">libFuzzer</span> will not generate inputs larger than 4096 bytes</a>
<a class="sourceLine" id="cb117-8" title="8"><span class="ex">INFO</span>: seed corpus: files: 991 min: 1b max: 1858b total: 288291b rss: 150Mb</a>
<a class="sourceLine" id="cb117-9" title="9"><span class="co">#993    INITED cov: 7063 ft: 8236 corp: 25/3821b exec/s: 0 rss: 181Mb</span></a>
<a class="sourceLine" id="cb117-10" title="10">…</a></code></pre></div>
<p>If you find coverage increasing inputs when fuzzing you are highly encouraged to submit them for inclusion in the <a href="https://github.com/bitcoin-core/qa-assets"><code>bitcoin-core/qa-assets</code></a> repo.</p>
<p>Every single pull request submitted against the Bitcoin Core repo is automatically tested against all inputs in the <a href="https://github.com/bitcoin-core/qa-assets"><code>bitcoin-core/qa-assets</code></a> repo. Contributing new coverage increasing inputs is an easy way to help make Bitcoin Core more robust.</p>
<h2 id="macos-hints-for-libfuzzer">macOS hints for libFuzzer</h2>
<p>The default Clang/LLVM version supplied by Apple on macOS does not include fuzzing libraries, so macOS users will need to install a full version, for example using <code>brew install llvm</code>.</p>
<p>Should you run into problems with the address sanitizer, it is possible you may need to run <code>./configure</code> with <code>--disable-asm</code> to avoid errors with certain assembly code from Bitcoin Core's code. See <a href="https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.html#sanitizers">developer notes on sanitizers</a> for more information.</p>
<p>You may also need to take care of giving the correct path for <code>clang</code> and <code>clang++</code>, like <code>CC=/path/to/clang CXX=/path/to/clang++</code> if the non-systems <code>clang</code> does not come first in your path.</p>
<p>Full configure that was tested on macOS Catalina with <code>brew</code> installed <code>llvm</code>:</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb118-1" title="1"><span class="ex">./configure</span> --enable-fuzz --with-sanitizers=fuzzer,address,undefined CC=/usr/local/opt/llvm/bin/clang CXX=/usr/local/opt/llvm/bin/clang++ --disable-asm</a></code></pre></div>
<p>Read the <a href="https://llvm.org/docs/LibFuzzer.html">libFuzzer documentation</a> for more information. This <a href="https://github.com/google/fuzzing/blob/master/tutorial/libFuzzerTutorial.html">libFuzzer tutorial</a> might also be of interest.</p>
<h1 id="fuzzing-bitcoin-core-using-american-fuzzy-lop-afl-fuzz">Fuzzing Bitcoin Core using american fuzzy lop (<code>afl-fuzz</code>)</h1>
<h2 id="quickstart-guide-1">Quickstart guide</h2>
<p>To quickly get started fuzzing Bitcoin Core using <a href="https://github.com/google/afl"><code>afl-fuzz</code></a>:</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb119-1" title="1">$ <span class="fu">git</span> clone https://github.com/bitcoin/bitcoin</a>
<a class="sourceLine" id="cb119-2" title="2">$ <span class="bu">cd</span> bitcoin/</a>
<a class="sourceLine" id="cb119-3" title="3">$ <span class="fu">git</span> clone https://github.com/google/afl</a>
<a class="sourceLine" id="cb119-4" title="4">$ <span class="fu">make</span> -C afl/</a>
<a class="sourceLine" id="cb119-5" title="5">$ <span class="fu">make</span> -C afl/llvm_mode/</a>
<a class="sourceLine" id="cb119-6" title="6">$ <span class="ex">./autogen.sh</span></a>
<a class="sourceLine" id="cb119-7" title="7"><span class="co"># It is possible to compile with afl-gcc and afl-g++ instead of afl-clang. However, running afl-fuzz</span></a>
<a class="sourceLine" id="cb119-8" title="8"><span class="co"># may require more memory via the -m flag.</span></a>
<a class="sourceLine" id="cb119-9" title="9">$ <span class="va">CC=$(</span><span class="bu">pwd</span><span class="va">)</span>/afl/afl-clang-fast <span class="va">CXX=$(</span><span class="bu">pwd</span><span class="va">)</span>/afl/afl-clang-fast++ <span class="ex">./configure</span> --enable-fuzz</a>
<a class="sourceLine" id="cb119-10" title="10">$ <span class="fu">make</span></a>
<a class="sourceLine" id="cb119-11" title="11"><span class="co"># For macOS you may need to ignore x86 compilation checks when running &quot;make&quot;. If so,</span></a>
<a class="sourceLine" id="cb119-12" title="12"><span class="co"># try compiling using: AFL_NO_X86=1 make</span></a>
<a class="sourceLine" id="cb119-13" title="13">$ <span class="fu">mkdir</span> -p inputs/ outputs/</a>
<a class="sourceLine" id="cb119-14" title="14">$ <span class="bu">echo</span> A <span class="op">&gt;</span> inputs/thin-air-input</a>
<a class="sourceLine" id="cb119-15" title="15">$ <span class="ex">afl/afl-fuzz</span> -i inputs/ -o outputs/ -- src/test/fuzz/bech32</a>
<a class="sourceLine" id="cb119-16" title="16"><span class="co"># You may have to change a few kernel parameters to test optimally - afl-fuzz</span></a>
<a class="sourceLine" id="cb119-17" title="17"><span class="co"># will print an error and suggestion if so.</span></a></code></pre></div>
<p>Read the <a href="https://github.com/google/afl"><code>afl-fuzz</code> documentation</a> for more information.</p>
<h1 id="fuzzing-bitcoin-core-using-honggfuzz">Fuzzing Bitcoin Core using Honggfuzz</h1>
<h2 id="quickstart-guide-2">Quickstart guide</h2>
<p>To quickly get started fuzzing Bitcoin Core using <a href="https://github.com/google/honggfuzz">Honggfuzz</a>:</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb120-1" title="1">$ <span class="fu">git</span> clone https://github.com/bitcoin/bitcoin</a>
<a class="sourceLine" id="cb120-2" title="2">$ <span class="bu">cd</span> bitcoin/</a>
<a class="sourceLine" id="cb120-3" title="3">$ <span class="ex">./autogen.sh</span></a>
<a class="sourceLine" id="cb120-4" title="4">$ <span class="fu">git</span> clone https://github.com/google/honggfuzz</a>
<a class="sourceLine" id="cb120-5" title="5">$ <span class="bu">cd</span> honggfuzz/</a>
<a class="sourceLine" id="cb120-6" title="6">$ <span class="fu">make</span></a>
<a class="sourceLine" id="cb120-7" title="7">$ <span class="bu">cd</span> ..</a>
<a class="sourceLine" id="cb120-8" title="8">$ <span class="va">CC=$(</span><span class="bu">pwd</span><span class="va">)</span>/honggfuzz/hfuzz_cc/hfuzz-clang <span class="va">CXX=$(</span><span class="bu">pwd</span><span class="va">)</span>/honggfuzz/hfuzz_cc/hfuzz-clang++ <span class="ex">./configure</span> --enable-fuzz --with-sanitizers=address,undefined</a>
<a class="sourceLine" id="cb120-9" title="9">$ <span class="fu">make</span></a>
<a class="sourceLine" id="cb120-10" title="10">$ <span class="fu">mkdir</span> -p inputs/</a>
<a class="sourceLine" id="cb120-11" title="11">$ <span class="ex">honggfuzz/honggfuzz</span> -i inputs/ -- src/test/fuzz/process_message</a></code></pre></div>
<h1 id="read-the-honggfuzz-documentation-for-more-information-gitian-building">Read the <a href="https://github.com/google/honggfuzz/blob/master/docs/USAGE.html">Honggfuzz documentation</a> for more information. Gitian building</h1>
<h1 id="this-file-was-moved-to-the-bitcoin-core-documentation-repository-at-httpsgithubcombitcoin-coredocs-sample-init-scripts-and-service-configuration-for-bitcoind">This file was moved to <a href="https://github.com/bitcoin-core/docs/blob/master/gitian-building.html">the Bitcoin Core documentation repository</a> at <a href="https://github.com/bitcoin-core/docs">https://github.com/bitcoin-core/docs</a>. Sample init scripts and service configuration for bitcoind</h1>
<p>Sample scripts and configuration files for syst.html, Upstart and OpenRC can be found in the contrib/init folder.</p>
<pre><code>contrib/init/bitcoind.service:    syst.html service unit configuration
contrib/init/bitcoind.openrc:     OpenRC compatible SysV style init script
contrib/init/bitcoind.openrcconf: OpenRC conf.d file
contrib/init/bitcoind.conf:       Upstart service configuration file
contrib/init/bitcoind.init:       CentOS compatible SysV style init script
</code></pre>
<h2 id="service-user">Service User</h2>
<p>All three Linux startup configurations assume the existence of a "bitcoin" user and group. They must be created before attempting to use these scripts. The macOS configuration assumes bitcoind will be set up for the current user.</p>
<h2 id="configuration">Configuration</h2>
<p>Running bitcoind as a daemon does not require any manual configuration. You may set the <code>rpcauth</code> setting in the <code>bitcoin.conf</code> configuration file to override the default behaviour of using a special cookie for authentication.</p>
<p>This password does not have to be remembered or typed as it is mostly used as a fixed token that bitcoind and client programs read from the configuration file, however it is recommended that a strong and secure password be used as this password is security critical to securing the wallet should the wallet be enabled.</p>
<p>If bitcoind is run with the "-server" flag (set by default), and no rpcpassword is set, it will use a special cookie file for authentication. The cookie is generated with random content when the daemon starts, and deleted when it exits. Read access to this file controls who can access it through RPC.</p>
<p>By default the cookie is stored in the data directory, but it's location can be overridden with the option '-rpccookiefile'.</p>
<p>This allows for running bitcoind without having to do any manual configuration.</p>
<p><code>conf</code>, <code>pid</code>, and <code>wallet</code> accept relative paths which are interpreted as relative to the data directory. <code>wallet</code> <em>only</em> supports relative paths.</p>
<p>For an example configuration file that describes the configuration settings, see <code>share/examples/bitcoin.conf</code>.</p>
<h2 id="paths">Paths</h2>
<h3 id="linux">Linux</h3>
<p>All three configurations assume several paths that might need to be adjusted.</p>
<p>Binary: <code>/usr/bin/bitcoind</code> Configuration file: <code>/etc/bitcoin/bitcoin.conf</code> Data directory: <code>/var/lib/bitcoind</code> PID file: <code>/var/run/bitcoind/bitcoind.pid</code> (OpenRC and Upstart) or <code>/run/bitcoind/bitcoind.pid</code> (syst.html) Lock file: <code>/var/lock/subsys/bitcoind</code> (CentOS)</p>
<p>The PID directory (if applicable) and data directory should both be owned by the bitcoin user and group. It is advised for security reasons to make the configuration file and data directory only readable by the bitcoin user and group. Access to bitcoin-cli and other bitcoind rpc clients can then be controlled by group membership.</p>
<p>NOTE: When using the syst.html .service file, the creation of the aforementioned directories and the setting of their permissions is automatically handled by syst.html. Directories are given a permission of 710, giving the bitcoin group access to files under it <em>if</em> the files themselves give permission to the bitcoin group to do so (e.g. when <code>-sysperms</code> is specified). This does not allow for the listing of files under the directory.</p>
<p>NOTE: It is not currently possible to override <code>datadir</code> in <code>/etc/bitcoin/bitcoin.conf</code> with the current syst.html, OpenRC, and Upstart init files out-of-the-box. This is because the command line options specified in the init files take precedence over the configurations in <code>/etc/bitcoin/bitcoin.conf</code>. However, some init systems have their own configuration mechanisms that would allow for overriding the command line options specified in the init files (e.g. setting <code>BITCOIND_DATADIR</code> for OpenRC).</p>
<h3 id="macos-1">macOS</h3>
<p>Binary: <code>/usr/local/bin/bitcoind</code> Configuration file: <code>~/Library/Application Support/Bitcoin/bitcoin.conf</code> Data directory: <code>~/Library/Application Support/Bitcoin</code> Lock file: <code>~/Library/Application Support/Bitcoin/.lock</code></p>
<h2 id="installing-service-configuration">Installing Service Configuration</h2>
<h3 id="systhtml">syst.html</h3>
<p>Installing this .service file consists of just copying it to /usr/lib/syst.html/system directory, followed by the command <code>systemctl daemon-reload</code> in order to update running syst.html configuration.</p>
<p>To test, run <code>systemctl start bitcoind</code> and to enable for system startup run <code>systemctl enable bitcoind</code></p>
<p>NOTE: When installing for syst.html in Debian/Ubuntu the .service file needs to be copied to the /lib/syst.html/system directory instead.</p>
<h3 id="openrc">OpenRC</h3>
<p>Rename bitcoind.openrc to bitcoind and drop it in /etc/init.d. Double check ownership and permissions and make it executable. Test it with <code>/etc/init.d/bitcoind start</code> and configure it to run on startup with <code>rc-update add bitcoind</code></p>
<h3 id="upstart-for-debianubuntu-based-distributions">Upstart (for Debian/Ubuntu based distributions)</h3>
<p>Upstart is the default init system for Debian/Ubuntu versions older than 15.04. If you are using version 15.04 or newer and haven't manually configured upstart you should follow the syst.html instructions instead.</p>
<p>Drop bitcoind.conf in /etc/init. Test by running <code>service bitcoind start</code> it will automatically start on reboot.</p>
<p>NOTE: This script is incompatible with CentOS 5 and Amazon Linux 2014 as they use old versions of Upstart and do not supply the start-stop-daemon utility.</p>
<h3 id="centos">CentOS</h3>
<p>Copy bitcoind.init to /etc/init.d/bitcoind. Test by running <code>service bitcoind start</code>.</p>
<p>Using this script, you can adjust the path and flags to the bitcoind program by setting the BITCOIND and FLAGS environment variables in the file /etc/sysconfig/bitcoind. You can also use the DAEMONOPTS environment variable here.</p>
<h3 id="macos-2">macOS</h3>
<p>Copy org.bitcoin.bitcoind.plist into ~/Library/LaunchAgents. Load the launch agent by running <code>launchctl load ~/Library/LaunchAgents/org.bitcoin.bitcoind.plist</code>.</p>
<p>This Launch Agent will cause bitcoind to start whenever the user logs in.</p>
<p>NOTE: This approach is intended for those wanting to run bitcoind as the current user. You will need to modify org.bitcoin.bitcoind.plist if you intend to use it as a Launch Daemon with a dedicated bitcoin user.</p>
<h2 id="auto-respawn">Auto-respawn</h2>
<p>Auto respawning is currently only configured for Upstart and syst.html. Reasonable defaults have been chosen but YMMV.</p>
<h1 id="multiprocess-bitcoin">Multiprocess Bitcoin</h1>
<p>On unix systems, the <code>--enable-multiprocess</code> build option can be passed to <code>./configure</code> to build new <code>bitcoin-node</code>, <code>bitcoin-wallet</code>, and <code>bitcoin-gui</code> executables alongside existing <code>bitcoind</code> and <code>bitcoin-qt</code> executables.</p>
<p><code>bitcoin-node</code> is a drop-in replacement for <code>bitcoind</code>, and <code>bitcoin-gui</code> is a drop-in replacement for <code>bitcoin-qt</code>, and there are no differences in use or external behavior between the new and old executables. But internally (after <a href="https://github.com/bitcoin/bitcoin/pull/10102">#10102</a>), <code>bitcoin-gui</code> will spawn a <code>bitcoin-node</code> process to run P2P and RPC code, communicating with it across a socket pair, and <code>bitcoin-node</code> will spawn <code>bitcoin-wallet</code> to run wallet code, also communicating over a socket pair. This will let node, wallet, and GUI code run in separate address spaces for better isolation, and allow future improvements like being able to start and stop components independently on different machines and environments.</p>
<h2 id="next-steps">Next steps</h2>
<p>Specific next steps after <a href="https://github.com/bitcoin/bitcoin/pull/10102">#10102</a> will be:</p>
<ul>
<li><input type="checkbox" disabled="" />
Adding <code>-ipcbind</code> and <code>-ipcconnect</code> options to <code>bitcoin-node</code>, <code>bitcoin-wallet</code>, and <code>bitcoin-gui</code> executables so they can listen and connect to TCP ports and unix socket paths. This will allow separate processes to be started and stopped any time and connect to each other.</li>
<li><input type="checkbox" disabled="" />
Adding <code>-server</code> and <code>-rpcbind</code> options to the <code>bitcoin-wallet</code> executable so wallet processes can handle RPC requests directly without going through the node.</li>
<li><input type="checkbox" disabled="" />
Supporting windows, not just unix systems. The existing socket code is already cross-platform, so the only windows-specific code that needs to be written is code spawning a process and passing a socket descriptor. This can be implemented with <code>CreateProcess</code> and <code>WSADuplicateSocket</code>. Example: <a href="https://memset.wordpress.com/2010/10/13/win32-api-passing-socket-with-ipc-method/">https://memset.wordpress.com/2010/10/13/win32-api-passing-socket-with-ipc-method/</a>.</li>
<li><input type="checkbox" disabled="" />
Adding sandbox features, restricting subprocess access to resources and data. See <a href="https://eklitzke.org/multiprocess-bitcoin">https://eklitzke.org/multiprocess-bitcoin</a>.</li>
</ul>
<h2 id="debugging">Debugging</h2>
<p>After <a href="https://github.com/bitcoin/bitcoin/pull/10102">#10102</a>, the <code>-debug=ipc</code> command line option can be used to see requests and responses between processes.</p>
<h2 id="installation-1">Installation</h2>
<p>The multiprocess feature requires <a href="https://capnproto.org/">Cap'n Proto</a> and <a href="https://github.com/chaincodelabs/libmultiprocess">libmultiprocess</a> as dependencies. A simple way to get starting using it without installing these dependencies manually is to use the <a href="../depends">depends system</a> with the <code>MULTIPROCESS=1</code> <a href="../depends#dependency-options">dependency option</a> passed to make:</p>
<pre><code>cd &lt;BITCOIN_SOURCE_DIRECTORY&gt;
make -C depends NO_QT=1 MULTIPROCESS=1
./configure --prefix=$PWD/depends/x86_64-pc-linux-gnu
make
src/bitcoin-node -regtest -printtoconsole -debug=ipc
BITCOIND=bitcoin-node test/functional/test_runner.py
</code></pre>
<p>The configure script will pick up settings and library locations from the depends directory, so there is no need to pass <code>--enable-multiprocess</code> as a separate flag when using the depends system (it's controlled by the <code>MULTIPROCESS=1</code> option).</p>
<h1 id="alternately-you-can-install-capn-proto-and-libmultiprocess-packages-on-your-system-and-just-run-configure---enable-multiprocess-without-using-the-depends-system-the-configure-script-will-be-able-to-locate-the-installed-packages-via-pkg-config-see-installation-section-of-the-libmultiprocess-readme-for-install-steps-see-build-unixhtml-and-build-osxhtml-for-information-about-installing-dependencies-in-general-productivity-notes">Alternately, you can install <a href="https://capnproto.org/">Cap'n Proto</a> and <a href="https://github.com/chaincodelabs/libmultiprocess">libmultiprocess</a> packages on your system, and just run <code>./configure --enable-multiprocess</code> without using the depends system. The configure script will be able to locate the installed packages via <a href="https://www.freedesktop.org/wiki/Software/pkg-config/">pkg-config</a>. See <a href="https://github.com/chaincodelabs/libmultiprocess#installation">Installation</a> section of the libmultiprocess readme for install steps. See <a href="build-unix.html">build-unix.html</a> and <a href="build-osx.html">build-osx.html</a> for information about installing dependencies in general. Productivity Notes</h1>
<h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li><a href="#general">General</a>
<ul>
<li><a href="#cache-compilations-with-ccache">Cache compilations with <code>ccache</code></a></li>
<li><a href="#disable-features-with-configure">Disable features with <code>./configure</code></a></li>
<li><a href="#make-use-of-your-threads-with-make--j">Make use of your threads with <code>make -j</code></a></li>
<li><a href="#only-build-what-you-need">Only build what you need</a></li>
<li><a href="#multiple-working-directories-with-git-worktrees">Multiple working directories with <code>git worktrees</code></a></li>
<li><a href="#interactive-dummy-rebases-for-fixups-and-execs-with-git-merge-base">Interactive "dummy rebases" for fixups and execs with <code>git merge-base</code></a></li>
</ul></li>
<li><a href="#writing-code">Writing code</a>
<ul>
<li><a href="#format-cc-diffs-with-clang-format-diffpy">Format C/C++ diffs with <code>clang-format-diff.py</code></a></li>
<li><a href="#format-python-diffs-with-yapf-diffpy">Format Python diffs with <code>yapf-diff.py</code></a></li>
</ul></li>
<li><a href="#rebasingmerging-code">Rebasing/Merging code</a>
<ul>
<li><a href="#more-conflict-context-with-mergeconflictstyle-diff3">More conflict context with <code>merge.conflictstyle diff3</code></a></li>
</ul></li>
<li><a href="#reviewing-code">Reviewing code</a>
<ul>
<li><a href="#reduce-mental-load-with-git-diff-options">Reduce mental load with <code>git diff</code> options</a></li>
<li><a href="#reference-prs-easily-with-refspecs">Reference PRs easily with <code>refspec</code>s</a></li>
<li><a href="#diff-the-diffs-with-git-range-diff">Diff the diffs with <code>git range-diff</code></a></li>
</ul></li>
</ul>
<h2 id="general">General</h2>
<h3 id="cache-compilations-with-ccache">Cache compilations with <code>ccache</code></h3>
<p>The easiest way to faster compile times is to cache compiles. <code>ccache</code> is a way to do so, from its description at the time of writing:</p>
<blockquote>
<p>ccache is a compiler cache. It speeds up recompilation by caching the result of previous compilations and detecting when the same compilation is being done again. Supported languages are C, C++, Objective-C and Objective-C++.</p>
</blockquote>
<p>Install <code>ccache</code> through your distribution's package manager, and run <code>./configure</code> with your normal flags to pick it up.</p>
<p>To use ccache for all your C/C++ projects, follow the symlinks method <a href="https://ccache.samba.org/manual/latest.html#_run_modes">here</a> to set it up.</p>
<p>To get the most out of ccache, put something like this in <code>~/.ccache/ccache.conf</code>:</p>
<pre><code>max_size = 50.0G  # or whatever cache size you prefer; default is 5G; 0 means unlimited
base_dir = /home/yourname  # or wherever you keep your source files
</code></pre>
<p>Note: base_dir is required for ccache to share cached compiles of the same file across different repositories / paths; it will only do this for paths under base_dir. So this option is required for effective use of ccache with git worktrees (described below).</p>
<p>You <em>must not</em> set base_dir to "/", or anywhere that contains system headers (according to the ccache docs).</p>
<h3 id="disable-features-with-configure">Disable features with <code>./configure</code></h3>
<p>After running <code>./autogen.sh</code>, which generates the <code>./configure</code> file, use <code>./configure --help</code> to identify features that you can disable to save on compilation time. A few common flags:</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb124-1" title="1"><span class="ex">--without-miniupnpc</span></a>
<a class="sourceLine" id="cb124-2" title="2"><span class="ex">--disable-bench</span></a>
<a class="sourceLine" id="cb124-3" title="3"><span class="ex">--disable-wallet</span></a>
<a class="sourceLine" id="cb124-4" title="4"><span class="ex">--without-gui</span></a></code></pre></div>
<p>If you do need the wallet enabled, it is common for devs to add <code>--with-incompatible-bdb</code>. This uses your system bdb version for the wallet, so you don't have to find a copy of bdb 4.8. Wallets from such a build will be incompatible with any release binary (and vice versa), so use with caution on mainnet.</p>
<h3 id="make-use-of-your-threads-with-make--j">Make use of your threads with <code>make -j</code></h3>
<p>If you have multiple threads on your machine, you can tell <code>make</code> to utilize all of them with:</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb125-1" title="1"><span class="fu">make</span> -j<span class="st">&quot;</span><span class="va">$(($(</span><span class="ex">nproc</span><span class="va">)</span>+1<span class="va">))</span><span class="st">&quot;</span></a></code></pre></div>
<h3 id="only-build-what-you-need">Only build what you need</h3>
<p>When rebuilding during development, note that running <code>make</code>, without giving a target, will do a lot of work you probably don't need. It will build the GUI (unless you've disabled it) and all the tests (which take much longer to build than the app does).</p>
<p>Obviously, it is important to build and run the tests at appropriate times -- but when you just want a quick compile to check your work, consider picking one or a set of build targets relevant to what you're working on, e.g.:</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb126-1" title="1"><span class="fu">make</span> src/bitcoind src/bitcoin-cli</a>
<a class="sourceLine" id="cb126-2" title="2"><span class="fu">make</span> src/qt/bitcoin-qt</a>
<a class="sourceLine" id="cb126-3" title="3"><span class="fu">make</span> -C src bitcoin_bench</a></code></pre></div>
<p>(You can and should combine this with <code>-j</code>, as above, for a parallel build.)</p>
<h3 id="multiple-working-directories-with-git-worktrees">Multiple working directories with <code>git worktrees</code></h3>
<p>If you work with multiple branches or multiple copies of the repository, you should try <code>git worktrees</code>.</p>
<p>To create a new branch that lives under a new working directory without disrupting your current working directory (useful for creating pull requests):</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb127-1" title="1"><span class="fu">git</span> worktree add -b my-shiny-new-branch ../living-at-my-new-working-directory based-on-my-crufty-old-commit-ish</a></code></pre></div>
<p>To simply check out a commit-ish under a new working directory without disrupting your current working directory (useful for reviewing pull requests):</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb128-1" title="1"><span class="fu">git</span> worktree add --checkout ../where-my-checkout-commit-ish-will-live my-checkout-commit-ish</a></code></pre></div>
<h3 id="interactive-dummy-rebases-for-fixups-and-execs-with-git-merge-base">Interactive "dummy rebases" for fixups and execs with <code>git merge-base</code></h3>
<p>When rebasing, we often want to do a "dummy rebase," whereby we are not rebasing over an updated master but rather over the last common commit with master. This might be useful for rearranging commits, <code>rebase --autosquash</code>ing, or <code>rebase --exec</code>ing without introducing conflicts that arise from an updated master. In these situations, we can use <code>git merge-base</code> to identify the last common commit with master, and rebase off of that.</p>
<p>To squash in <code>git commit --fixup</code> commits without rebasing over an updated master, we can do the following:</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb129-1" title="1"><span class="fu">git</span> rebase -i --autosquash <span class="st">&quot;</span><span class="va">$(</span><span class="fu">git</span> merge-base master HEAD<span class="va">)</span><span class="st">&quot;</span></a></code></pre></div>
<p>To execute <code>make check</code> on every commit since last diverged from master, but without rebasing over an updated master, we can do the following:</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb130-1" title="1"><span class="fu">git</span> rebase -i --exec <span class="st">&quot;make check&quot;</span> <span class="st">&quot;</span><span class="va">$(</span><span class="fu">git</span> merge-base master HEAD<span class="va">)</span><span class="st">&quot;</span></a></code></pre></div>
<hr />
<p>This synergizes well with <a href="#cache-compilations-with-ccache"><code>ccache</code></a> as objects resulting from unchanged code will most likely hit the cache and won't need to be recompiled.</p>
<p>You can also set up <a href="#reference-prs-easily-with-refspecs">upstream refspecs</a> to refer to pull requests easier in the above <code>git worktree</code> commands.</p>
<h2 id="writing-code">Writing code</h2>
<h3 id="format-cc-diffs-with-clang-format-diffpy">Format C/C++ diffs with <code>clang-format-diff.py</code></h3>
<p>See <a href="/contrib/devtools/README.html#clang-format-diff.py">contrib/devtools/README.html</a>.</p>
<h3 id="format-python-diffs-with-yapf-diffpy">Format Python diffs with <code>yapf-diff.py</code></h3>
<p>Usage is exactly the same as <a href="#format-cc-diffs-with-clang-format-diffpy"><code>clang-format-diff.py</code></a>. You can get it <a href="https://github.com/MarcoFalke/yapf-diff">here</a>.</p>
<h2 id="rebasingmerging-code">Rebasing/Merging code</h2>
<h3 id="more-conflict-context-with-mergeconflictstyle-diff3">More conflict context with <code>merge.conflictstyle diff3</code></h3>
<p>For resolving merge/rebase conflicts, it can be useful to enable diff3 style using <code>git config merge.conflictstyle diff3</code>. Instead of</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb131-1" title="1"><span class="st">&lt;&lt;&lt;</span></a>
<a class="sourceLine" id="cb131-2" title="2">yours</a>
<a class="sourceLine" id="cb131-3" title="3">===</a>
<a class="sourceLine" id="cb131-4" title="4">theirs</a>
<a class="sourceLine" id="cb131-5" title="5"><span class="va">&gt;&gt;&gt;</span></a></code></pre></div>
<p>you will see</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb132-1" title="1"><span class="st">&lt;&lt;&lt;</span></a>
<a class="sourceLine" id="cb132-2" title="2">yours</a>
<a class="sourceLine" id="cb132-3" title="3">|||</a>
<a class="sourceLine" id="cb132-4" title="4">original</a>
<a class="sourceLine" id="cb132-5" title="5">===</a>
<a class="sourceLine" id="cb132-6" title="6">theirs</a>
<a class="sourceLine" id="cb132-7" title="7"><span class="va">&gt;&gt;&gt;</span></a></code></pre></div>
<p>This may make it much clearer what caused the conflict. In this style, you can often just look at what changed between <em>original</em> and <em>theirs</em>, and mechanically apply that to <em>yours</em> (or the other way around).</p>
<h2 id="reviewing-code">Reviewing code</h2>
<h3 id="reduce-mental-load-with-git-diff-options">Reduce mental load with <code>git diff</code> options</h3>
<p>When reviewing patches which change indentation in C++ files, use <code>git diff -w</code> and <code>git show -w</code>. This makes the diff algorithm ignore whitespace changes. This feature is also available on github.com, by adding <code>?w=1</code> at the end of any URL which shows a diff.</p>
<p>When reviewing patches that change symbol names in many places, use <code>git diff --word-diff</code>. This will instead of showing the patch as deleted/added <em>lines</em>, show deleted/added <em>words</em>.</p>
<p>When reviewing patches that move code around, try using <code>git diff --patience commit~:old/file.cpp commit:new/file/name.cpp</code>, and ignoring everything except the moved body of code which should show up as neither <code>+</code> or <code>-</code> lines. In case it was not a pure move, this may even work when combined with the <code>-w</code> or <code>--word-diff</code> options described above. <code>--color-moved=dimmed-zebra</code> will also dim the coloring of moved hunks in the diff on compatible terminals.</p>
<h3 id="reference-prs-easily-with-refspecs">Reference PRs easily with <code>refspec</code>s</h3>
<p>When looking at other's pull requests, it may make sense to add the following section to your <code>.git/config</code> file:</p>
<pre><code>[remote &quot;upstream-pull&quot;]
        fetch = +refs/pull/*/head:refs/remotes/upstream-pull/*
        url = git@github.com:bitcoin/bitcoin.git
</code></pre>
<p>This will add an <code>upstream-pull</code> remote to your git repository, which can be fetched using <code>git fetch --all</code> or <code>git fetch upstream-pull</code>. It will download and store on disk quite a lot of data (all PRs, including merged and closed ones). Afterwards, you can use <code>upstream-pull/NUMBER/head</code> in arguments to <code>git show</code>, <code>git checkout</code> and anywhere a commit id would be acceptable to see the changes from pull request NUMBER.</p>
<h3 id="diff-the-diffs-with-git-range-diff">Diff the diffs with <code>git range-diff</code></h3>
<p>It is very common for contributors to rebase their pull requests, or make changes to commits (perhaps in response to review) that are not at the head of their branch. This poses a problem for reviewers as when the contributor force pushes, the reviewer is no longer sure that his previous reviews of commits are still valid (as the commit hashes can now be different even though the diff is semantically the same). <a href="https://git-scm.com/docs/git-range-diff">git range-diff</a> (Git &gt;= 2.19) can help solve this problem by diffing the diffs.</p>
<p>For example, to identify the differences between your previously reviewed diffs P1-5, and the new diffs P1-2,N3-4 as illustrated below:</p>
<pre><code>       P1--P2--P3--P4--P5   &lt;-- previously-reviewed-head
      /
...--m   &lt;-- master
      \
       P1--P2--N3--N4--N5   &lt;-- new-head (with P3 slightly modified)
</code></pre>
<p>You can do:</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb135-1" title="1"><span class="fu">git</span> range-diff master previously-reviewed-head new-head</a></code></pre></div>
<p>Note that <code>git range-diff</code> also work for rebases:</p>
<pre><code>       P1--P2--P3--P4--P5   &lt;-- previously-reviewed-head
      /
...--m--m1--m2--m3   &lt;-- master
                  \
                   P1--P2--N3--N4  &lt;-- new-head (with P3 modified, P4 &amp; P5 squashed)

PREV=P5 N=4 &amp;&amp; git range-diff `git merge-base --all HEAD $PREV`...$PREV HEAD~$N...HEAD
</code></pre>
<p>Where <code>P5</code> is the commit you last reviewed and <code>4</code> is the number of commits in the new version.</p>
<hr />
<p><code>git range-diff</code> also accepts normal <code>git diff</code> options, see <a href="#reduce-mental-load-with-git-diff-options">Reduce mental load with <code>git diff</code> options</a> for useful <code>git diff</code> options.</p>
<p>You can also set up <a href="#reference-prs-easily-with-refspecs">upstream refspecs</a> to refer to pull requests easier in the above <code>git range-diff</code> commands.</p>
<h1 id="psbt-howto-for-bitcoin-core">PSBT Howto for Bitcoin Core</h1>
<p>Since Bitcoin Core 0.17, an RPC interface exists for Partially Signed Bitcoin Transactions (PSBTs, as specified in <a href="https://github.com/bitcoin/bips/blob/master/bip-0174.mediawiki">BIP 174</a>).</p>
<p>This document describes the overall workflow for producing signed transactions through the use of PSBT, and the specific RPC commands used in typical scenarios.</p>
<h2 id="psbt-in-general">PSBT in general</h2>
<p>PSBT is an interchange format for Bitcoin transactions that are not fully signed yet, together with relevant metadata to help entities work towards signing it. It is intended to simplify workflows where multiple parties need to cooperate to produce a transaction. Examples include hardware wallets, multisig setups, and <a href="https://bitcointalk.org/?topic=279249">CoinJoin</a> transactions.</p>
<h3 id="overall-workflow">Overall workflow</h3>
<p>Overall, the construction of a fully signed Bitcoin transaction goes through the following steps:</p>
<ul>
<li>A <strong>Creator</strong> proposes a particular transaction to be created. They construct a PSBT that contains certain inputs and outputs, but no additional metadata.</li>
<li>For each input, an <strong>Updater</strong> adds information about the UTXOs being spent by the transaction to the PSBT. They also add information about the scripts and public keys involved in each of the inputs (and possibly outputs) of the PSBT.</li>
<li><strong>Signers</strong> inspect the transaction and its metadata to decide whether they agree with the transaction. They can use amount information from the UTXOs to assess the values and fees involved. If they agree, they produce a partial signature for the inputs for which they have relevant key(s).</li>
<li>A <strong>Finalizer</strong> is run for each input to convert the partial signatures and possibly script information into a final <code>scriptSig</code> and/or <code>scriptWitness</code>.</li>
<li>An <strong>Extractor</strong> produces a valid Bitcoin transaction (in network format) from a PSBT for which all inputs are finalized.</li>
</ul>
<p>Generally, each of the above (excluding Creator and Extractor) will simply add more and more data to a particular PSBT, until all inputs are fully signed. In a naive workflow, they all have to operate sequentially, passing the PSBT from one to the next, until the Extractor can convert it to a real transaction. In order to permit parallel operation, <strong>Combiners</strong> can be employed which merge metadata from different PSBTs for the same unsigned transaction.</p>
<p>The names above in bold are the names of the roles defined in BIP174. They're useful in understanding the underlying steps, but in practice, software and hardware implementations will typically implement multiple roles simultaneously.</p>
<h2 id="psbt-in-bitcoin-core">PSBT in Bitcoin Core</h2>
<h3 id="rpcs">RPCs</h3>
<ul>
<li><strong><code>converttopsbt</code> (Creator)</strong> is a utility RPC that converts an unsigned raw transaction to PSBT format. It ignores existing signatures.</li>
<li><strong><code>createpsbt</code> (Creator)</strong> is a utility RPC that takes a list of inputs and outputs and converts them to a PSBT with no additional information. It is equivalent to calling <code>createrawtransaction</code> followed by <code>converttopsbt</code>.</li>
<li><strong><code>walletcreatefundedpsbt</code> (Creator, Updater)</strong> is a wallet RPC that creates a PSBT with the specified inputs and outputs, adds additional inputs and change to it to balance it out, and adds relevant metadata. In particular, for inputs that the wallet knows about (counting towards its normal or watch-only balance), UTXO information will be added. For outputs and inputs with UTXO information present, key and script information will be added which the wallet knows about. It is equivalent to running <code>createrawtransaction</code>, followed by <code>fundrawtransaction</code>, and <code>converttopsbt</code>.</li>
<li><strong><code>walletprocesspsbt</code> (Updater, Signer, Finalizer)</strong> is a wallet RPC that takes as input a PSBT, adds UTXO, key, and script data to inputs and outputs that miss it, and optionally signs inputs. Where possible it also finalizes the partial signatures.</li>
<li><strong><code>utxoupdatepsbt</code> (Updater)</strong> is a node RPC that takes a PSBT and updates it to include information available from the UTXO set (works only for SegWit inputs).</li>
<li><strong><code>finalizepsbt</code> (Finalizer, Extractor)</strong> is a utility RPC that finalizes any partial signatures, and if all inputs are finalized, converts the result to a fully signed transaction which can be broadcast with <code>sendrawtransaction</code>.</li>
<li><strong><code>combinepsbt</code> (Combiner)</strong> is a utility RPC that implements a Combiner. It can be used at any point in the workflow to merge information added to different versions of the same PSBT. In particular it is useful to combine the output of multiple Updaters or Signers.</li>
<li><strong><code>joinpsbts</code></strong> (Creator) is a utility RPC that joins multiple PSBTs together, concatenating the inputs and outputs. This can be used to construct CoinJoin transactions.</li>
<li><strong><code>decodepsbt</code></strong> is a diagnostic utility RPC which will show all information in a PSBT in human-readable form, as well as compute its eventual fee if known.</li>
<li><strong><code>analyzepsbt</code></strong> is a utility RPC that examines a PSBT and reports the current status of its inputs, the next step in the workflow if known, and if possible, computes the fee of the resulting transaction and estimates the final weight and feerate.</li>
</ul>
<h3 id="workflows">Workflows</h3>
<h4 id="multisig-with-multiple-bitcoin-core-instances">Multisig with multiple Bitcoin Core instances</h4>
<p>Alice, Bob, and Carol want to create a 2-of-3 multisig address. They're all using Bitcoin Core. We assume their wallets only contain the multisig funds. In case they also have a personal wallet, this can be accomplished through the multiwallet feature - possibly resulting in a need to add <code>-rpcwallet=name</code> to the command line in case <code>bitcoin-cli</code> is used.</p>
<p>Setup:</p>
<ul>
<li>All three call <code>getnewaddress</code> to create a new address; call these addresses <em>Aalice</em>, <em>Abob</em>, and <em>Acarol</em>.</li>
<li>All three call <code>getaddressinfo "X"</code>, with <em>X</em> their respective address, and remember the corresponding public keys. Call these public keys <em>Kalice</em>, <em>Kbob</em>, and <em>Kcarol</em>.</li>
<li>All three now run <code>addmultisigaddress 2 ["Kalice","Kbob","Kcarol"]</code> to teach their wallet about the multisig script. Call the address produced by this command <em>Amulti</em>. They may be required to explicitly specify the same addresstype option each, to avoid constructing different versions due to differences in configuration.</li>
<li>They also run <code>importaddress "Amulti" "" false</code> to make their wallets treat payments to <em>Amulti</em> as contributing to the watch-only balance.</li>
<li>Others can verify the produced address by running <code>createmultisig 2 ["Kalice","Kbob","Kcarol"]</code>, and expecting <em>Amulti</em> as output. Again, it may be necessary to explicitly specify the addresstype in order to get a result that matches. This command won't enable them to initiate transactions later, however.</li>
<li>They can now give out <em>Amulti</em> as address others can pay to.</li>
</ul>
<p>Later, when <em>V</em> BTC has been received on <em>Amulti</em>, and Bob and Carol want to move the coins in their entirety to address <em>Asend</em>, with no change. Alice does not need to be involved.</p>
<ul>
<li>One of them - let's assume Carol here - initiates the creation. She runs <code>walletcreatefundedpsbt [] {"Asend":V} 0 {"subtractFeeFromOutputs":[0], "includeWatching":true}</code>. We call the resulting PSBT <em>P</em>. <em>P</em> does not contain any signatures.</li>
<li>Carol needs to sign the transaction herself. In order to do so, she runs <code>walletprocesspsbt "P"</code>, and gives the resulting PSBT <em>P2</em> to Bob.</li>
<li>Bob inspects the PSBT using <code>decodepsbt "P2"</code> to determine if the transaction has indeed just the expected input, and an output to <em>Asend</em>, and the fee is reasonable. If he agrees, he calls <code>walletprocesspsbt "P2"</code> to sign. The resulting PSBT <em>P3</em> contains both Carol's and Bob's signature.</li>
<li>Now anyone can call <code>finalizepsbt "P3"</code> to extract a fully signed transaction <em>T</em>.</li>
<li>Finally anyone can broadcast the transaction using <code>sendrawtransaction "T"</code>.</li>
</ul>
<p>In case there are more signers, it may be advantageous to let them all sign in parallel, rather than passing the PSBT from one signer to the next one. In the above example this would translate to Carol handing a copy of <em>P</em> to each signer separately. They can then all invoke <code>walletprocesspsbt "P"</code>, and end up with their individually-signed PSBT structures. They then all send those back to Carol (or anyone) who can combine them using <code>combinepsbt</code>. The last two steps (<code>finalizepsbt</code> and <code>sendrawtransaction</code>) remain unchanged.</p>
<h1 id="reduce-memory">Reduce Memory</h1>
<p>There are a few parameters that can be dialed down to reduce the memory usage of <code>bitcoind</code>. This can be useful on embedded systems or small VPSes.</p>
<h2 id="in-memory-caches">In-memory caches</h2>
<p>The size of some in-memory caches can be reduced. As caches trade off memory usage for performance, reducing these will usually have a negative effect on performance.</p>
<ul>
<li><code>-dbcache=&lt;n&gt;</code> - the UTXO database cache size, this defaults to <code>450</code>. The unit is MiB (1024).
<ul>
<li>The minimum value for <code>-dbcache</code> is 4.</li>
<li>A lower <code>-dbcache</code> makes initial sync time much longer. After the initial sync, the effect is less pronounced for most use-cases, unless fast validation of blocks is important, such as for mining.</li>
</ul></li>
</ul>
<h2 id="memory-pool-1">Memory pool</h2>
<ul>
<li><p>In Bitcoin Core there is a memory pool limiter which can be configured with <code>-maxmempool=&lt;n&gt;</code>, where <code>&lt;n&gt;</code> is the size in MB (1000). The default value is <code>300</code>.</p>
<ul>
<li>The minimum value for <code>-maxmempool</code> is 5.</li>
<li>A lower maximum mempool size means that transactions will be evicted sooner. This will affect any uses of <code>bitcoind</code> that process unconfirmed transactions.</li>
</ul></li>
<li><p>To completely disable mempool functionality there is the option <code>-blocksonly</code>. This will make the client opt out of receiving (and thus relaying) transactions completely, except as part of blocks.</p>
<ul>
<li>Do not use this when using the client to broadcast transactions as any transaction sent will stick out like a sore thumb, affecting privacy. When used with the wallet it should be combined with <code>-walletbroadcast=0</code> and <code>-spendzeroconfchange=0</code>. Another mechanism for broadcasting outgoing transactions (if any) should be used.</li>
</ul></li>
<li><p>Since <code>0.14.0</code>, unused memory allocated to the mempool (default: 300MB) is shared with the UTXO cache, so when trying to reduce memory usage you should limit the mempool, with the <code>-maxmempool</code> command line argument.</p></li>
</ul>
<h2 id="number-of-peers">Number of peers</h2>
<ul>
<li><code>-maxconnections=&lt;n&gt;</code> - the maximum number of connections, this defaults to 125. Each active connection takes up some memory. This option applies only if incoming connections are enabled, otherwise the number of connections will never be more than 10. Of the 10 outbound peers, there can be 8 full-relay connections and 2 block-relay-only ones.</li>
</ul>
<h2 id="thread-configuration">Thread configuration</h2>
<p>For each thread a thread stack needs to be allocated. By default on Linux, threads take up 8MiB for the thread stack on a 64-bit system, and 4MiB in a 32-bit system.</p>
<ul>
<li><code>-par=&lt;n&gt;</code> - the number of script verification threads, defaults to the number of cores in the system minus one.</li>
<li><code>-rpcthreads=&lt;n&gt;</code> - the number of threads used for processing RPC requests, defaults to <code>4</code>.</li>
</ul>
<h2 id="linux-specific">Linux specific</h2>
<p>By default, since glibc <code>2.10</code>, the C library will create up to two heap arenas per core. This is known to cause excessive memory usage in some scenarios. To avoid this make a script that sets <code>MALLOC_ARENA_MAX</code> before starting bitcoind:</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb137-1" title="1"><span class="co">#!/usr/bin/env bash</span></a>
<a class="sourceLine" id="cb137-2" title="2"><span class="bu">export</span> <span class="va">MALLOC_ARENA_MAX=</span>1</a>
<a class="sourceLine" id="cb137-3" title="3"><span class="ex">bitcoind</span></a></code></pre></div>
<h1 id="the-behavior-was-introduced-to-increase-cpu-locality-of-allocated-memory-and-performance-with-concurrent-allocation-so-this-setting-could-in-theory-reduce-performance-however-in-bitcoin-core-very-little-parallel-allocation-happens-so-the-impact-is-expected-to-be-small-or-absent-reduce-traffic">The behavior was introduced to increase CPU locality of allocated memory and performance with concurrent allocation, so this setting could in theory reduce performance. However, in Bitcoin Core very little parallel allocation happens, so the impact is expected to be small or absent. Reduce Traffic</h1>
<p>Some node operators need to deal with bandwidth caps imposed by their ISPs.</p>
<p>By default, Bitcoin Core allows up to 125 connections to different peers, 10 of which are outbound. You can therefore, have at most 115 inbound connections. Of the 10 outbound peers, there can be 8 full-relay connections and 2 block-relay-only ones.</p>
<p>The default settings can result in relatively significant traffic consumption.</p>
<p>Ways to reduce traffic:</p>
<h2 id="1-use--maxuploadtargetmib-per-day">1. Use <code>-maxuploadtarget=&lt;MiB per day&gt;</code></h2>
<p>A major component of the traffic is caused by serving historic blocks to other nodes during the initial blocks download phase (syncing up a new node). This option can be specified in MiB per day and is turned off by default. This is <em>not</em> a hard limit; only a threshold to minimize the outbound traffic. When the limit is about to be reached, the uploaded data is cut by no longer serving historic blocks (blocks older than one week). Keep in mind that new nodes require other nodes that are willing to serve historic blocks.</p>
<p>Peers with the <code>download</code> permission will never be disconnected, although their traffic counts for calculating the target.</p>
<h2 id="2-disable-listening--listen0">2. Disable "listening" (<code>-listen=0</code>)</h2>
<p>Disabling listening will result in fewer nodes connected (remember the maximum of 10 outbound peers). Fewer nodes will result in less traffic usage as you are relaying blocks and transactions to fewer nodes.</p>
<h2 id="3-reduce-maximum-connections--maxconnectionsnum">3. Reduce maximum connections (<code>-maxconnections=&lt;num&gt;</code>)</h2>
<p>Reducing the maximum connected nodes to a minimum could be desirable if traffic limits are tiny. Keep in mind that bitcoin's trustless model works best if you are connected to a handful of nodes.</p>
<h2 id="4-turn-off-transaction-relay--blocksonly">4. Turn off transaction relay (<code>-blocksonly</code>)</h2>
<p>Forwarding transactions to peers increases the P2P traffic. To only sync blocks with other peers, you can disable transaction relay.</p>
<p>Be reminded of the effects of this setting.</p>
<ul>
<li>Fee estimation will no longer work.</li>
<li>It sets the flag "-walletbroadcast" to be "0", only if it is currently unset. Doing so disables the automatic broadcasting of transactions from wallet. Not relaying other's transactions could hurt your privacy if used while a wallet is loaded or if you use the node to broadcast transactions.</li>
<li>If a peer has the forcerelay permission, we will still receive and relay their transactions.</li>
<li>It makes block propagation slower because compact block relay can only be used when transaction relay is enabled. Release Process ====================</li>
</ul>
<h2 id="branch-updates">Branch updates</h2>
<h3 id="before-every-release-candidate">Before every release candidate</h3>
<ul>
<li>Update translations (ping wumpus on IRC) see <a href="https://github.com/bitcoin/bitcoin/blob/master/doc/translation_process.html#synchronising-translations">translation_process.html</a>.</li>
<li>Update manpages, see <a href="https://github.com/bitcoin/bitcoin/blob/master/contrib/devtools/README.html#gen-manpagessh">gen-manpages.sh</a>.</li>
<li>Update release candidate version in <code>configure.ac</code> (<code>CLIENT_VERSION_RC</code>).</li>
</ul>
<h3 id="before-every-major-and-minor-release">Before every major and minor release</h3>
<ul>
<li>Update <a href="bips.html">bips.html</a> to account for changes since the last release (don't forget to bump the version number on the first line).</li>
<li>Update version in <code>configure.ac</code> (don't forget to set <code>CLIENT_VERSION_RC</code> to <code>0</code>).</li>
<li>Write release notes (see "Write the release notes" below).</li>
</ul>
<h3 id="before-every-major-release">Before every major release</h3>
<ul>
<li>On both the master branch and the new release branch:
<ul>
<li>update <code>CLIENT_VERSION_MINOR</code> in <a href="../configure.ac"><code>configure.ac</code></a></li>
<li>update <code>CLIENT_VERSION_MINOR</code>, <code>PACKAGE_VERSION</code>, and <code>PACKAGE_STRING</code> in <a href="/build_msvc/bitcoin_config.h"><code>build_msvc/bitcoin_config.h</code></a></li>
</ul></li>
<li>On the new release branch in <a href="../configure.ac"><code>configure.ac</code></a> and <a href="/build_msvc/bitcoin_config.h"><code>build_msvc/bitcoin_config.h</code></a> (see <a href="https://github.com/bitcoin/bitcoin/commit/742f7dd">this commit</a>):
<ul>
<li>set <code>CLIENT_VERSION_REVISION</code> to <code>0</code></li>
<li>set <code>CLIENT_VERSION_IS_RELEASE</code> to <code>true</code></li>
</ul></li>
</ul>
<h4 id="before-branch-off">Before branch-off</h4>
<ul>
<li>Update hardcoded <a href="/contrib/seeds/README.html">seeds</a>, see <a href="https://github.com/bitcoin/bitcoin/pull/7415">this pull request</a> for an example.</li>
<li>Update <a href="/src/chainparams.cpp"><code>src/chainparams.cpp</code></a> m_assumed_blockchain_size and m_assumed_chain_state_size with the current size plus some overhead (see <a href="#how-to-calculate-assumed-blockchain-and-chain-state-size">this</a> for information on how to calculate them).</li>
<li>Update <a href="/src/chainparams.cpp"><code>src/chainparams.cpp</code></a> chainTxData with statistics about the transaction count and rate. Use the output of the <code>getchaintxstats</code> RPC, see <a href="https://github.com/bitcoin/bitcoin/pull/20263">this pull request</a> for an example. Reviewers can verify the results by running <code>getchaintxstats &lt;window_block_count&gt; &lt;window_final_block_hash&gt;</code> with the <code>window_block_count</code> and <code>window_final_block_hash</code> from your output.</li>
<li>Update <code>src/chainparams.cpp</code> nMinimumChainWork and defaultAssumeValid (and the block height comment) with information from the <code>getblockheader</code> (and <code>getblockhash</code>) RPCs.
<ul>
<li>The selected value must not be orphaned so it may be useful to set the value two blocks back from the tip.</li>
<li>Testnet should be set some tens of thousands back from the tip due to reorgs there.</li>
<li>This update should be reviewed with a reindex-chainstate with assumevalid=0 to catch any defect that causes rejection of blocks in the past history.</li>
</ul></li>
</ul>
<ul>
<li>Clear the release notes and move them to the wiki (see "Write the release notes" below).</li>
</ul>
<h4 id="after-branch-off-on-master">After branch-off (on master)</h4>
<ul>
<li>Update the version of <code>contrib/gitian-descriptors/*.yml</code>.</li>
</ul>
<h4 id="after-branch-off-on-the-major-release-branch">After branch-off (on the major release branch)</h4>
<ul>
<li>Update the versions.</li>
<li>Create a pinned meta-issue for testing the release candidate (see <a href="https://github.com/bitcoin/bitcoin/issues/17079">this issue</a> for an example) and provide a link to it in the release announcements where useful.</li>
</ul>
<h4 id="before-final-release">Before final release</h4>
<ul>
<li>Merge the release notes from the wiki into the branch.</li>
<li>Ensure the "Needs release note" label is removed from all relevant pull requests and issues.</li>
</ul>
<h2 id="building-1">Building</h2>
<h3 id="first-time--new-builders">First time / New builders</h3>
<p>If you're using the automated script (found in <a href="/contrib/gitian-build.py">contrib/gitian-build.py</a>), then at this point you should run it with the "--setup" command. Otherwise ignore this.</p>
<p>Check out the source code in the following directory hierarchy.</p>
<pre><code>cd /path/to/your/toplevel/build
git clone https://github.com/bitcoin-core/gitian.sigs.git
git clone https://github.com/bitcoin-core/bitcoin-detached-sigs.git
git clone https://github.com/devrandom/gitian-builder.git
git clone https://github.com/bitcoin/bitcoin.git
</code></pre>
<h3 id="write-the-release-notes">Write the release notes</h3>
<p>Open a draft of the release notes for collaborative editing at <a href="https://github.com/bitcoin-core/bitcoin-devwiki/wiki">https://github.com/bitcoin-core/bitcoin-devwiki/wiki</a>.</p>
<p>For the period during which the notes are being edited on the wiki, the version on the branch should be wiped and replaced with a link to the wiki which should be used for all announcements until <code>-final</code>.</p>
<p>Write the release notes. <code>git shortlog</code> helps a lot, for example:</p>
<pre><code>git shortlog --no-merges v(current version, e.g. 0.19.2)..v(new version, e.g. 0.20.0)
</code></pre>
<p>(or ping @wumpus on IRC, he has specific tooling to generate the list of merged pulls and sort them into categories based on labels).</p>
<p>Generate list of authors:</p>
<pre><code>git log --format=&#39;- %aN&#39; v(current version, e.g. 0.20.0)..v(new version, e.g. 0.20.1) | sort -fiu
</code></pre>
<p>Tag the version (or release candidate) in git:</p>
<pre><code>git tag -s v(new version, e.g. 0.20.0)
</code></pre>
<h3 id="setup-and-perform-gitian-builds">Setup and perform Gitian builds</h3>
<p>If you're using the automated script (found in <a href="/contrib/gitian-build.py">contrib/gitian-build.py</a>), then at this point you should run it with the "--build" command. Otherwise ignore this.</p>
<p>Setup Gitian descriptors:</p>
<pre><code>pushd ./bitcoin
export SIGNER=&quot;(your Gitian key, ie bluematt, sipa, etc)&quot;
export VERSION=(new version, e.g. 0.20.0)
git fetch
git checkout v${VERSION}
popd
</code></pre>
<p>Ensure your gitian.sigs are up-to-date if you wish to gverify your builds against other Gitian signatures.</p>
<pre><code>pushd ./gitian.sigs
git pull
popd
</code></pre>
<p>Ensure gitian-builder is up-to-date:</p>
<pre><code>pushd ./gitian-builder
git pull
popd
</code></pre>
<h3 id="fetch-and-create-inputs-first-time-or-when-dependency-versions-change">Fetch and create inputs: (first time, or when dependency versions change)</h3>
<pre><code>pushd ./gitian-builder
mkdir -p inputs
wget -O inputs/osslsigncode-2.0.tar.gz https://github.com/mtrojnar/osslsigncode/archive/2.0.tar.gz
echo &#39;5a60e0a4b3e0b4d655317b2f12a810211c50242138322b16e7e01c6fbb89d92f inputs/osslsigncode-2.0.tar.gz&#39; | sha256sum -c
popd
</code></pre>
<p>Create the macOS SDK tarball, see the <a href="/contrib/macdeploy/README.html#deterministic-macos-dmg-notes">macdeploy instructions</a> for details, and copy it into the inputs directory.</p>
<h3 id="optional-seed-the-gitian-sources-cache-and-offline-git-repositories">Optional: Seed the Gitian sources cache and offline git repositories</h3>
<p>NOTE: Gitian is sometimes unable to download files. If you have errors, try the step below.</p>
<p>By default, Gitian will fetch source files as needed. To cache them ahead of time, make sure you have checked out the tag you want to build in bitcoin, then:</p>
<pre><code>pushd ./gitian-builder
make -C ../bitcoin/depends download SOURCES_PATH=`pwd`/cache/common
popd
</code></pre>
<p>Only missing files will be fetched, so this is safe to re-run for each build.</p>
<p>NOTE: Offline builds must use the --url flag to ensure Gitian fetches only from local URLs. For example:</p>
<pre><code>pushd ./gitian-builder
./bin/gbuild --url bitcoin=/path/to/bitcoin,signature=/path/to/sigs {rest of arguments}
popd
</code></pre>
<p>The gbuild invocations below <b>DO NOT DO THIS</b> by default.</p>
<h3 id="build-and-sign-bitcoin-core-for-linux-windows-and-macos">Build and sign Bitcoin Core for Linux, Windows, and macOS:</h3>
<pre><code>pushd ./gitian-builder
./bin/gbuild --num-make 2 --memory 3000 --commit bitcoin=v${VERSION} ../bitcoin/contrib/gitian-descriptors/gitian-linux.yml
./bin/gsign --signer &quot;$SIGNER&quot; --release ${VERSION}-linux --destination ../gitian.sigs/ ../bitcoin/contrib/gitian-descriptors/gitian-linux.yml
mv build/out/bitcoin-*.tar.gz build/out/src/bitcoin-*.tar.gz ../

./bin/gbuild --num-make 2 --memory 3000 --commit bitcoin=v${VERSION} ../bitcoin/contrib/gitian-descriptors/gitian-win.yml
./bin/gsign --signer &quot;$SIGNER&quot; --release ${VERSION}-win-unsigned --destination ../gitian.sigs/ ../bitcoin/contrib/gitian-descriptors/gitian-win.yml
mv build/out/bitcoin-*-win-unsigned.tar.gz inputs/bitcoin-win-unsigned.tar.gz
mv build/out/bitcoin-*.zip build/out/bitcoin-*.exe ../

./bin/gbuild --num-make 2 --memory 3000 --commit bitcoin=v${VERSION} ../bitcoin/contrib/gitian-descriptors/gitian-osx.yml
./bin/gsign --signer &quot;$SIGNER&quot; --release ${VERSION}-osx-unsigned --destination ../gitian.sigs/ ../bitcoin/contrib/gitian-descriptors/gitian-osx.yml
mv build/out/bitcoin-*-osx-unsigned.tar.gz inputs/bitcoin-osx-unsigned.tar.gz
mv build/out/bitcoin-*.tar.gz build/out/bitcoin-*.dmg ../
popd
</code></pre>
<p>Build output expected:</p>
<ol>
<li>source tarball (<code>bitcoin-${VERSION}.tar.gz</code>)</li>
<li>linux 32-bit and 64-bit dist tarballs (<code>bitcoin-${VERSION}-linux[32|64].tar.gz</code>)</li>
<li>windows 32-bit and 64-bit unsigned installers and dist zips (<code>bitcoin-${VERSION}-win[32|64]-setup-unsigned.exe</code>, <code>bitcoin-${VERSION}-win[32|64].zip</code>)</li>
<li>macOS unsigned installer and dist tarball (<code>bitcoin-${VERSION}-osx-unsigned.dmg</code>, <code>bitcoin-${VERSION}-osx64.tar.gz</code>)</li>
<li>Gitian signatures (in <code>gitian.sigs/${VERSION}-&lt;linux|{win,osx}-unsigned&gt;/(your Gitian key)/</code>)</li>
</ol>
<h3 id="verify-other-gitian-builders-signatures-to-your-own-optional">Verify other gitian builders signatures to your own. (Optional)</h3>
<p>Add other gitian builders keys to your gpg keyring, and/or refresh keys: See <code>../bitcoin/contrib/gitian-keys/README.html</code>.</p>
<p>Verify the signatures</p>
<pre><code>pushd ./gitian-builder
./bin/gverify -v -d ../gitian.sigs/ -r ${VERSION}-linux ../bitcoin/contrib/gitian-descriptors/gitian-linux.yml
./bin/gverify -v -d ../gitian.sigs/ -r ${VERSION}-win-unsigned ../bitcoin/contrib/gitian-descriptors/gitian-win.yml
./bin/gverify -v -d ../gitian.sigs/ -r ${VERSION}-osx-unsigned ../bitcoin/contrib/gitian-descriptors/gitian-osx.yml
popd
</code></pre>
<h3 id="next-steps-1">Next steps:</h3>
<p>Commit your signature to gitian.sigs:</p>
<pre><code>pushd gitian.sigs
git add ${VERSION}-linux/&quot;${SIGNER}&quot;
git add ${VERSION}-win-unsigned/&quot;${SIGNER}&quot;
git add ${VERSION}-osx-unsigned/&quot;${SIGNER}&quot;
git commit -m &quot;Add ${VERSION} unsigned sigs for ${SIGNER}&quot;
git push  # Assuming you can push to the gitian.sigs tree
popd
</code></pre>
<p>Codesigner only: Create Windows/macOS detached signatures:</p>
<ul>
<li>Only one person handles codesigning. Everyone else should skip to the next step.</li>
<li>Only once the Windows/macOS builds each have 3 matching signatures may they be signed with their respective release keys.</li>
</ul>
<p>Codesigner only: Sign the macOS binary:</p>
<pre><code>transfer bitcoin-osx-unsigned.tar.gz to macOS for signing
tar xf bitcoin-osx-unsigned.tar.gz
./detached-sig-create.sh -s &quot;Key ID&quot;
Enter the keychain password and authorize the signature
Move signature-osx.tar.gz back to the gitian host
</code></pre>
<p>Codesigner only: Sign the windows binaries:</p>
<pre><code>tar xf bitcoin-win-unsigned.tar.gz
./detached-sig-create.sh -key /path/to/codesign.key
Enter the passphrase for the key when prompted
signature-win.tar.gz will be created
</code></pre>
<p>Codesigner only: Commit the detached codesign payloads:</p>
<pre><code>cd ~/bitcoin-detached-sigs
checkout the appropriate branch for this release series
rm -rf *
tar xf signature-osx.tar.gz
tar xf signature-win.tar.gz
git add -A
git commit -m &quot;point to ${VERSION}&quot;
git tag -s v${VERSION} HEAD
git push the current branch and new tag
</code></pre>
<p>Non-codesigners: wait for Windows/macOS detached signatures:</p>
<ul>
<li>Once the Windows/macOS builds each have 3 matching signatures, they will be signed with their respective release keys.</li>
<li>Detached signatures will then be committed to the <a href="https://github.com/bitcoin-core/bitcoin-detached-sigs">bitcoin-detached-sigs</a> repository, which can be combined with the unsigned apps to create signed binaries.</li>
</ul>
<p>Create (and optionally verify) the signed macOS binary:</p>
<pre><code>pushd ./gitian-builder
./bin/gbuild -i --commit signature=v${VERSION} ../bitcoin/contrib/gitian-descriptors/gitian-osx-signer.yml
./bin/gsign --signer &quot;$SIGNER&quot; --release ${VERSION}-osx-signed --destination ../gitian.sigs/ ../bitcoin/contrib/gitian-descriptors/gitian-osx-signer.yml
./bin/gverify -v -d ../gitian.sigs/ -r ${VERSION}-osx-signed ../bitcoin/contrib/gitian-descriptors/gitian-osx-signer.yml
mv build/out/bitcoin-osx-signed.dmg ../bitcoin-${VERSION}-osx.dmg
popd
</code></pre>
<p>Create (and optionally verify) the signed Windows binaries:</p>
<pre><code>pushd ./gitian-builder
./bin/gbuild -i --commit signature=v${VERSION} ../bitcoin/contrib/gitian-descriptors/gitian-win-signer.yml
./bin/gsign --signer &quot;$SIGNER&quot; --release ${VERSION}-win-signed --destination ../gitian.sigs/ ../bitcoin/contrib/gitian-descriptors/gitian-win-signer.yml
./bin/gverify -v -d ../gitian.sigs/ -r ${VERSION}-win-signed ../bitcoin/contrib/gitian-descriptors/gitian-win-signer.yml
mv build/out/bitcoin-*win64-setup.exe ../bitcoin-${VERSION}-win64-setup.exe
popd
</code></pre>
<p>Commit your signature for the signed macOS/Windows binaries:</p>
<pre><code>pushd gitian.sigs
git add ${VERSION}-osx-signed/&quot;${SIGNER}&quot;
git add ${VERSION}-win-signed/&quot;${SIGNER}&quot;
git commit -m &quot;Add ${SIGNER} ${VERSION} signed binaries signatures&quot;
git push  # Assuming you can push to the gitian.sigs tree
popd
</code></pre>
<h3 id="after-3-or-more-people-have-gitian-built-and-their-results-match">After 3 or more people have gitian-built and their results match:</h3>
<ul>
<li>Create <code>SHA256SUMS.asc</code> for the builds, and GPG-sign it:</li>
</ul>
<div class="sourceCode" id="cb157"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb157-1" title="1"><span class="ex">sha256sum</span> * <span class="op">&gt;</span> SHA256SUMS</a></code></pre></div>
<p>The list of files should be:</p>
<pre><code>bitcoin-${VERSION}-aarch64-linux-gnu.tar.gz
bitcoin-${VERSION}-arm-linux-gnueabihf.tar.gz
bitcoin-${VERSION}-riscv64-linux-gnu.tar.gz
bitcoin-${VERSION}-x86_64-linux-gnu.tar.gz
bitcoin-${VERSION}-osx64.tar.gz
bitcoin-${VERSION}-osx.dmg
bitcoin-${VERSION}.tar.gz
bitcoin-${VERSION}-win64-setup.exe
bitcoin-${VERSION}-win64.zip
</code></pre>
<p>The <code>*-debug*</code> files generated by the gitian build contain debug symbols for troubleshooting by developers. It is assumed that anyone that is interested in debugging can run gitian to generate the files for themselves. To avoid end-user confusion about which file to pick, as well as save storage space <em>do not upload these to the bitcoin.org server, nor put them in the torrent</em>.</p>
<ul>
<li>GPG-sign it, delete the unsigned file:</li>
</ul>
<pre><code>gpg --digest-algo sha256 --clearsign SHA256SUMS # outputs SHA256SUMS.asc
rm SHA256SUMS
</code></pre>
<p>(the digest algorithm is forced to sha256 to avoid confusion of the <code>Hash:</code> header that GPG adds with the SHA256 used for the files) Note: check that SHA256SUMS itself doesn't end up in SHA256SUMS, which is a spurious/nonsensical entry.</p>
<ul>
<li><p>Upload zips and installers, as well as <code>SHA256SUMS.asc</code> from last step, to the bitcoin.org server into <code>/var/www/bin/bitcoin-core-${VERSION}</code></p></li>
<li><p>A <code>.torrent</code> will appear in the directory after a few minutes. Optionally help seed this torrent. To get the <code>magnet:</code> URI use:</p></li>
</ul>
<div class="sourceCode" id="cb160"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb160-1" title="1"><span class="ex">transmission-show</span> -m <span class="op">&lt;</span>torrent file<span class="op">&gt;</span></a></code></pre></div>
<p>Insert the magnet URI into the announcement sent to mailing lists. This permits people without access to <code>bitcoin.org</code> to download the binary distribution. Also put it into the <code>optional_magnetlink:</code> slot in the YAML file for bitcoin.org (see below for bitcoin.org update instructions).</p>
<ul>
<li><p>Update bitcoin.org version</p>
<ul>
<li><p>First, check to see if the Bitcoin.org maintainers have prepared a release: <a href="https://github.com/bitcoin-dot-org/bitcoin.org/labels/Core">https://github.com/bitcoin-dot-org/bitcoin.org/labels/Core</a></p>
<ul>
<li>If they have, it will have previously failed their Travis CI checks because the final release files weren't uploaded. Trigger a Travis CI rebuild---if it passes, merge.</li>
</ul></li>
<li><p>If they have not prepared a release, follow the Bitcoin.org release instructions: <a href="https://github.com/bitcoin-dot-org/bitcoin.org/blob/master/docs/adding-events-release-notes-and-alerts.html#release-notes">https://github.com/bitcoin-dot-org/bitcoin.org/blob/master/docs/adding-events-release-notes-and-alerts.html#release-notes</a></p></li>
<li><p>After the pull request is merged, the website will automatically show the newest version within 15 minutes, as well as update the OS download links.</p></li>
</ul></li>
<li><p>Update other repositories and websites for new version</p>
<ul>
<li><p>bitcoincore.org blog post</p></li>
<li><p>bitcoincore.org maintained versions update: <a href="https://github.com/bitcoin-core/bitcoincore.org/commits/master/_includes/posts/maintenance-table.html">table</a></p></li>
<li><p>bitcoincore.org RPC documentation update</p></li>
<li><p>Update packaging repo</p>
<ul>
<li><p>Push the flatpak to flathub, e.g. <a href="https://github.com/flathub/org.bitcoincore.bitcoin-qt/pull/2">https://github.com/flathub/org.bitcoincore.bitcoin-qt/pull/2</a></p></li>
<li><p>Push the latest version to master (if applicable), e.g. <a href="https://github.com/bitcoin-core/packaging/pull/32">https://github.com/bitcoin-core/packaging/pull/32</a></p></li>
<li><p>Create a new branch for the major release "0.xx" from master (used to build the snap package) and request the track (if applicable), e.g. <a href="https://forum.snapcraft.io/t/track-request-for-bitcoin-core-snap/10112/7">https://forum.snapcraft.io/t/track-request-for-bitcoin-core-snap/10112/7</a></p></li>
<li><p>Notify MarcoFalke so that he can start building the snap package</p>
<ul>
<li><a href="https://code.launchpad.net/~bitcoin-core/bitcoin-core-snap/+git/packaging">https://code.launchpad.net/~bitcoin-core/bitcoin-core-snap/+git/packaging</a> (Click "Import Now" to fetch the branch)</li>
<li><a href="https://code.launchpad.net/~bitcoin-core/bitcoin-core-snap/+git/packaging/+ref/0.xx">https://code.launchpad.net/~bitcoin-core/bitcoin-core-snap/+git/packaging/+ref/0.xx</a> (Click "Create snap package")</li>
<li>Name it "bitcoin-core-snap-0.xx"</li>
<li>Leave owner and series as-is</li>
<li>Select architectures that are compiled via gitian</li>
<li>Leave "automatically build when branch changes" unticked</li>
<li>Tick "automatically upload to store"</li>
<li>Put "bitcoin-core" in the registered store package name field</li>
<li>Tick the "edge" box</li>
<li>Put "0.xx" in the track field</li>
<li>Click "create snap package"</li>
<li>Click "Request builds" for every new release on this branch (after updating the snapcraft.yml in the branch to reflect the latest gitian results)</li>
<li>Promote release on <a href="https://snapcraft.io/bitcoin-core/releases">https://snapcraft.io/bitcoin-core/releases</a> if it passes sanity checks</li>
</ul></li>
</ul></li>
<li><p>This repo</p>
<ul>
<li><p>Archive the release notes for the new version to <code>doc/release-notes/</code> (branch <code>master</code> and branch of the release)</p></li>
<li><p>Create a <a href="https://github.com/bitcoin/bitcoin/releases/new">new GitHub release</a> with a link to the archived release notes</p></li>
</ul></li>
</ul></li>
<li><p>Announce the release:</p>
<ul>
<li><p>bitcoin-dev and bitcoin-core-dev mailing list</p></li>
<li><p>Bitcoin Core announcements list <a href="https://bitcoincore.org/en/list/announcements/join/">https://bitcoincore.org/en/list/announcements/join/</a></p></li>
<li><p>Update title of #bitcoin on Freenode IRC</p></li>
<li><p>Optionally twitter, reddit /r/Bitcoin, ... but this will usually sort out itself</p></li>
<li><p>Celebrate</p></li>
</ul></li>
</ul>
<h3 id="additional-information">Additional information</h3>
<h4 id="how-to-calculate-m_assumed_blockchain_size-and-m_assumed_chain_state_size"><a name="how-to-calculate-assumed-blockchain-and-chain-state-size"></a>How to calculate <code>m_assumed_blockchain_size</code> and <code>m_assumed_chain_state_size</code></h4>
<p>Both variables are used as a guideline for how much space the user needs on their drive in total, not just strictly for the blockchain. Note that all values should be taken from a <strong>fully synced</strong> node and have an overhead of 5-10% added on top of its base value.</p>
<p>To calculate <code>m_assumed_blockchain_size</code>:</p>
<ul>
<li>For <code>mainnet</code> -&gt; Take the size of the data directory, excluding <code>/regtest</code> and <code>/testnet3</code> directories.</li>
<li>For <code>testnet</code> -&gt; Take the size of the <code>/testnet3</code> directory.</li>
</ul>
<p>To calculate <code>m_assumed_chain_state_size</code>:</p>
<ul>
<li>For <code>mainnet</code> -&gt; Take the size of the <code>/chainstate</code> directory.</li>
<li>For <code>testnet</code> -&gt; Take the size of the <code>/testnet3/chainstate</code> directory.</li>
</ul>
<p>Notes:</p>
<ul>
<li>When taking the size for <code>m_assumed_blockchain_size</code>, there's no need to exclude the <code>/chainstate</code> directory since it's a guideline value and an overhead will be added anyway.</li>
<li>The expected overhead for growth may change over time, so it may not be the same value as last release; pay attention to that when changing the variables. Shared Libraries ================</li>
</ul>
<h2 id="bitcoinconsensus">bitcoinconsensus</h2>
<p>The purpose of this library is to make the verification functionality that is critical to Bitcoin's consensus available to other applications, e.g. to language bindings.</p>
<h3 id="api">API</h3>
<p>The interface is defined in the C header <code>bitcoinconsensus.h</code> located in <code>src/script/bitcoinconsensus.h</code>.</p>
<h4 id="version">Version</h4>
<p><code>bitcoinconsensus_version</code> returns an <code>unsigned int</code> with the API version <em>(currently <code>1</code>)</em>.</p>
<h4 id="script-validation">Script Validation</h4>
<p><code>bitcoinconsensus_verify_script</code> returns an <code>int</code> with the status of the verification. It will be <code>1</code> if the input script correctly spends the previous output <code>scriptPubKey</code>.</p>
<h5 id="parameters">Parameters</h5>
<ul>
<li><code>const unsigned char *scriptPubKey</code> - The previous output script that encumbers spending.</li>
<li><code>unsigned int scriptPubKeyLen</code> - The number of bytes for the <code>scriptPubKey</code>.</li>
<li><code>const unsigned char *txTo</code> - The transaction with the input that is spending the previous output.</li>
<li><code>unsigned int txToLen</code> - The number of bytes for the <code>txTo</code>.</li>
<li><code>unsigned int nIn</code> - The index of the input in <code>txTo</code> that spends the <code>scriptPubKey</code>.</li>
<li><code>unsigned int flags</code> - The script validation flags <em>(see below)</em>.</li>
<li><code>bitcoinconsensus_error* err</code> - Will have the error/success code for the operation <em>(see below)</em>.</li>
</ul>
<h5 id="script-flags">Script Flags</h5>
<ul>
<li><code>bitcoinconsensus_SCRIPT_FLAGS_VERIFY_NONE</code></li>
<li><code>bitcoinconsensus_SCRIPT_FLAGS_VERIFY_P2SH</code> - Evaluate P2SH (<a href="https://github.com/bitcoin/bips/blob/master/bip-0016.mediawiki">BIP16</a>) subscripts</li>
<li><code>bitcoinconsensus_SCRIPT_FLAGS_VERIFY_DERSIG</code> - Enforce strict DER (<a href="https://github.com/bitcoin/bips/blob/master/bip-0066.mediawiki">BIP66</a>) compliance</li>
<li><code>bitcoinconsensus_SCRIPT_FLAGS_VERIFY_NULLDUMMY</code> - Enforce NULLDUMMY (<a href="https://github.com/bitcoin/bips/blob/master/bip-0147.mediawiki">BIP147</a>)</li>
<li><code>bitcoinconsensus_SCRIPT_FLAGS_VERIFY_CHECKLOCKTIMEVERIFY</code> - Enable CHECKLOCKTIMEVERIFY (<a href="https://github.com/bitcoin/bips/blob/master/bip-0065.mediawiki">BIP65</a>)</li>
<li><code>bitcoinconsensus_SCRIPT_FLAGS_VERIFY_CHECKSEQUENCEVERIFY</code> - Enable CHECKSEQUENCEVERIFY (<a href="https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki">BIP112</a>)</li>
<li><code>bitcoinconsensus_SCRIPT_FLAGS_VERIFY_WITNESS</code> - Enable WITNESS (<a href="https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki">BIP141</a>)</li>
</ul>
<h5 id="errors">Errors</h5>
<ul>
<li><code>bitcoinconsensus_ERR_OK</code> - No errors with input parameters <em>(see the return value of <code>bitcoinconsensus_verify_script</code> for the verification status)</em></li>
<li><code>bitcoinconsensus_ERR_TX_INDEX</code> - An invalid index for <code>txTo</code></li>
<li><code>bitcoinconsensus_ERR_TX_SIZE_MISMATCH</code> - <code>txToLen</code> did not match with the size of <code>txTo</code></li>
<li><code>bitcoinconsensus_ERR_DESERIALIZE</code> - An error deserializing <code>txTo</code></li>
<li><code>bitcoinconsensus_ERR_AMOUNT_REQUIRED</code> - Input amount is required if WITNESS is used</li>
</ul>
<h3 id="example-implementations">Example Implementations</h3>
<ul>
<li><a href="https://github.com/NicolasDorier/NBitcoin/blob/master/NBitcoin/Script.cs#L814">NBitcoin</a> (.NET Bindings)</li>
<li><a href="https://github.com/bitpay/node-libbitcoinconsensus">node-libbitcoinconsensus</a> (Node.js Bindings)</li>
<li><a href="https://github.com/dexX7/java-libbitcoinconsensus">java-libbitcoinconsensus</a> (Java Bindings)</li>
<li><a href="https://github.com/Bit-Wasp/bitcoinconsensus-php">bitcoinconsensus-php</a> (PHP Bindings)</li>
</ul>
<h1 id="tor-support-in-bitcoin">TOR SUPPORT IN BITCOIN</h1>
<p>It is possible to run Bitcoin Core as a Tor onion service, and connect to such services.</p>
<p>The following directions assume you have a Tor proxy running on port 9050. Many distributions default to having a SOCKS proxy listening on port 9050, but others may not. In particular, the Tor Browser Bundle defaults to listening on port 9150. See <a href="https://www.torproject.org/docs/faq.html.en#TBBSocksPort">Tor Project FAQ:TBBSocksPort</a> for how to properly configure Tor.</p>
<h2 id="1-run-bitcoin-core-behind-a-tor-proxy">1. Run Bitcoin Core behind a Tor proxy</h2>
<p>The first step is running Bitcoin Core behind a Tor proxy. This will already anonymize all outgoing connections, but more is possible.</p>
<pre><code>-proxy=ip:port  Set the proxy server. If SOCKS5 is selected (default), this proxy
                server will be used to try to reach .onion addresses as well.

-onion=ip:port  Set the proxy server to use for Tor onion services. You do not
                need to set this if it&#39;s the same as -proxy. You can use -noonion
                to explicitly disable access to onion services.

-listen         When using -proxy, listening is disabled by default. If you want
                to run an onion service (see next section), you&#39;ll need to enable
                it explicitly.

-connect=X      When behind a Tor proxy, you can specify .onion addresses instead
-addnode=X      of IP addresses or hostnames in these parameters. It requires
-seednode=X     SOCKS5. In Tor mode, such addresses can also be exchanged with
                other P2P nodes.

-onlynet=onion  Make outgoing connections only to .onion addresses. Incoming
                connections are not affected by this option. This option can be
                specified multiple times to allow multiple network types, e.g.
                ipv4, ipv6, or onion.
</code></pre>
<p>In a typical situation, this suffices to run behind a Tor proxy:</p>
<pre><code>./bitcoind -proxy=127.0.0.1:9050
</code></pre>
<h2 id="2-run-a-bitcoin-core-hidden-server">2. Run a Bitcoin Core hidden server</h2>
<p>If you configure your Tor system accordingly, it is possible to make your node also reachable from the Tor network. Add these lines to your /etc/tor/torrc (or equivalent config file): <em>Needed for Tor version 0.2.7.0 and older versions of Tor only. For newer versions of Tor see <a href="#3-automatically-listen-on-tor">Section 3</a>.</em></p>
<pre><code>HiddenServiceDir /var/lib/tor/bitcoin-service/
HiddenServicePort 8333 127.0.0.1:8334
HiddenServicePort 18333 127.0.0.1:18334
</code></pre>
<p>The directory can be different of course, but virtual port numbers should be equal to your bitcoind's P2P listen port (8333 by default), and target addresses and ports should be equal to binding address and port for inbound Tor connections (127.0.0.1:8334 by default).</p>
<pre><code>-externalip=X   You can tell bitcoin about its publicly reachable address using
                this option, and this can be a .onion address. Given the above
                configuration, you can find your .onion address in
                /var/lib/tor/bitcoin-service/hostname. For connections
                coming from unroutable addresses (such as 127.0.0.1, where the
                Tor proxy typically runs), .onion addresses are given
                preference for your node to advertise itself with.

-listen         You&#39;ll need to enable listening for incoming connections, as this
                is off by default behind a proxy.

-discover       When -externalip is specified, no attempt is made to discover local
                IPv4 or IPv6 addresses. If you want to run a dual stack, reachable
                from both Tor and IPv4 (or IPv6), you&#39;ll need to either pass your
                other addresses using -externalip, or explicitly enable -discover.
                Note that both addresses of a dual-stack system may be easily
                linkable using traffic analysis.
</code></pre>
<p>In a typical situation, where you're only reachable via Tor, this should suffice:</p>
<pre><code>./bitcoind -proxy=127.0.0.1:9050 -externalip=57qr3yd1nyntf5k.onion -listen
</code></pre>
<p>(obviously, replace the .onion address with your own). It should be noted that you still listen on all devices and another node could establish a clearnet connection, when knowing your address. To mitigate this, additionally bind the address of your Tor proxy:</p>
<pre><code>./bitcoind ... -bind=127.0.0.1
</code></pre>
<p>If you don't care too much about hiding your node, and want to be reachable on IPv4 as well, use <code>discover</code> instead:</p>
<pre><code>./bitcoind ... -discover
</code></pre>
<p>and open port 8333 on your firewall (or use -upnp).</p>
<p>If you only want to use Tor to reach .onion addresses, but not use it as a proxy for normal IPv4/IPv6 communication, use:</p>
<pre><code>./bitcoind -onion=127.0.0.1:9050 -externalip=57qr3yd1nyntf5k.onion -discover
</code></pre>
<h2 id="3-automatically-listen-on-tor">3. Automatically listen on Tor</h2>
<p>Starting with Tor version 0.2.7.1 it is possible, through Tor's control socket API, to create and destroy 'ephemeral' onion services programmatically. Bitcoin Core has been updated to make use of this.</p>
<p>This means that if Tor is running (and proper authentication has been configured), Bitcoin Core automatically creates an onion service to listen on. This will positively affect the number of available .onion nodes.</p>
<p>This new feature is enabled by default if Bitcoin Core is listening (<code>-listen</code>), and requires a Tor connection to work. It can be explicitly disabled with <code>-listenonion=0</code> and, if not disabled, configured using the <code>-torcontrol</code> and <code>-torpassword</code> settings. To show verbose debugging information, pass <code>-debug=tor</code>.</p>
<p>Connecting to Tor's control socket API requires one of two authentication methods to be configured. It also requires the control socket to be enabled, e.g. put <code>ControlPort 9051</code> in <code>torrc</code> config file. For cookie authentication the user running bitcoind must have read access to the <code>CookieAuthFile</code> specified in Tor configuration. In some cases this is preconfigured and the creation of an onion service is automatic. If permission problems are seen with <code>-debug=tor</code> they can be resolved by adding both the user running Tor and the user running bitcoind to the same group and setting permissions appropriately. On Debian-based systems the user running bitcoind can be added to the debian-tor group, which has the appropriate permissions. Before starting bitcoind you will need to re-login to allow debian-tor group to be applied. Otherwise you will see the following notice: "tor: Authentication cookie /run/tor/control.authcookie could not be opened (check permissions)" on debug.log.</p>
<p>An alternative authentication method is the use of the <code>-torpassword=password</code> option. The <code>password</code> is the clear text form that was used when generating the hashed password for the <code>HashedControlPassword</code> option in the tor configuration file. The hashed password can be obtained with the command <code>tor --hash-password password</code> (read the tor manual for more details).</p>
<h2 id="4-privacy-recommendations">4. Privacy recommendations</h2>
<ul>
<li>Do not add anything but Bitcoin Core ports to the onion service created in section 2. If you run a web service too, create a new onion service for that. Otherwise it is trivial to link them, which may reduce privacy. Hidden services created automatically (as in section 3) always have only one port open. Translations ============</li>
</ul>
<p>The Bitcoin-Core project has been designed to support multiple localisations. This makes adding new phrases, and completely new languages easily achievable. For managing all application translations, Bitcoin-Core makes use of the Transifex online translation management tool.</p>
<h3 id="helping-to-translate-using-transifex">Helping to translate (using Transifex)</h3>
<p>Transifex is setup to monitor the GitHub repo for updates, and when code containing new translations is found, Transifex will process any changes. It may take several hours after a pull-request has been merged, to appear in the Transifex web interface.</p>
<p>Multiple language support is critical in assisting Bitcoin’s global adoption, and growth. One of Bitcoin’s greatest strengths is cross-border money transfers, any help making that easier is greatly appreciated.</p>
<p>See the <a href="https://www.transifex.com/bitcoin/bitcoin/">Transifex Bitcoin project</a> to assist in translations. You should also join the translation mailing list for announcements - see details below.</p>
<h3 id="writing-code-with-translations">Writing code with translations</h3>
<p>We use automated scripts to help extract translations in both Qt, and non-Qt source files. It is rarely necessary to manually edit the files in <code>src/qt/locale/</code>. The translation source files must adhere to the following format: <code>bitcoin_xx_YY.ts or bitcoin_xx.ts</code></p>
<p><code>src/qt/locale/bitcoin_en.ts</code> is treated in a special way. It is used as the source for all other translations. Whenever a string in the source code is changed, this file must be updated to reflect those changes. A custom script is used to extract strings from the non-Qt parts. This script makes use of <code>gettext</code>, so make sure that utility is installed (ie, <code>apt-get install gettext</code> on Ubuntu/Debian). Once this has been updated, <code>lupdate</code> (included in the Qt SDK) is used to update <code>bitcoin_en.ts</code>.</p>
<p>To automatically regenerate the <code>bitcoin_en.ts</code> file, run the following commands:</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb169-1" title="1"><span class="bu">cd</span> src/</a>
<a class="sourceLine" id="cb169-2" title="2"><span class="fu">make</span> translate</a></code></pre></div>
<p><code>contrib/bitcoin-qt.pro</code> takes care of generating <code>.qm</code> (binary compiled) files from <code>.ts</code> (source files) files. It’s mostly automated, and you shouldn’t need to worry about it.</p>
<p><strong>Example Qt translation</strong></p>
<div class="sourceCode" id="cb170"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb170-1" title="1"><span class="ex">QToolBar</span> *toolbar = addToolBar(<span class="fu">tr</span>(<span class="st">&quot;Tabs toolbar&quot;</span>));</a></code></pre></div>
<h3 id="creating-a-pull-request">Creating a pull-request</h3>
<p>For general PRs, you shouldn’t include any updates to the translation source files. They will be updated periodically, primarily around pre-releases, allowing time for any new phrases to be translated before public releases. This is also important in avoiding translation related merge conflicts.</p>
<p>When an updated source file is merged into the GitHub repo, Transifex will automatically detect it (although it can take several hours). Once processed, the new strings will show up as "Remaining" in the Transifex web interface and are ready for translators.</p>
<p>To create the pull-request, use the following commands:</p>
<pre><code>git add src/qt/bitcoinstrings.cpp src/qt/locale/bitcoin_en.ts
git commit
</code></pre>
<h3 id="creating-a-transifex-account">Creating a Transifex account</h3>
<p>Visit the <a href="https://www.transifex.com/signup/">Transifex Signup</a> page to create an account. Take note of your username and password, as they will be required to configure the command-line tool.</p>
<p>You can find the Bitcoin translation project at <a href="https://www.transifex.com/bitcoin/bitcoin/">https://www.transifex.com/bitcoin/bitcoin/</a>.</p>
<h3 id="installing-the-transifex-client-command-line-tool">Installing the Transifex client command-line tool</h3>
<p>The client is used to fetch updated translations. If you are having problems, or need more details, see <a href="https://docs.transifex.com/client/installing-the-client">https://docs.transifex.com/client/installing-the-client</a></p>
<p><code>pip install transifex-client</code></p>
<p>Setup your Transifex client config as follows. Please <em>ignore the token field</em>.</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb172-1" title="1"><span class="dt">nano ~/.transifexrc</span></a>
<a class="sourceLine" id="cb172-2" title="2"></a>
<a class="sourceLine" id="cb172-3" title="3"><span class="kw">[https://www.transifex.com]</span></a>
<a class="sourceLine" id="cb172-4" title="4"><span class="dt">hostname </span><span class="ot">=</span><span class="st"> https://www.transifex.com</span></a>
<a class="sourceLine" id="cb172-5" title="5"><span class="dt">password </span><span class="ot">=</span><span class="st"> PASSWORD</span></a>
<a class="sourceLine" id="cb172-6" title="6"><span class="dt">token </span><span class="ot">=</span></a>
<a class="sourceLine" id="cb172-7" title="7"><span class="dt">username </span><span class="ot">=</span><span class="st"> USERNAME</span></a></code></pre></div>
<p>The Transifex Bitcoin project config file is included as part of the repo. It can be found at <code>.tx/config</code>, however you shouldn’t need to change anything.</p>
<h3 id="synchronising-translations">Synchronising translations</h3>
<p>To assist in updating translations, a helper script is available in the <a href="https://github.com/bitcoin-core/bitcoin-maintainer-tools">maintainer-tools repo</a>.</p>
<ol>
<li><code>python3 ../bitcoin-maintainer-tools/update-translations.py</code></li>
<li><code>git add</code> new translations from <code>src/qt/locale/</code></li>
<li>Update <code>src/qt/bitcoin_locale.qrc</code> manually or via</li>
</ol>
<div class="sourceCode" id="cb173"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb173-1" title="1"><span class="fu">git</span> ls-files src/qt/locale/*ts<span class="kw">|</span><span class="fu">xargs</span> -n1 basename<span class="kw">|</span><span class="fu">sed</span> <span class="st">&#39;s/\(bitcoin_\(.*\)\).ts/        &lt;file alias=&quot;\2&quot;&gt;locale\/\1.qm&lt;\/file&gt;/&#39;</span></a></code></pre></div>
<ol start="4">
<li>Update <code>src/Makefile.qt_locale.include</code> manually or via</li>
</ol>
<div class="sourceCode" id="cb174"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb174-1" title="1"><span class="fu">git</span> ls-files src/qt/locale/*ts<span class="kw">|</span><span class="fu">xargs</span> -n1 basename<span class="kw">|</span><span class="fu">sed</span> <span class="st">&#39;s/\(bitcoin_\(.*\)\).ts/  qt\/locale\/\1.ts \\/&#39;</span></a></code></pre></div>
<p><strong>Do not directly download translations</strong> one by one from the Transifex website, as we do a few post-processing steps before committing the translations.</p>
<h3 id="handling-plurals-in-source-files">Handling Plurals (in source files)</h3>
<p>When new plurals are added to the source file, it's important to do the following steps:</p>
<ol>
<li>Open <code>bitcoin_en.ts</code> in Qt Linguist (included in the Qt SDK)</li>
<li>Search for <code>%n</code>, which will take you to the parts in the translation that use plurals</li>
<li>Look for empty <code>English Translation (Singular)</code> and <code>English Translation (Plural)</code> fields</li>
<li>Add the appropriate strings for the singular and plural form of the base string</li>
<li>Mark the item as done (via the green arrow symbol in the toolbar)</li>
<li>Repeat from step 2, until all singular and plural forms are in the source file</li>
<li>Save the source file</li>
</ol>
<h3 id="translating-a-new-language">Translating a new language</h3>
<p>To create a new language template, you will need to edit the languages manifest file <code>src/qt/bitcoin_locale.qrc</code> and add a new entry. Below is an example of the English language entry.</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode xml"><code class="sourceCode xml"><a class="sourceLine" id="cb175-1" title="1"><span class="kw">&lt;qresource</span><span class="ot"> prefix=</span><span class="st">&quot;/translations&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb175-2" title="2">    <span class="kw">&lt;file</span><span class="ot"> alias=</span><span class="st">&quot;en&quot;</span><span class="kw">&gt;</span>locale/bitcoin_en.qm<span class="kw">&lt;/file&gt;</span></a>
<a class="sourceLine" id="cb175-3" title="3">    ...</a>
<a class="sourceLine" id="cb175-4" title="4"><span class="kw">&lt;/qresource&gt;</span></a></code></pre></div>
<p><strong>Note:</strong> that the language translation file <strong>must end in <code>.qm</code></strong> (the compiled extension), and not <code>.ts</code>.</p>
<h3 id="questions-and-general-assistance">Questions and general assistance</h3>
<p>The Bitcoin-Core translation maintainers include <em>tcatm, seone, Diapolo, wumpus and luke-jr</em>. You can find them, and others, in the Freenode IRC chatroom - <code>irc.freenode.net #bitcoin-core-dev</code>.</p>
<h1 id="if-you-are-a-translator-you-should-also-subscribe-to-the-mailing-list-httpsgroupsgooglecomforumforumbitcoin-translators-announcements-will-be-posted-during-application-pre-releases-to-notify-translators-to-check-for-updates-translation-strings-policy">If you are a translator, you should also subscribe to the mailing list, <a href="https://groups.google.com/forum/#!forum/bitcoin-translators">https://groups.google.com/forum/#!forum/bitcoin-translators</a>. Announcements will be posted during application pre-releases to notify translators to check for updates. Translation Strings Policy</h1>
<p>This document provides guidelines for internationalization of the Bitcoin Core software.</p>
<h2 id="how-to-translate">How to translate?</h2>
<p>To mark a message as translatable</p>
<ul>
<li><p>In GUI source code (under <code>src/qt</code>): use <code>tr("...")</code></p></li>
<li><p>In non-GUI source code (under <code>src</code>): use <code>_("...")</code></p></li>
</ul>
<p>No internationalization is used for e.g. developer scripts outside <code>src</code>.</p>
<h2 id="strings-to-be-translated">Strings to be translated</h2>
<p>On a high level, these strings are to be translated:</p>
<ul>
<li>GUI strings, anything that appears in a dialog or window</li>
</ul>
<h3 id="gui-strings">GUI strings</h3>
<p>Do not translate technical or extremely rare errors. Anything else that appears to the user in the GUI is to be translated. This includes labels, menu items, button texts, tooltips and window titles. This includes messages passed to the GUI through the UI interface through <code>InitMessage</code>, <code>ThreadSafeMessageBox</code> or <code>ShowProgress</code>.</p>
<h2 id="general-recommendations">General recommendations</h2>
<h3 id="avoid-unnecessary-translation-strings">Avoid unnecessary translation strings</h3>
<p>Try not to burden translators with translating messages that are e.g. slight variations of other messages. In the GUI, avoid the use of text where an icon or symbol will do. Make sure that placeholder texts in forms do not end up in the list of strings to be translated (use <code>&lt;string notr="true"&gt;</code>).</p>
<h3 id="make-translated-strings-understandable">Make translated strings understandable</h3>
<p>Try to write translation strings in an understandable way, for both the user and the translator. Avoid overly technical or detailed messages.</p>
<h3 id="do-not-translate-internal-errors">Do not translate internal errors</h3>
<p>Do not translate internal errors, log messages, or messages that appear on the RPC interface. If an error is to be shown to the user, use a translatable generic message, then log the detailed message to the log. E.g., "A fatal internal error occurred, see debug.log for details". This helps troubleshooting; if the error is the same for everyone, the likelihood is increased that it can be found using a search engine.</p>
<h3 id="avoid-fragments">Avoid fragments</h3>
<p>Avoid dividing up a message into fragments. Translators see every string separately, so they may misunderstand the context if the messages are not self-contained.</p>
<h3 id="avoid-html-in-translation-strings">Avoid HTML in translation strings</h3>
<p>There have been difficulties with the use of HTML in translation strings; translators should not be able to accidentally affect the formatting of messages. This may sometimes be at conflict with the recommendation in the previous section.</p>
<h3 id="plurals">Plurals</h3>
<p>Plurals can be complex in some languages. A quote from the gettext documentation:</p>
<pre><code>In Polish we use e.g. plik (file) this way:
1 plik,
2,3,4 pliki,
5-21 pliko&#39;w,
22-24 pliki,
25-31 pliko&#39;w
and so on
</code></pre>
<p>In Qt code, use tr's third argument for optional plurality. For example:</p>
<pre><code>tr(&quot;%n hour(s)&quot;,&quot;&quot;,secs/HOUR_IN_SECONDS);
tr(&quot;%n day(s)&quot;,&quot;&quot;,secs/DAY_IN_SECONDS);
tr(&quot;%n week(s)&quot;,&quot;&quot;,secs/WEEK_IN_SECONDS);
</code></pre>
<p>This adds <code>&lt;numerusform&gt;</code>s to the respective <code>.ts</code> file, which can be translated separately depending on the language. In English, this is simply:</p>
<pre><code>&lt;message numerus=&quot;yes&quot;&gt;
    &lt;source&gt;%n active connection(s) to Bitcoin network&lt;/source&gt;
    &lt;translation&gt;
        &lt;numerusform&gt;%n active connection to Bitcoin network&lt;/numerusform&gt;
        &lt;numerusform&gt;%n active connections to Bitcoin network&lt;/numerusform&gt;
    &lt;/translation&gt;
&lt;/message&gt;
</code></pre>
<p>Where possible, try to avoid embedding numbers into the flow of the string at all. E.g.,</p>
<pre><code>WARNING: check your network connection, %d blocks received in the last %d hours (%d expected)
</code></pre>
<p>versus</p>
<pre><code>WARNING: check your network connection, less blocks (%d) were received in the last %n hours than expected (%d).
</code></pre>
<p>The second example reduces the number of pluralized words that translators have to handle from three to one, at no cost to comprehensibility of the sentence.</p>
<h3 id="string-freezes">String freezes</h3>
<p>During a string freeze (often before a major release), no translation strings are to be added, modified or removed.</p>
<p>This can be checked by executing <code>make translate</code> in the <code>src</code> directory, then verifying that <code>bitcoin_en.ts</code> remains unchanged.</p>
<h1 id="block-and-transaction-broadcasting-with-zeromq">Block and Transaction Broadcasting with ZeroMQ</h1>
<p><a href="https://zeromq.org/">ZeroMQ</a> is a lightweight wrapper around TCP connections, inter-process communication, and shared-memory, providing various message-oriented semantics such as publish/subscribe, request/reply, and push/pull.</p>
<p>The Bitcoin Core daemon can be configured to act as a trusted "border router", implementing the bitcoin wire protocol and relay, making consensus decisions, maintaining the local blockchain database, broadcasting locally generated transactions into the network, and providing a queryable RPC interface to interact on a polled basis for requesting blockchain related data. However, there exists only a limited service to notify external software of events like the arrival of new blocks or transactions.</p>
<p>The ZeroMQ facility implements a notification interface through a set of specific notifiers. Currently there are notifiers that publish blocks and transactions. This read-only facility requires only the connection of a corresponding ZeroMQ subscriber port in receiving software; it is not authenticated nor is there any two-way protocol involvement. Therefore, subscribers should validate the received data since it may be out of date, incomplete or even invalid.</p>
<p>ZeroMQ sockets are self-connecting and self-healing; that is, connections made between two endpoints will be automatically restored after an outage, and either end may be freely started or stopped in any order.</p>
<p>Because ZeroMQ is message oriented, subscribers receive transactions and blocks all-at-once and do not need to implement any sort of buffering or reassembly.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>The ZeroMQ feature in Bitcoin Core requires the ZeroMQ API &gt;= 4.0.0 <a href="https://github.com/zeromq/libzmq/releases">libzmq</a>. For version information, see <a href="dependencies.html">dependencies.html</a>. Typically, it is packaged by distributions as something like <em>libzmq3-dev</em>. The C++ wrapper for ZeroMQ is <em>not</em> needed.</p>
<p>In order to run the example Python client scripts in the <code>contrib/zmq/</code> directory, one must also install <a href="https://github.com/zeromq/pyzmq">PyZMQ</a> (generally with <code>pip install pyzmq</code>), though this is not necessary for daemon operation.</p>
<h2 id="enabling">Enabling</h2>
<p>By default, the ZeroMQ feature is automatically compiled in if the necessary prerequisites are found. To disable, use --disable-zmq during the <em>configure</em> step of building bitcoind:</p>
<pre><code>$ ./configure --disable-zmq (other options)
</code></pre>
<p>To actually enable operation, one must set the appropriate options on the command line or in the configuration file.</p>
<h2 id="usage">Usage</h2>
<p>Currently, the following notifications are supported:</p>
<pre><code>-zmqpubhashtx=address
-zmqpubhashblock=address
-zmqpubrawblock=address
-zmqpubrawtx=address
-zmqpubsequence=address
</code></pre>
<p>The socket type is PUB and the address must be a valid ZeroMQ socket address. The same address can be used in more than one notification. The same notification can be specified more than once.</p>
<p>The option to set the PUB socket's outbound message high water mark (SNDHWM) may be set individually for each notification:</p>
<pre><code>-zmqpubhashtxhwm=n
-zmqpubhashblockhwm=n
-zmqpubrawblockhwm=n
-zmqpubrawtxhwm=n
-zmqpubsequencehwm=address
</code></pre>
<p>The high water mark value must be an integer greater than or equal to 0.</p>
<p>For instance:</p>
<pre><code>$ bitcoind -zmqpubhashtx=tcp://127.0.0.1:28332 \
           -zmqpubhashtx=tcp://192.168.1.2:28332 \
           -zmqpubrawtx=ipc:///tmp/bitcoind.tx.raw \
           -zmqpubhashtxhwm=10000
</code></pre>
<p>Each PUB notification has a topic and body, where the header corresponds to the notification type. For instance, for the notification <code>-zmqpubhashtx</code> the topic is <code>hashtx</code> (no null terminator) and the body is the transaction hash (32 bytes) for all but <code>sequence</code> topic. For <code>sequence</code>, the body is structured as the following based on the type of message:</p>
<pre><code>&lt;32-byte hash&gt;C :                 Blockhash connected
&lt;32-byte hash&gt;D :                 Blockhash disconnected
&lt;32-byte hash&gt;R&lt;8-byte LE uint&gt; : Transactionhash removed from mempool for non-block inclusion reason
&lt;32-byte hash&gt;A&lt;8-byte LE uint&gt; : Transactionhash added mempool
</code></pre>
<p>Where the 8-byte uints correspond to the mempool sequence number.</p>
<p>These options can also be provided in bitcoin.conf.</p>
<p>ZeroMQ endpoint specifiers for TCP (and others) are documented in the <a href="http://api.zeromq.org/4-0:_start">ZeroMQ API</a>.</p>
<p>Client side, then, the ZeroMQ subscriber socket must have the ZMQ_SUBSCRIBE option set to one or either of these prefixes (for instance, just <code>hash</code>); without doing so will result in no messages arriving. Please see <a href="/contrib/zmq/zmq_sub.py"><code>contrib/zmq/zmq_sub.py</code></a> for a working example.</p>
<p>The ZMQ_PUB socket's ZMQ_TCP_KEEPALIVE option is enabled. This means that the underlying SO_KEEPALIVE option is enabled when using a TCP transport. The effective TCP keepalive values are managed through the underlying operating system configuration and must be configured prior to connection establishment.</p>
<p>For example, when running on GNU/Linux, one might use the following to lower the keepalive setting to 10 minutes:</p>
<p>sudo sysctl -w net.ipv4.tcp_keepalive_time=600</p>
<p>Setting the keepalive values appropriately for your operating environment may improve connectivity in situations where long-lived connections are silently dropped by network middle boxes.</p>
<h2 id="remarks">Remarks</h2>
<p>From the perspective of bitcoind, the ZeroMQ socket is write-only; PUB sockets don't even have a read function. Thus, there is no state introduced into bitcoind directly. Furthermore, no information is broadcast that wasn't already received from the public P2P network.</p>
<p>No authentication or authorization is done on connecting clients; it is assumed that the ZeroMQ port is exposed only to trusted entities, using other means such as firewalling.</p>
<p>Note that for <code>*block</code> topics, when the block chain tip changes, a reorganisation may occur and just the tip will be notified. It is up to the subscriber to retrieve the chain from the last known block to the new tip. Also note that no notification will occur if the tip was in the active chain--as would be the case after calling invalidateblock RPC. In contrast, the <code>sequence</code> topic publishes all block connections and disconnections.</p>
<p>There are several possibilities that ZMQ notification can get lost during transmission depending on the communication type you are using. Bitcoind appends an up-counting sequence number to each notification which allows listeners to detect lost notifications.</p>
<p>The <code>sequence</code> topic refers specifically to the mempool sequence number, which is also published along with all mempool events. This is a different sequence value than in ZMQ itself in order to allow a total ordering of mempool events to be constructed.</p>
</body>
</html>
